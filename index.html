<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>è¡Œç¨‹æ—¥æ›†åŠ©æ‰‹ Mobile v3.2.3</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.3);
            --purple: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.3);
            --emerald: #10b981;
            --emerald-glow: rgba(16, 185, 129, 0.3);
            --orange: #f59e0b;
            --red: #ef4444;
            --gold: #fbbf24;
            --text-light: #e2e8f0;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-light); line-height: 1.5; -webkit-font-smoothing: antialiased; }
        .app-container { height: 100%; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top, 0px); padding-bottom: env(safe-area-inset-bottom, 0px); }
        .app-header { height: var(--header-height); background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .app-logo { display: flex; align-items: center; gap: 10px; font-size: 1.2em; font-weight: 700; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.2); border-radius: 12px; color: white; font-size: 1.3em; display: flex; align-items: center; justify-content: center; }
        .app-content { flex: 1; overflow: hidden; position: relative; }
        .page { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; padding: 16px; padding-bottom: calc(var(--nav-height) + 20px); display: none; -webkit-overflow-scrolling: touch; }
        .page.active { display: block; }
        .bottom-nav { height: var(--nav-height); background: var(--bg-card); border-top: 1px solid var(--border); display: flex; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; border: none; background: transparent; color: var(--text-muted); padding: 8px 0; position: relative; }
        .nav-item::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; background: var(--cyan); border-radius: 0 0 3px 3px; transition: width 0.3s; }
        .nav-item.active { color: var(--cyan); }
        .nav-item.active::before { width: 30px; }
        .nav-icon { font-size: 1.5em; }
        .nav-label { font-size: 0.75em; font-weight: 500; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4em; }
        .card-icon.cyan { background: var(--cyan-glow); }
        .card-icon.purple { background: var(--purple-glow); }
        .card-icon.emerald { background: var(--emerald-glow); }
        .card-title { font-size: 1.1em; font-weight: 600; }
        .card-subtitle { font-size: 0.85em; color: var(--text-dim); }
        .stats-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--bg-card); border-radius: 14px; padding: 16px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.8em; font-weight: 700; color: var(--cyan); }
        .stat-label { font-size: 0.8em; color: var(--text-muted); }
        .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .quick-action { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 16px; text-align: center; transition: all 0.2s; }
        .quick-action:active { transform: scale(0.98); background: var(--bg-card-hover); }
        .quick-action-icon { font-size: 2em; margin-bottom: 8px; }
        .quick-action-text { font-size: 0.9em; font-weight: 500; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.9em; font-weight: 500; color: var(--text-dim); margin-bottom: 8px; }
        .input-field { width: 100%; padding: 14px 16px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px; color: var(--text-light); font-size: 1em; -webkit-appearance: none; }
        .input-field:focus { outline: none; border-color: var(--cyan); }
        .input-field::placeholder { color: var(--text-muted); }
        textarea.input-field { min-height: 150px; resize: vertical; line-height: 1.6; }
        .input-row { display: flex; gap: 8px; }
        .input-row .input-field { flex: 1; }
        .input-btn { width: 50px; height: 50px; border: none; background: var(--bg-card-hover); border-radius: 12px; color: var(--text-dim); font-size: 1.2em; flex-shrink: 0; }
        .btn { width: 100%; padding: 16px 24px; border: none; border-radius: 14px; font-size: 1.05em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--cyan); color: var(--cyan); }
        .btn-danger { background: var(--red); color: white; }
        .btn.authorized { background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%); color: white; cursor: default; }
        .btn.disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 12px 16px; font-size: 0.95em; }
        .action-row { display: flex; gap: 12px; margin-top: 16px; }
        .action-row .btn { flex: 1; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; background: var(--bg-dark); padding: 6px; border-radius: 12px; }
        .tab { flex: 1; padding: 12px 8px; border: none; background: transparent; color: var(--text-muted); font-size: 0.9em; font-weight: 500; border-radius: 8px; }
        .tab.active { background: var(--cyan); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .upload-area { border: 2px dashed var(--border); border-radius: 16px; padding: 30px 20px; text-align: center; background: rgba(6, 182, 212, 0.05); }
        .upload-area:active { border-color: var(--cyan); background: rgba(6, 182, 212, 0.1); }
        .upload-area input { display: none; }
        .upload-icon { font-size: 3em; margin-bottom: 12px; }
        .upload-text { font-size: 1em; font-weight: 500; color: var(--cyan); }
        .upload-hint { font-size: 0.85em; color: var(--text-muted); margin-top: 8px; }
        .reminder-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .reminder-option { display: flex; align-items: center; gap: 10px; padding: 14px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px; }
        .reminder-option.checked { border-color: var(--cyan); background: var(--cyan-glow); }
        .reminder-option input { display: none; }
        .reminder-checkbox { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: transparent; }
        .reminder-option.checked .reminder-checkbox { background: var(--cyan); border-color: var(--cyan); color: white; }
        .reminder-label { font-size: 0.95em; }
        .event-list { margin-top: 20px; }
        .event-item { background: var(--bg-dark); border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--cyan); }
        .event-title { font-size: 1.05em; font-weight: 600; margin-bottom: 8px; }
        .event-meta { font-size: 0.9em; color: var(--text-dim); }
        .event-meta-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .day-badge { display: inline-block; background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); color: white; padding: 2px 10px; border-radius: 6px; font-size: 0.8em; margin-left: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-icon { font-size: 3em; margin-bottom: 12px; opacity: 0.5; }
        .toast { position: fixed; bottom: calc(var(--nav-height) + 20px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); color: var(--text-light); padding: 14px 24px; border-radius: 12px; font-size: 0.95em; font-weight: 500; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); z-index: 1000; opacity: 0; transition: all 0.3s ease; max-width: calc(100% - 40px); text-align: center; border: 1px solid var(--border); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--emerald); background: rgba(16, 185, 129, 0.2); }
        .toast.error { border-color: var(--red); background: rgba(239, 68, 68, 0.2); }
        .toast.info { border-color: var(--cyan); background: rgba(6, 182, 212, 0.2); }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--bg-card); width: 100%; max-height: 85vh; border-radius: 24px 24px 0 0; overflow: hidden; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-dark); color: var(--text-dim); border-radius: 10px; font-size: 1.2em; }
        .modal-body { padding: 20px; max-height: calc(85vh - 80px); overflow-y: auto; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-title { font-weight: 500; }
        .toggle-desc { font-size: 0.85em; color: var(--text-muted); }
        .toggle-switch { width: 52px; height: 30px; background: var(--border); border-radius: 15px; position: relative; transition: all 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: all 0.3s; }
        .toggle-switch.active { background: var(--cyan); }
        .toggle-switch.active::after { left: 25px; }
        .image-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 12px; margin-top: 12px; display: none; }
        .image-preview.show { display: block; }
        .file-badge { display: inline-flex; align-items: center; gap: 8px; background: var(--emerald-glow); border: 1px solid var(--emerald); color: var(--emerald); padding: 8px 14px; border-radius: 10px; font-size: 0.9em; margin-top: 12px; }
        .accordion-item { background: var(--bg-dark); border-radius: 12px; margin-bottom: 10px; overflow: hidden; }
        .accordion-header { width: 100%; padding: 16px; border: none; background: transparent; color: var(--text-light); font-size: 1em; font-weight: 500; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .accordion-body { display: none; padding: 0 16px 16px; color: var(--text-dim); font-size: 0.9em; line-height: 1.7; }
        .accordion-item.open .accordion-body { display: block; }
        .accordion-icon { transition: transform 0.3s; }
        .accordion-item.open .accordion-icon { transform: rotate(180deg); }
        .splash-screen { position: fixed; inset: 0; background: radial-gradient(ellipse at center, #0a1628 0%, #050d1a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 99999; overflow: hidden; transition: opacity 0.8s ease, visibility 0.8s ease; }
        .splash-screen.hide { opacity: 0; visibility: hidden; }
        .splash-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(6, 182, 212, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.03) 1px, transparent 1px); background-size: 30px 30px; animation: gridPulse 3s ease-in-out infinite; }
        @keyframes gridPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.7; } }
        .hex-bg { position: absolute; width: 100%; height: 100%; opacity: 0.1; background: radial-gradient(circle at 20% 30%, var(--cyan) 0%, transparent 40%), radial-gradient(circle at 80% 70%, var(--purple) 0%, transparent 40%); animation: hexFloat 8s ease-in-out infinite; }
        @keyframes hexFloat { 0%, 100% { transform: scale(1) rotate(0deg); } 50% { transform: scale(1.1) rotate(5deg); } }
        .splash-particles { position: absolute; inset: 0; overflow: hidden; }
        .splash-particle { position: absolute; width: 3px; height: 3px; background: var(--cyan); border-radius: 50%; box-shadow: 0 0 10px var(--cyan), 0 0 20px var(--cyan); animation: particleRise 5s ease-in-out infinite; }
        .splash-particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .splash-particle:nth-child(2) { left: 20%; animation-delay: 0.8s; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .splash-particle:nth-child(3) { left: 30%; animation-delay: 1.6s; }
        .splash-particle:nth-child(4) { left: 40%; animation-delay: 0.4s; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }
        .splash-particle:nth-child(5) { left: 50%; animation-delay: 1.2s; }
        .splash-particle:nth-child(6) { left: 60%; animation-delay: 2s; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .splash-particle:nth-child(7) { left: 70%; animation-delay: 0.6s; }
        .splash-particle:nth-child(8) { left: 80%; animation-delay: 1.4s; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }
        .splash-particle:nth-child(9) { left: 90%; animation-delay: 2.2s; }
        @keyframes particleRise { 0% { transform: translateY(100vh) scale(0); opacity: 0; } 10% { opacity: 1; transform: scale(1); } 90% { opacity: 1; } 100% { transform: translateY(-100vh) scale(0.5); opacity: 0; } }
        .splash-logo-container { position: relative; width: 160px; height: 160px; display: flex; align-items: center; justify-content: center; margin-bottom: 30px; }
        .splash-ring { position: absolute; border: 2px solid transparent; border-radius: 50%; animation: ringRotate linear infinite; }
        .splash-ring-1 { width: 160px; height: 160px; border-top-color: var(--cyan); border-right-color: var(--cyan); animation-duration: 3s; filter: drop-shadow(0 0 8px var(--cyan)); }
        .splash-ring-2 { width: 130px; height: 130px; border-bottom-color: var(--purple); border-left-color: var(--purple); animation-duration: 2.5s; animation-direction: reverse; filter: drop-shadow(0 0 8px var(--purple)); }
        .splash-ring-3 { width: 100px; height: 100px; border-top-color: var(--emerald); animation-duration: 2s; filter: drop-shadow(0 0 8px var(--emerald)); }
        @keyframes ringRotate { to { transform: rotate(360deg); } }
        .splash-logo-inner { width: 70px; height: 70px; background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%); border: 2px solid var(--cyan); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 36px; animation: logoSpin 2s ease-in-out, logoPulse 2s ease-in-out infinite 2s; box-shadow: 0 0 30px rgba(6, 182, 212, 0.5), inset 0 0 20px rgba(6, 182, 212, 0.1); z-index: 10; }
        @keyframes logoSpin { 0% { transform: rotateY(0deg) scale(0.3); opacity: 0; } 50% { transform: rotateY(180deg) scale(1.1); } 100% { transform: rotateY(360deg) scale(1); opacity: 1; } }
        @keyframes logoPulse { 0%, 100% { box-shadow: 0 0 30px rgba(6, 182, 212, 0.5), inset 0 0 20px rgba(6, 182, 212, 0.1); border-color: var(--cyan); } 50% { box-shadow: 0 0 50px rgba(6, 182, 212, 0.8), 0 0 80px rgba(168, 85, 247, 0.4), inset 0 0 30px rgba(6, 182, 212, 0.2); border-color: var(--purple); } }
        .orbit-particle { position: absolute; width: 6px; height: 6px; background: var(--cyan); border-radius: 50%; box-shadow: 0 0 10px var(--cyan); }
        .orbit-particle:nth-child(1) { animation: orbit1 3s linear infinite; }
        .orbit-particle:nth-child(2) { animation: orbit2 2.5s linear infinite; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .orbit-particle:nth-child(3) { animation: orbit3 2s linear infinite; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }
        @keyframes orbit1 { 0% { transform: rotate(0deg) translateX(80px) rotate(0deg); } 100% { transform: rotate(360deg) translateX(80px) rotate(-360deg); } }
        @keyframes orbit2 { 0% { transform: rotate(120deg) translateX(65px) rotate(-120deg); } 100% { transform: rotate(480deg) translateX(65px) rotate(-480deg); } }
        @keyframes orbit3 { 0% { transform: rotate(240deg) translateX(50px) rotate(-240deg); } 100% { transform: rotate(600deg) translateX(50px) rotate(-600deg); } }
        .splash-title { font-size: 22px; font-weight: 700; color: var(--cyan); text-shadow: 0 0 20px rgba(6, 182, 212, 0.8); opacity: 0; animation: textFadeUp 0.8s ease forwards 1s; text-align: center; letter-spacing: 2px; }
        .splash-subtitle { font-size: 12px; color: var(--text-muted); margin-top: 8px; opacity: 0; animation: textFadeUp 0.8s ease forwards 1.3s; letter-spacing: 4px; }
        .splash-version { font-size: 10px; color: var(--purple); margin-top: 6px; opacity: 0; animation: textFadeUp 0.8s ease forwards 1.5s; }
        @keyframes textFadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .splash-progress { width: 180px; height: 3px; background: rgba(6, 182, 212, 0.1); border-radius: 2px; margin-top: 35px; overflow: hidden; opacity: 0; animation: textFadeUp 0.8s ease forwards 1.7s; border: 1px solid rgba(6, 182, 212, 0.2); }
        .splash-progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--cyan), var(--purple), var(--emerald)); border-radius: 2px; animation: progressFill 2s ease forwards 1.9s; box-shadow: 0 0 10px var(--cyan); }
        @keyframes progressFill { 0% { width: 0%; } 100% { width: 100%; } }
        .splash-status { font-size: 11px; color: var(--text-dim); margin-top: 15px; opacity: 0; animation: textFadeUp 0.8s ease forwards 2s, statusBlink 1s ease-in-out infinite 2s; }
        @keyframes statusBlink { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .scan-line { position: absolute; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--cyan), transparent); top: 0; animation: scanMove 3s linear infinite; opacity: 0.3; }
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }
    </style>
</head>
<body>
    <!-- ğŸŒŸ å†·å…‰ç§‘æŠ€é¢¨é–‹æ©Ÿå‹•ç•« -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-grid"></div>
        <div class="hex-bg"></div>
        <div class="scan-line"></div>
        <div class="splash-particles">
            <div class="splash-particle"></div><div class="splash-particle"></div><div class="splash-particle"></div>
            <div class="splash-particle"></div><div class="splash-particle"></div><div class="splash-particle"></div>
            <div class="splash-particle"></div><div class="splash-particle"></div><div class="splash-particle"></div>
        </div>
        <div class="splash-logo-container">
            <div class="splash-ring splash-ring-1"></div>
            <div class="splash-ring splash-ring-2"></div>
            <div class="splash-ring splash-ring-3"></div>
            <div class="splash-logo-inner">ğŸ“…</div>
            <div class="orbit-particle"></div>
            <div class="orbit-particle"></div>
            <div class="orbit-particle"></div>
        </div>
        <div class="splash-title">è¡Œç¨‹æ—¥æ›†åŠ©æ‰‹</div>
        <div class="splash-subtitle">SCHEDULE CALENDAR</div>
        <div class="splash-version">Mobile v3.2.3</div>
        <div class="splash-progress"><div class="splash-progress-bar"></div></div>
        <div class="splash-status">INITIALIZING SYSTEM...</div>
    </div>
    <div class="app-container">
        <header class="app-header">
            <div class="app-logo"><span>ğŸ“…</span><span>è¡Œç¨‹åŠ©æ‰‹</span></div>
            <div class="header-actions">
                <button class="header-btn" id="helpBtn">â“</button>
                <button class="header-btn" id="settingsBtn">âš™ï¸</button>
            </div>
        </header>
        <main class="app-content">
            <!-- é¦–é  -->
            <div class="page active" id="page-home">
                <div class="stats-row">
                    <div class="stat-card"><div class="stat-value" id="eventCount">0</div><div class="stat-label">å¾…åŒ¯å…¥äº‹ä»¶</div></div>
                    <div class="stat-card"><div class="stat-value" id="fileCount">0</div><div class="stat-label">å·²ä¸Šå‚³æª”æ¡ˆ</div></div>
                </div>
                <div class="quick-actions">
                    <div class="quick-action" id="qa-text"><div class="quick-action-icon">âœï¸</div><div class="quick-action-text">æ–‡å­—è¼¸å…¥</div></div>
                    <div class="quick-action" id="qa-file"><div class="quick-action-icon">ğŸ“„</div><div class="quick-action-text">ä¸Šå‚³æª”æ¡ˆ</div></div>
                    <div class="quick-action" id="qa-image"><div class="quick-action-icon">ğŸ“¸</div><div class="quick-action-text">æ‹ç…§è¾¨è­˜</div></div>
                    <div class="quick-action" id="qa-api"><div class="quick-action-icon">ğŸ”‘</div><div class="quick-action-text">API è¨­å®š</div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon cyan">ğŸ“‹</div><div><div class="card-title">å¾…è™•ç†äº‹ä»¶</div><div class="card-subtitle">è§£æå®Œæˆå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div></div></div>
                    <div id="homeEventList"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div></div>
                </div>
            </div>
            <!-- è¼¸å…¥é  -->
            <div class="page" id="page-input">
                <div class="card">
                    <div class="card-header"><div class="card-icon purple">ğŸ“</div><div><div class="card-title">è¼¸å…¥æ´»å‹•è³‡è¨Š</div><div class="card-subtitle">é¸æ“‡è¼¸å…¥æ–¹å¼</div></div></div>
                    <div class="tabs">
                        <button class="tab active" id="tab-text">âœï¸ æ–‡å­—</button>
                        <button class="tab" id="tab-file">ğŸ“„ æª”æ¡ˆ</button>
                        <button class="tab" id="tab-image">ğŸ“¸ åœ–ç‰‡</button>
                    </div>
                    <div class="tab-content active" id="content-text">
                        <div class="input-group">
                            <label class="input-label">è²¼ä¸Šæ´»å‹•æ™‚ç¨‹è¡¨ <span style="color: var(--cyan); font-size: 0.85em;">ï¼ˆæ”¯æ´ç ”ç¿’/ç•¢æ—…/æ´»å‹•ï¼‰</span></label>
                            <textarea class="input-field" id="scheduleText" placeholder="ç¯„ä¾‹ 1 - ç ”ç¿’ï¼š
114å¹´12æœˆ25æ—¥ï¼ˆä¸‰ï¼‰14:00-16:00
AI æ•™å­¸æ‡‰ç”¨å·¥ä½œåŠ
åœ°é»ï¼šç·šä¸Š Google Meet

ç¯„ä¾‹ 2 - ç•¢æ¥­æ—…è¡Œï¼š
ç¬¬ä¸€å¤© 12/20ï¼ˆäº”ï¼‰
07:30 å­¸æ ¡é›†åˆå‡ºç™¼
12:00 æŠµé”ä¹æ—æ–‡åŒ–æ‘

ğŸ’¡ æ”¯æ´ï¼šç ”ç¿’ã€ç•¢æ—…ã€æ ¡å¤–æ•™å­¸ã€æ´»å‹•è¡Œç¨‹"></textarea>
                            <button class="btn btn-outline btn-sm" onclick="clearScheduleText()" style="margin-top: 10px;">ğŸ—‘ï¸ æ¸…é™¤æ–‡å­—</button>
                        </div>
                    </div>
                    <div class="tab-content" id="content-file">
                        <div class="upload-area" id="fileUploadArea">
                            <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.txt,.pdf">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">é»æ“Šä¸Šå‚³æª”æ¡ˆ</div>
                            <div class="upload-hint">æ”¯æ´ Excelã€TXTã€CSVã€PDF</div>
                        </div>
                        <div id="fileInfo" style="display: none;"><div class="file-badge"><span>âœ…</span><span id="fileName">æª”æ¡ˆå·²è¼‰å…¥</span></div></div>
                    </div>
                    <div class="tab-content" id="content-image">
                        <div class="upload-area" id="imageUploadArea">
                            <input type="file" id="imageUpload" accept="image/*">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">æ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡</div>
                            <div class="upload-hint">AI OCR æ™ºèƒ½è¾¨è­˜è¡Œç¨‹è¡¨</div>
                        </div>
                        <div class="ocr-tips" style="margin-top: 12px; padding: 12px; background: rgba(6, 182, 212, 0.1); border-radius: 12px; font-size: 0.85em; color: var(--text-dim);">
                            <div style="margin-bottom: 6px; color: var(--cyan);">ğŸ“¸ OCR è¾¨è­˜æ”¯æ´ï¼š</div>
                            <div>â€¢ ç ”ç¿’é€šçŸ¥ã€å…¬æ–‡</div><div>â€¢ ç•¢æ¥­æ—…è¡Œè¡Œç¨‹è¡¨</div><div>â€¢ æ ¡å¤–æ•™å­¸é€šçŸ¥å–®</div><div>â€¢ å„ç¨®æ´»å‹•æ™‚ç¨‹è¡¨</div>
                        </div>
                        <img id="imagePreview" class="image-preview">
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon emerald">â°</div><div><div class="card-title">æé†’è¨­å®š</div><div class="card-subtitle">é¸æ“‡äº‹ä»¶æé†’æ™‚é–“</div></div></div>
                    <div class="reminder-grid" id="reminderGrid">
                        <label class="reminder-option" data-value="30"><input type="checkbox" value="30"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">30 åˆ†é˜å‰</span></label>
                        <label class="reminder-option checked" data-value="60"><input type="checkbox" value="60" checked><div class="reminder-checkbox">âœ“</div><span class="reminder-label">1 å°æ™‚å‰</span></label>
                        <label class="reminder-option" data-value="120"><input type="checkbox" value="120"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">2 å°æ™‚å‰</span></label>
                        <label class="reminder-option" data-value="1440"><input type="checkbox" value="1440"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">1 å¤©å‰</span></label>
                    </div>
                </div>
                <button class="btn btn-primary" id="parseBtn"><span id="parseBtnText">ğŸš€ AI æ™ºèƒ½è§£æ</span><div class="spinner" id="parseSpinner"></div></button>
                <div id="eventsPreview" class="event-list" style="display: none;"></div>
                <div class="action-row" id="importActions" style="display: none;">
                    <button class="btn btn-secondary" id="importCalendarBtn">ğŸ”— åŒ¯å…¥æ—¥æ›†</button>
                    <button class="btn btn-outline" id="downloadIcsBtn">ğŸ“¥ ä¸‹è¼‰ ICS</button>
                </div>
            </div>
            <!-- LINE é  -->
            <div class="page" id="page-line">
                <div class="card">
                    <div class="card-header"><div class="card-icon emerald">ğŸ””</div><div><div class="card-title">LINE æé†’æ’ç¨‹</div><div class="card-subtitle">ç ”ç¿’è‡ªå‹•æé†’è¨­å®š</div></div></div>
                    <div class="reminder-grid" id="lineReminderGrid">
                        <label class="reminder-option" data-value="1440"><input type="checkbox" id="reminder1Day" value="1440"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 1 å¤©</span></label>
                        <label class="reminder-option" data-value="120"><input type="checkbox" id="reminder2Hours" value="120"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 2 å°æ™‚</span></label>
                        <label class="reminder-option checked" data-value="60"><input type="checkbox" id="reminder1Hour" value="60" checked><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 1 å°æ™‚</span></label>
                        <label class="reminder-option" data-value="30"><input type="checkbox" id="reminder30Min" value="30"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 30 åˆ†é˜</span></label>
                    </div>
                    <div class="action-row">
                        <button class="btn btn-outline btn-sm" id="viewSchedulesBtn">ğŸ“‹ æŸ¥çœ‹æ’ç¨‹</button>
                        <button class="btn btn-danger btn-sm" id="clearSchedulesBtn">ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon cyan">ğŸ“Š</div><div><div class="card-title">è¨­å®šç‹€æ…‹</div><div class="card-subtitle">LINE é€šçŸ¥è¨­å®šæª¢æŸ¥</div></div></div>
                    <div id="lineStatusList">
                        <div class="toggle-row"><div><div class="toggle-title">Channel Token</div><div class="toggle-desc" id="tokenStatus">æœªè¨­å®š</div></div><span id="tokenIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">User ID</div><div class="toggle-desc" id="userIdStatus">æœªè¨­å®š</div></div><span id="userIdIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">GAS URL</div><div class="toggle-desc" id="gasStatus">æœªè¨­å®š</div></div><span id="gasIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">Secret Key</div><div class="toggle-desc" id="secretStatus">æœªè¨­å®š</div></div><span id="secretIcon">âŒ</span></div>
                    </div>
                    <button class="btn btn-primary" id="goToSettingsBtn" style="margin-top: 16px;">âš™ï¸ å‰å¾€è¨­å®š</button>
                </div>
            </div>
            <!-- è¨­å®šé  -->
            <div class="page" id="page-settings">
                <div class="card">
                    <div class="card-header"><div class="card-icon purple">ğŸ¤–</div><div><div class="card-title">Gemini API</div><div class="card-subtitle">AI æ™ºèƒ½è§£æï¼ˆé¸å¡«ï¼‰</div></div></div>
                    <div class="input-group"><label class="input-label">API Key</label><div class="input-row"><input type="password" class="input-field" id="geminiApiKey" placeholder="é¸å¡«ï¼šå•Ÿç”¨ AI æ™ºèƒ½è§£æ"><button class="input-btn" id="toggleGeminiKey">ğŸ‘ï¸</button></div></div>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon cyan">ğŸ”</div><div><div class="card-title">Google OAuth</div><div class="card-subtitle">ç”¨æ–¼è‡ªå‹•åŒ¯å…¥æ—¥æ›†ï¼ˆæˆæ¬Šä¿ç•™24å°æ™‚ï¼‰</div></div></div>
                    <div class="input-group"><label class="input-label">Client ID</label><div class="input-row"><input type="password" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID"><button class="input-btn" id="toggleGoogleId">ğŸ‘ï¸</button></div></div>
                    <div class="action-row" style="margin-top: 12px;">
                        <button class="btn btn-primary btn-sm" id="googleAuthBtn" onclick="handleGoogleAuth()">ğŸ”‘ æˆæ¬Š Google</button>
                        <button class="btn btn-outline btn-sm" onclick="handleGoogleSignOut()">ğŸšª ç™»å‡º</button>
                    </div>
                    <div id="googleAuthStatus" style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted);">âŒ æœªæˆæ¬Š</div>
                    <button class="btn btn-outline btn-sm" onclick="showApiDiagnostics()" style="margin-top: 12px;">ğŸ” API è¨ºæ–·</button>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon emerald">ğŸ“±</div><div><div class="card-title">LINE é€šçŸ¥</div><div class="card-subtitle">ç ”ç¿’æé†’æ¨æ’­</div></div></div>
                    <div class="input-group"><label class="input-label">Channel Access Token</label><div class="input-row"><input type="password" class="input-field" id="lineChannelAccessToken" placeholder="è¼¸å…¥ LINE Token"><button class="input-btn" id="toggleLineToken">ğŸ‘ï¸</button></div></div>
                    <div class="input-group"><label class="input-label">User ID</label><div class="input-row"><input type="password" class="input-field" id="lineUserId" placeholder="è¼¸å…¥ LINE User ID"><button class="input-btn" id="toggleLineUserId">ğŸ‘ï¸</button></div></div>
                    <div class="input-group"><label class="input-label">GAS Web App URL</label><div class="input-row"><input type="password" class="input-field" id="gasWebAppUrl" placeholder="è¼¸å…¥ GAS ç¶²å€"><button class="input-btn" id="toggleGasUrl">ğŸ‘ï¸</button></div></div>
                    <div class="input-group"><label class="input-label">ğŸ” Secret Key</label><div class="input-row"><input type="password" class="input-field" id="gasSecretKey" placeholder="è¼¸å…¥å®‰å…¨é‡‘é‘°"><button class="input-btn" id="toggleGasSecret">ğŸ‘ï¸</button></div></div>
                    <button class="btn btn-outline btn-sm" id="testLineBtn">ğŸ“¤ ç™¼é€æ¸¬è©¦è¨Šæ¯</button>
                </div>
                <div class="card">
                    <div class="card-header"><div class="card-icon cyan">ğŸ’¾</div><div><div class="card-title">æœ¬æ©Ÿå„²å­˜</div><div class="card-subtitle">è‡ªå‹•è¨˜ä½è¨­å®š</div></div></div>
                    <div class="toggle-row"><div><div class="toggle-title">å•Ÿç”¨æœ¬æ©Ÿå„²å­˜</div><div class="toggle-desc">API é‡‘é‘°å°‡å„²å­˜åœ¨æœ¬æ©Ÿ</div></div><div class="toggle-switch" id="localStorageToggle"></div></div>
                </div>
                <button class="btn btn-danger" id="clearAllBtn" style="margin-top: 20px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </main>
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home"><span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span></button>
            <button class="nav-item" data-page="input"><span class="nav-icon">ğŸ“</span><span class="nav-label">è¼¸å…¥</span></button>
            <button class="nav-item" data-page="line"><span class="nav-icon">ğŸ“±</span><span class="nav-label">LINE</span></button>
            <button class="nav-item" data-page="settings"><span class="nav-icon">âš™ï¸</span><span class="nav-label">è¨­å®š</span></button>
        </nav>
    </div>
    <div class="toast" id="toast"></div>
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">ğŸ“š å¹«åŠ©ä¸­å¿ƒ</div><button class="modal-close" id="closeHelpBtn">âœ•</button></div>
            <div class="modal-body">
                <div class="accordion-item open"><button class="accordion-header"><span>ğŸš€ å¦‚ä½•é–‹å§‹ä½¿ç”¨ï¼Ÿ</span><span class="accordion-icon">â–¼</span></button><div class="accordion-body">1. é»æ“Šã€Œè¼¸å…¥ã€é é¢<br>2. é¸æ“‡æ–‡å­—ã€æª”æ¡ˆæˆ–åœ–ç‰‡è¼¸å…¥<br>3. è²¼ä¸Šæˆ–ä¸Šå‚³ç ”ç¿’è³‡è¨Š<br>4. é»æ“Šã€ŒAI æ™ºèƒ½è§£æã€<br>5. ç¢ºèªè§£æçµæœå¾ŒåŒ¯å…¥æ—¥æ›†</div></div>
                <div class="accordion-item"><button class="accordion-header"><span>ğŸ”‘ Gemini API è¨­å®š</span><span class="accordion-icon">â–¼</span></button><div class="accordion-body">1. å‰å¾€ Google AI Studio<br>2. é»æ“Šã€ŒGet API keyã€<br>3. å»ºç«‹æˆ–é¸æ“‡å°ˆæ¡ˆ<br>4. è¤‡è£½ API Key è²¼åˆ°è¨­å®šé é¢</div></div>
                <div class="accordion-item"><button class="accordion-header"><span>ğŸ“± LINE é€šçŸ¥è¨­å®š</span><span class="accordion-icon">â–¼</span></button><div class="accordion-body">1. å‰å¾€ LINE Developers Console<br>2. å»ºç«‹ Messaging API Channel<br>3. å–å¾— Channel Access Token<br>4. å–å¾—æ‚¨çš„ User ID<br>5. éƒ¨ç½² Google Apps Script</div></div>
            </div>
        </div>
    </div>
    <script>
        var parsedEvents = [];
        var uploadedFilesContentArray = [];
        var uploadedImagesArray = [];
        var activeInputTab = 'text';
        var localStorageEnabled = false;
        var STORAGE_PREFIX = 'workshop_mobile_';
        var DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        var SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        var tokenClient = null;
        var gapiInited = false;
        var gisInited = false;
        var accessToken = null;
        var TOKEN_CACHE_KEY = STORAGE_PREFIX + 'google_token';
        var TOKEN_EXPIRY_KEY = STORAGE_PREFIX + 'google_token_expiry';
        var TOKEN_CACHE_DURATION = 24 * 60 * 60 * 1000;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ App v3.2.3 åˆå§‹åŒ–ä¸­...');
            initNavigation(); initTabs(); initButtons(); initReminders(); initUploads(); initToggles(); initModals(); loadSettings();
            console.log('âœ… App åˆå§‹åŒ–å®Œæˆï¼');
        });

        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.addEventListener('click', function() { switchToPage(this.getAttribute('data-page')); });
            });
        }

        function switchToPage(pageName) {
            document.querySelectorAll('.page').forEach(function(page) { page.classList.remove('active'); });
            var targetPage = document.getElementById('page-' + pageName);
            if (targetPage) targetPage.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) item.classList.add('active');
            });
            if (pageName === 'line') updateLineStatus();
        }

        function initTabs() {
            document.querySelectorAll('.tabs .tab').forEach(function(tab) {
                tab.addEventListener('click', function() { switchInputTab(this.id.replace('tab-', '')); });
            });
        }

        function switchInputTab(tabName) {
            activeInputTab = tabName;
            document.querySelectorAll('.tabs .tab').forEach(function(tab) { tab.classList.remove('active'); });
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
            document.getElementById('content-' + tabName).classList.add('active');
        }

        function initButtons() {
            document.getElementById('qa-text').addEventListener('click', function() { switchToPage('input'); switchInputTab('text'); });
            document.getElementById('qa-file').addEventListener('click', function() { switchToPage('input'); switchInputTab('file'); });
            document.getElementById('qa-image').addEventListener('click', function() { switchToPage('input'); switchInputTab('image'); });
            document.getElementById('qa-api').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('helpBtn').addEventListener('click', function() { document.getElementById('helpModal').classList.add('show'); });
            document.getElementById('settingsBtn').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('parseBtn').addEventListener('click', parseSchedule);
            document.getElementById('importCalendarBtn').addEventListener('click', importToGoogleCalendar);
            document.getElementById('downloadIcsBtn').addEventListener('click', downloadICS);
            document.getElementById('viewSchedulesBtn').addEventListener('click', viewScheduledReminders);
            document.getElementById('clearSchedulesBtn').addEventListener('click', clearAllReminders);
            document.getElementById('goToSettingsBtn').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('testLineBtn').addEventListener('click', testLineNotification);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            document.getElementById('toggleGeminiKey').addEventListener('click', function() { toggleVisibility('geminiApiKey'); });
            document.getElementById('toggleGoogleId').addEventListener('click', function() { toggleVisibility('googleClientId'); });
            document.getElementById('toggleLineToken').addEventListener('click', function() { toggleVisibility('lineChannelAccessToken'); });
            document.getElementById('toggleLineUserId').addEventListener('click', function() { toggleVisibility('lineUserId'); });
            document.getElementById('toggleGasUrl').addEventListener('click', function() { toggleVisibility('gasWebAppUrl'); });
            document.getElementById('toggleGasSecret').addEventListener('click', function() { toggleVisibility('gasSecretKey'); });
        }

        function initReminders() {
            document.querySelectorAll('.reminder-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    var checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('checked', checkbox.checked);
                });
            });
        }

        function initUploads() {
            document.getElementById('fileUploadArea').addEventListener('click', function() { document.getElementById('fileUpload').click(); });
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
            document.getElementById('imageUploadArea').addEventListener('click', function() { document.getElementById('imageUpload').click(); });
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        function initToggles() { document.getElementById('localStorageToggle').addEventListener('click', toggleLocalStorage); }

        function initModals() {
            document.getElementById('closeHelpBtn').addEventListener('click', function() { document.getElementById('helpModal').classList.remove('show'); });
            document.getElementById('helpModal').addEventListener('click', function(e) { if (e.target === this) this.classList.remove('show'); });
            document.querySelectorAll('.accordion-header').forEach(function(header) {
                header.addEventListener('click', function() { this.parentElement.classList.toggle('open'); });
            });
        }

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || '');
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function toggleVisibility(inputId) {
            var input = document.getElementById(inputId);
            input.type = (input.type === 'password') ? 'text' : 'password';
        }

        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            showToast('ğŸ“„ æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');
            var reader = new FileReader();
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        var workbook = XLSX.read(e.target.result, { type: 'binary' });
                        var content = '';
                        workbook.SheetNames.forEach(function(name) { content += XLSX.utils.sheet_to_csv(workbook.Sheets[name]) + '\n'; });
                        uploadedFilesContentArray.push({ name: file.name, content: content });
                        updateFileInfo(file.name);
                    } catch (err) { showToast('âŒ Excel è®€å–å¤±æ•—', 'error'); }
                };
                reader.readAsBinaryString(file);
            } else {
                reader.onload = function(e) { uploadedFilesContentArray.push({ name: file.name, content: e.target.result }); updateFileInfo(file.name); };
                reader.readAsText(file);
            }
        }

        function updateFileInfo(fileName) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileCount').textContent = uploadedFilesContentArray.length;
            showToast('âœ… æª”æ¡ˆå·²è¼‰å…¥ï¼š' + fileName, 'success');
        }

        function handleImageUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            showToast('ğŸ“¸ æ­£åœ¨è®€å–åœ–ç‰‡...', 'info');
            var reader = new FileReader();
            reader.onload = function(e) {
                uploadedImagesArray.push(e.target.result.split(',')[1]);
                var preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.add('show');
                showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        function parseSchedule() {
            var apiKey = document.getElementById('geminiApiKey').value.trim();
            var scheduleText = document.getElementById('scheduleText').value.trim();
            if (activeInputTab === 'text' && !scheduleText) { showToast('âš ï¸ è«‹è¼¸å…¥æ´»å‹•è³‡è¨Š', 'error'); return; }
            if (activeInputTab === 'file' && uploadedFilesContentArray.length === 0) { showToast('âš ï¸ è«‹ä¸Šå‚³æª”æ¡ˆ', 'error'); return; }
            if (activeInputTab === 'image' && uploadedImagesArray.length === 0) { showToast('âš ï¸ è«‹ä¸Šå‚³åœ–ç‰‡', 'error'); return; }
            document.getElementById('parseBtnText').style.display = 'none';
            document.getElementById('parseSpinner').style.display = 'block';
            showToast('ğŸ”„ æ­£åœ¨è§£æä¸­...', 'info');
            setTimeout(function() {
                if (apiKey) { parseWithGemini(apiKey, scheduleText); }
                else { handleParseResult(parseWithBuiltIn(scheduleText)); }
            }, 500);
        }

        function convertMinguoToWestern(text) {
            if (!text) return text;
            var result = text;
            result = result.replace(/(?:æ°‘åœ‹|ä¸­è¯æ°‘åœ‹)\s*(\d{2,3})\s*å¹´/g, function(match, year) {
                var minguo = parseInt(year);
                if (minguo <= 200) { return (minguo + 1911) + 'å¹´'; }
                return match;
            });
            result = result.replace(/(\d{2,3})å¹´(\d{1,2})æœˆ/g, function(match, year, month) {
                var yearNum = parseInt(year);
                if (yearNum <= 200) { return (yearNum + 1911) + 'å¹´' + month + 'æœˆ'; }
                return match;
            });
            result = result.replace(/(\d{2,3})([\/\-])(\d{1,2})\2(\d{1,2})/g, function(match, year, sep, month, day) {
                var yearNum = parseInt(year);
                if (yearNum <= 200) { return (yearNum + 1911) + sep + month + sep + day; }
                return match;
            });
            return result;
        }

        function fixMinguoYearInDate(dateStr, rocYear) {
            if (!dateStr) return dateStr;
            if (rocYear && rocYear >= 100 && rocYear <= 200) {
                var expectedWesternYear = rocYear + 1911;
                var match = dateStr.match(/^(\d{4})/);
                if (match && parseInt(match[1]) !== expectedWesternYear) {
                    dateStr = dateStr.replace(/^\d{4}/, expectedWesternYear.toString());
                }
            }
            var match = dateStr.match(/^(\d{2,3})-/);
            if (match) {
                var yearNum = parseInt(match[1]);
                if (yearNum >= 100 && yearNum <= 200) {
                    dateStr = dateStr.replace(/^\d{2,3}/, (yearNum + 1911).toString());
                }
            }
            return dateStr;
        }

        // ğŸ”§ v3.2.3 å¼·åŒ–ï¼šå¾åŸå§‹è¼¸å…¥ä¸­æå–è¥¿å…ƒå¹´ä»½
        function extractWesternYearFromInput(text) {
            if (!text) return null;
            
            // å„ªå…ˆåŒ¹é…ã€ŒYYYYå¹´ã€æ ¼å¼ï¼ˆä¸­æ–‡ç’°å¢ƒæœ€å¸¸è¦‹ï¼‰
            var yearWithCharMatch = text.match(/(202[0-9]|2030)å¹´/);
            if (yearWithCharMatch) {
                console.log('ğŸ” å¾ã€ŒXå¹´ã€æ ¼å¼æå–å¹´ä»½:', yearWithCharMatch[1]);
                return parseInt(yearWithCharMatch[1]);
            }
            
            // åŒ¹é…æ—¥æœŸæ ¼å¼ï¼š2026/1/18 æˆ– 2026-1-18
            var dateMatch = text.match(/(202[0-9]|2030)[\/\-]\d{1,2}[\/\-]\d{1,2}/);
            if (dateMatch) {
                var year = dateMatch[0].match(/^(\d{4})/)[1];
                console.log('ğŸ” å¾æ—¥æœŸæ ¼å¼æå–å¹´ä»½:', year);
                return parseInt(year);
            }
            
            // å‚™ç”¨ï¼šåŒ¹é…ç¨ç«‹çš„å¹´ä»½æ•¸å­—ï¼ˆå‰å¾Œä¸æ˜¯æ•¸å­—ï¼‰
            var standaloneMatch = text.match(/(?:^|[^0-9])(202[0-9]|2030)(?:[^0-9]|$)/);
            if (standaloneMatch) {
                console.log('ğŸ” å¾å‚™ç”¨æ¨¡å¼æå–å¹´ä»½:', standaloneMatch[1]);
                return parseInt(standaloneMatch[1]);
            }
            return null;
        }

        // ğŸ”§ v3.2.3 å¼·åŒ–ï¼šå¼·åˆ¶ä¿®æ­£è¥¿å…ƒå¹´ä»½
        function fixWesternYearInDate(dateStr, originalYear) {
            if (!dateStr || !originalYear) return dateStr;
            var match = dateStr.match(/^(\d{4})/);
            if (match) {
                var aiYear = parseInt(match[1]);
                // å¦‚æœ AI è¿”å›çš„å¹´ä»½èˆ‡åŸå§‹è¼¸å…¥ä¸åŒï¼Œå¼·åˆ¶ä¿®æ­£
                if (aiYear !== originalYear && originalYear >= 2024 && originalYear <= 2035) {
                    console.log('ğŸ”§ [v3.2.3] å¼·åˆ¶ä¿®æ­£å¹´ä»½: AI=' + aiYear + ' â†’ åŸå§‹=' + originalYear);
                    dateStr = dateStr.replace(/^\d{4}/, originalYear.toString());
                }
            }
            return dateStr;
        }

        function fixCrazyYear(dateStr) {
            if (!dateStr) return dateStr;
            var match = dateStr.match(/^(\d+)-(\d+)-(\d+)/);
            if (match) {
                var yearNum = parseInt(match[1]);
                if (yearNum > 2100) {
                    var now = new Date();
                    var fixed = (parseInt(match[2]) === 1) ? now.getFullYear() + 1 : now.getFullYear();
                    return dateStr.replace(/^\d+/, fixed.toString());
                }
            }
            return dateStr;
        }

        function handleParseResult(events) {
            document.getElementById('parseBtnText').style.display = 'inline';
            document.getElementById('parseSpinner').style.display = 'none';
            if (events && events.length > 0) {
                events = events.map(function(e) {
                    if (e.startDateTime) e.startDateTime = fixCrazyYear(e.startDateTime);
                    if (e.endDateTime) e.endDateTime = fixCrazyYear(e.endDateTime);
                    return e;
                });
                parsedEvents = events;
                displayEvents(events);
                document.getElementById('eventsPreview').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
                document.getElementById('eventCount').textContent = events.length;
                showToast('âœ… è§£ææˆåŠŸï¼æ‰¾åˆ° ' + events.length + ' å€‹äº‹ä»¶', 'success');
            } else {
                showToast('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº‹ä»¶ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼', 'error');
            }
        }

        // ğŸ”§ v3.2.3 æ ¸å¿ƒä¿®å¾©ï¼šåœ¨ API èª¿ç”¨å‰æå–å¹´ä»½ä¸¦ä¿å­˜
        function parseWithGemini(apiKey, scheduleText) {
            var now = new Date();
            var currentYear = now.getFullYear();
            var currentMonth = now.getMonth() + 1;
            var currentDate = now.getDate();

            // ğŸ”§ v3.2.3 ä¿®å¾©ï¼šå…ˆå¾åŸå§‹è¼¸å…¥æå–å¹´ä»½ï¼ˆåœ¨ä»»ä½•è½‰æ›å‰ï¼‰
            var rawInput = '';
            if (activeInputTab === 'text') { 
                rawInput = scheduleText; 
            } else if (activeInputTab === 'file') { 
                rawInput = uploadedFilesContentArray.map(function(f) { return f.content; }).join('\n\n'); 
            }
            
            // æå–ä¸¦ä¿å­˜åŸå§‹å¹´ä»½
            var originalYear = extractWesternYearFromInput(rawInput);
            console.log('ğŸ“… [v3.2.3] åŸå§‹è¼¸å…¥å¹´ä»½:', originalYear);
            console.log('ğŸ“ [v3.2.3] åŸå§‹è¼¸å…¥å‰100å­—:', rawInput.substring(0, 100));

            var prompt = 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œç¨‹è¡¨è§£æåŠ©æ‰‹ã€‚è«‹å°‡ä»¥ä¸‹æ´»å‹•è³‡è¨Šè§£æç‚º JSON æ ¼å¼ã€‚\n\n';
            prompt += 'ä»Šå¤©æ˜¯ ' + currentYear + ' å¹´ ' + currentMonth + ' æœˆ ' + currentDate + ' æ—¥\n\n';
            prompt += 'è«‹è¼¸å‡ºä»¥ä¸‹ JSON æ ¼å¼ï¼ˆç´” JSONï¼Œä¸è¦ markdownï¼‰ï¼š\n';
            prompt += '{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°"}]}\n\n';
            prompt += 'ã€ğŸš¨ğŸš¨ğŸš¨ æœ€æœ€æœ€é‡è¦ - çµ•å°ä¿ç•™è¥¿å…ƒå¹´ä»½ ğŸš¨ğŸš¨ğŸš¨ã€‘\n';
            prompt += 'å¦‚æœè¼¸å…¥åŒ…å« 4 ä½æ•¸å¹´ä»½ï¼ˆ2024ã€2025ã€2026ã€2027...ï¼‰ï¼Œé€™æ˜¯è¥¿å…ƒå¹´ï¼Œå¿…é ˆ 100% åŸå°ä¸å‹•ä½¿ç”¨ï¼\n';
            prompt += 'ä¾‹å¦‚ã€Œ2026å¹´1æœˆ18æ—¥ã€â†’ è¼¸å‡ºå¿…é ˆæ˜¯ã€Œ2026-01-18ã€ï¼Œçµ•å°çµ•å°ä¸èƒ½è®Šæˆ 2027ï¼\n';
            prompt += 'ä¾‹å¦‚ã€Œ2025å¹´3æœˆ5æ—¥ã€â†’ è¼¸å‡ºå¿…é ˆæ˜¯ã€Œ2025-03-05ã€ï¼Œçµ•å°ä¸èƒ½æ”¹è®Šå¹´ä»½ï¼\n';
            prompt += 'ä½ ä¸éœ€è¦ã€Œæ¨æ¸¬ã€æˆ–ã€Œä¿®æ­£ã€å¹´ä»½ï¼Œç›´æ¥ä½¿ç”¨è¼¸å…¥ä¸­çš„å¹´ä»½ï¼\n\n';
            prompt += 'ã€æ°‘åœ‹å¹´è½‰æ›ã€‘åªæœ‰ç•¶å¹´ä»½æ˜¯ 2-3 ä½æ•¸ä¸” â‰¤ 200 æ™‚æ‰è¦–ç‚ºæ°‘åœ‹å¹´ï¼š\n';
            prompt += '114å¹´ = 2025å¹´ã€115å¹´ = 2026å¹´ã€116å¹´ = 2027å¹´\n\n';
            prompt += 'ã€æ™‚é–“è¦å‰‡ã€‘\n';
            prompt += 'â€¢ æ—¥æœŸæ ¼å¼å¿…é ˆæ˜¯ ISO 8601ï¼ˆYYYY-MM-DDTHH:MM:SSï¼‰\n';
            prompt += 'â€¢ å¦‚æœæ²’æœ‰çµæŸæ™‚é–“ï¼Œé è¨­æ´»å‹• 2 å°æ™‚\n';
            prompt += 'â€¢ å¦‚æœåªæœ‰æ—¥æœŸæ²’æœ‰æ™‚é–“ï¼Œé è¨­ 08:00-17:00\n';

            var content = '';
            if (activeInputTab === 'text') { content = convertMinguoToWestern(scheduleText); }
            else if (activeInputTab === 'file') { content = uploadedFilesContentArray.map(function(f) { return convertMinguoToWestern(f.content); }).join('\n\n'); }

            var requestBody = { contents: [{ parts: [{ text: prompt + 'è¡Œç¨‹å…§å®¹ï¼š\n' + content }] }], generationConfig: { temperature: 0.1 } };

            if (activeInputTab === 'image' && uploadedImagesArray.length > 0) {
                var ocrPrompt = 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œç¨‹è¡¨ OCR è¾¨è­˜åŠ©æ‰‹ã€‚è«‹ä»”ç´°è¾¨è­˜åœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œä¸¦è§£æç‚ºè¡Œäº‹æ›†äº‹ä»¶ã€‚\n\n';
                ocrPrompt += 'ä»Šå¤©æ˜¯ ' + currentYear + ' å¹´ ' + currentMonth + ' æœˆ ' + currentDate + ' æ—¥\n\n';
                ocrPrompt += 'è«‹è¼¸å‡º JSON æ ¼å¼ï¼š{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°","rocYear":è­˜åˆ¥åˆ°çš„æ°‘åœ‹å¹´æ•¸å­—}]}\n\n';
                ocrPrompt += 'ã€ğŸš¨ è¥¿å…ƒå¹´ä»½å¿…é ˆåŸå°ä¸å‹•ä¿ç•™ ğŸš¨ã€‘\n';
                ocrPrompt += 'ã€æ°‘åœ‹å¹´è½‰æ›ã€‘æ°‘åœ‹å¹´ + 1911 = è¥¿å…ƒå¹´ï¼š114å¹´=2025å¹´ã€115å¹´=2026å¹´ã€116å¹´=2027å¹´\n';
                var parts = [{ text: ocrPrompt }];
                uploadedImagesArray.forEach(function(img) { parts.push({ inline_data: { mime_type: 'image/jpeg', data: img } }); });
                requestBody = { contents: [{ parts: parts }], generationConfig: { temperature: 0.1 } };
            }

            // ä½¿ç”¨é–‰åŒ…ä¿å­˜ originalYear
            var savedOriginalYear = originalYear;

            fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.error) throw new Error(data.error.message);
                var text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                var result = JSON.parse(text);
                var events = result.events || [];
                
                console.log('ğŸ“… [v3.2.3] API å›å‚³äº‹ä»¶æ•¸:', events.length);
                console.log('ğŸ“… [v3.2.3] ä½¿ç”¨çš„åŸå§‹å¹´ä»½:', savedOriginalYear);
                
                // ğŸ”§ v3.2.3 æ ¸å¿ƒï¼šå¼·åˆ¶ä½¿ç”¨åŸå§‹å¹´ä»½ä¿®æ­£æ‰€æœ‰äº‹ä»¶
                events = events.map(function(event) {
                    var rocYear = event.rocYear || null;
                    
                    console.log('ğŸ” è™•ç†äº‹ä»¶:', event.title, 'åŸå§‹ startDateTime:', event.startDateTime);
                    
                    if (event.startDateTime) {
                        event.startDateTime = fixMinguoYearInDate(event.startDateTime, rocYear);
                        // ğŸ”§ ä½¿ç”¨ä¿å­˜çš„åŸå§‹å¹´ä»½å¼·åˆ¶ä¿®æ­£
                        event.startDateTime = fixWesternYearInDate(event.startDateTime, savedOriginalYear);
                        console.log('âœ… ä¿®æ­£å¾Œ startDateTime:', event.startDateTime);
                    }
                    if (event.endDateTime) {
                        event.endDateTime = fixMinguoYearInDate(event.endDateTime, rocYear);
                        event.endDateTime = fixWesternYearInDate(event.endDateTime, savedOriginalYear);
                    }
                    return event;
                });
                handleParseResult(events);
            })
            .catch(function(error) {
                console.error('Gemini éŒ¯èª¤:', error);
                showToast('âŒ AI è§£æå¤±æ•—ï¼Œæ”¹ç”¨å…§å»ºè§£æ', 'error');
                handleParseResult(parseWithBuiltIn(scheduleText));
            });
        }

        function parseWithBuiltIn(text) {
            if (!text) return [];
            text = convertMinguoToWestern(text);
            var events = [];
            var lines = text.split('\n');
            var currentEvent = null;
            var now = new Date();
            var fullDateTimeRegex = /(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})[æ—¥]?.*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            var dateTimeRegex = /(\d{1,2})[\/\-æœˆ](\d{1,2})[æ—¥]?.*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            var fullDateOnlyRegex = /(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})[æ—¥]?/;

            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return;
                var fullDateTimeMatch = line.match(fullDateTimeRegex);
                var fullDateOnlyMatch = line.match(fullDateOnlyRegex);

                if (fullDateTimeMatch) {
                    if (currentEvent && currentEvent.title) events.push(currentEvent);
                    var year = parseInt(fullDateTimeMatch[1]);
                    var month = parseInt(fullDateTimeMatch[2]);
                    var day = parseInt(fullDateTimeMatch[3]);
                    currentEvent = {
                        title: '', location: '', description: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(parseInt(fullDateTimeMatch[4])).padStart(2, '0') + ':' + fullDateTimeMatch[5] + ':00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(parseInt(fullDateTimeMatch[6])).padStart(2, '0') + ':' + fullDateTimeMatch[7] + ':00'
                    };
                } else if (fullDateOnlyMatch && !currentEvent) {
                    var year = parseInt(fullDateOnlyMatch[1]);
                    var month = parseInt(fullDateOnlyMatch[2]);
                    var day = parseInt(fullDateOnlyMatch[3]);
                    currentEvent = {
                        title: '', location: '', description: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T09:00:00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T12:00:00'
                    };
                } else if (currentEvent) {
                    if (line.includes('åœ°é»') || line.includes('å ´åœ°')) {
                        currentEvent.location = line.replace(/åœ°é»[:ï¼š]?\s*/, '').replace(/å ´åœ°[:ï¼š]?\s*/, '');
                    } else if (!currentEvent.title && line.length > 2) {
                        currentEvent.title = line;
                    } else if (currentEvent.title) {
                        currentEvent.description += line + '\n';
                    }
                }
            });
            if (currentEvent && currentEvent.title) events.push(currentEvent);
            return events;
        }

        function displayEvents(events) {
            var container = document.getElementById('eventsPreview');
            var html = '';
            var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            events.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                html += '<div class="event-item" id="event_' + index + '">';
                html += '<div class="event-title">' + (event.title || 'æœªå‘½åäº‹ä»¶') + '</div>';
                html += '<div class="event-meta">';
                html += '<div class="event-meta-item">ğŸ“… ' + formatDate(startDate) + '<span class="day-badge">é€±' + weekdays[startDate.getDay()] + '</span></div>';
                html += '<div class="event-meta-item">â° ' + formatTime(startDate) + ' - ' + formatTime(endDate) + '</div>';
                if (event.location) html += '<div class="event-meta-item">ğŸ“ ' + event.location + '</div>';
                html += '</div></div>';
            });
            container.innerHTML = html;
            document.getElementById('homeEventList').innerHTML = html || '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
        }

        function formatDate(date) { return date.getFullYear() + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + String(date.getDate()).padStart(2, '0'); }
        function formatTime(date) { return String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0'); }

        function downloadICS() {
            if (parsedEvents.length === 0) { showToast('âŒ æ²’æœ‰å¯åŒ¯å‡ºçš„äº‹ä»¶', 'error'); return; }
            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(input) { reminders.push(parseInt(input.value)); });
            var icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Workshop Mobile//EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n';
            parsedEvents.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                var now = new Date();
                icsContent += 'BEGIN:VEVENT\nUID:workshop-' + index + '-' + Date.now() + '@mobile\n';
                icsContent += 'DTSTAMP:' + formatICSDate(now) + '\nDTSTART:' + formatICSDate(startDate) + '\nDTEND:' + formatICSDate(endDate) + '\n';
                icsContent += 'SUMMARY:' + escapeICS(event.title) + '\n';
                if (event.location) icsContent += 'LOCATION:' + escapeICS(event.location) + '\n';
                if (event.description) icsContent += 'DESCRIPTION:' + escapeICS(event.description) + '\n';
                reminders.forEach(function(mins) { icsContent += 'BEGIN:VALARM\nTRIGGER:-PT' + mins + 'M\nACTION:DISPLAY\nDESCRIPTION:ç ”ç¿’æé†’\nEND:VALARM\n'; });
                icsContent += 'END:VEVENT\n';
            });
            icsContent += 'END:VCALENDAR';
            var blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ç ”ç¿’è¡Œäº‹æ›†_' + formatDate(new Date()).replace(/\//g, '') + '.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('âœ… ICS æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
            var hasLineSettings = document.getElementById('lineChannelAccessToken').value.trim() && document.getElementById('lineUserId').value.trim() && document.getElementById('gasWebAppUrl').value.trim() && document.getElementById('gasSecretKey').value.trim();
            if (hasLineSettings && getSelectedLineReminders().length > 0) { setTimeout(function() { createReminderSchedules(parsedEvents); }, 500); }
        }

        function formatICSDate(date) { return date.getFullYear() + String(date.getMonth() + 1).padStart(2, '0') + String(date.getDate()).padStart(2, '0') + 'T' + String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0') + String(date.getSeconds()).padStart(2, '0'); }
        function escapeICS(text) { if (!text) return ''; return text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n'); }

        function gapiLoaded() { if (typeof gapi !== 'undefined') gapi.load('client', initializeGapiClient); }
        async function initializeGapiClient() {
            try {
                await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                if (!gapi.client.calendar) { try { await gapi.client.load('calendar', 'v3'); } catch (e) {} }
                gapiInited = true;
                restoreCachedToken();
                maybeEnableCalendarButton();
            } catch (error) {
                try { await gapi.client.load('calendar', 'v3'); gapiInited = true; maybeEnableCalendarButton(); } catch (e2) {}
            }
        }

        function gisLoaded() {
            var clientIdInput = document.getElementById('googleClientId');
            if (clientIdInput && clientIdInput.value.trim()) initTokenClient(clientIdInput.value.trim());
            if (clientIdInput) clientIdInput.addEventListener('change', function() { if (this.value.trim()) initTokenClient(this.value.trim()); });
        }

        function initTokenClient(clientId) {
            if (typeof google === 'undefined' || !google.accounts) return;
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: clientId, scope: SCOPES, callback: '' });
            gisInited = true;
            restoreCachedToken();
            maybeEnableCalendarButton();
        }

        function maybeEnableCalendarButton() {
            var authBtn = document.getElementById('googleAuthBtn');
            if (authBtn && gapiInited && gisInited) {
                authBtn.disabled = false;
                authBtn.classList.remove('disabled');
                if (accessToken && isCachedTokenValid()) updateAuthButtonStatus(true);
            }
        }

        function saveCachedToken(token) { try { localStorage.setItem(TOKEN_CACHE_KEY, token); localStorage.setItem(TOKEN_EXPIRY_KEY, (Date.now() + TOKEN_CACHE_DURATION).toString()); } catch (e) {} }
        function restoreCachedToken() {
            try {
                var cachedToken = localStorage.getItem(TOKEN_CACHE_KEY);
                var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY);
                if (cachedToken && expiry && Date.now() < parseInt(expiry)) {
                    accessToken = cachedToken;
                    if (gapiInited && typeof gapi !== 'undefined') gapi.client.setToken({ access_token: cachedToken });
                    updateAuthButtonStatus(true, Math.round((parseInt(expiry) - Date.now()) / 3600000 * 10) / 10);
                    return true;
                } else { clearCachedToken(); }
            } catch (e) {}
            return false;
        }
        function isCachedTokenValid() { try { var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY); return expiry && Date.now() < parseInt(expiry); } catch (e) {} return false; }
        function clearCachedToken() { try { localStorage.removeItem(TOKEN_CACHE_KEY); localStorage.removeItem(TOKEN_EXPIRY_KEY); accessToken = null; } catch (e) {} }
        function getCachedTokenRemainingTime() { try { var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY); if (expiry) { var remaining = parseInt(expiry) - Date.now(); if (remaining > 0) return Math.round(remaining / 3600000 * 10) / 10; } } catch (e) {} return 0; }

        function handleGoogleAuth() {
            var clientId = document.getElementById('googleClientId').value.trim();
            if (!clientId) { showToast('âš ï¸ è«‹å…ˆè¼¸å…¥ Google OAuth Client ID', 'error'); return; }
            if (!tokenClient) initTokenClient(clientId);
            if (!tokenClient) { showToast('âŒ Google æˆæ¬Šæœå‹™æœªå°±ç·’', 'error'); return; }
            if (accessToken && isCachedTokenValid()) { showToast('âœ… æˆæ¬Šä»æœ‰æ•ˆï¼ˆå‰©é¤˜ ' + getCachedTokenRemainingTime() + ' å°æ™‚ï¼‰', 'success'); return; }
            showToast('ğŸ” æ­£åœ¨é–‹å•Ÿ Google æˆæ¬Š...', 'info');
            tokenClient.callback = function(response) {
                if (response.error !== undefined) { showToast('âŒ æˆæ¬Šå¤±æ•—: ' + response.error, 'error'); return; }
                var token = gapi.client.getToken();
                if (token && token.access_token) { accessToken = token.access_token; saveCachedToken(accessToken); showToast('âœ… Google æ—¥æ›†æˆæ¬ŠæˆåŠŸï¼', 'success'); updateAuthButtonStatus(true); }
            };
            tokenClient.requestAccessToken({ prompt: gapi.client.getToken() === null ? 'consent' : '' });
        }

        function updateAuthButtonStatus(authorized, remainingHours) {
            var authBtn = document.getElementById('googleAuthBtn');
            var authStatus = document.getElementById('googleAuthStatus');
            if (authorized) {
                if (authBtn) { authBtn.innerHTML = 'âœ… å·²æˆæ¬Š'; authBtn.classList.add('authorized'); }
                if (authStatus) { authStatus.innerHTML = 'âœ… å·²æˆæ¬Šï¼ˆå‰©é¤˜ ' + (remainingHours || getCachedTokenRemainingTime()) + ' å°æ™‚ï¼‰'; authStatus.style.color = 'var(--emerald)'; }
            } else {
                if (authBtn) { authBtn.innerHTML = 'ğŸ”‘ æˆæ¬Š Google'; authBtn.classList.remove('authorized'); }
                if (authStatus) { authStatus.innerHTML = 'âŒ æœªæˆæ¬Š'; authStatus.style.color = 'var(--red)'; }
            }
        }

        function handleGoogleSignOut() {
            if (accessToken && typeof google !== 'undefined' && google.accounts) google.accounts.oauth2.revoke(accessToken, function() {});
            if (typeof gapi !== 'undefined' && gapi.client) gapi.client.setToken(null);
            clearCachedToken();
            updateAuthButtonStatus(false);
            showToast('âœ… å·²ç™»å‡º Google å¸³è™Ÿ', 'success');
        }

        function showApiDiagnostics() {
            var info = ['â•â•â• API è¨ºæ–·å ±å‘Š â•â•â•', '', 'gapi: ' + (typeof gapi !== 'undefined' ? 'âœ…' : 'âŒ'), 'gapi.client: ' + (typeof gapi !== 'undefined' && gapi.client ? 'âœ…' : 'âŒ'), 'gapiInited: ' + gapiInited, 'gisInited: ' + gisInited, 'accessToken: ' + (accessToken ? 'âœ…' : 'âŒ'), 'Token æœ‰æ•ˆ: ' + isCachedTokenValid()];
            alert(info.join('\n'));
        }

        async function importToGoogleCalendar() {
            if (parsedEvents.length === 0) { showToast('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„äº‹ä»¶', 'error'); return; }
            if (!accessToken || !isCachedTokenValid()) { showToast('âš ï¸ è«‹å…ˆæˆæ¬Š Google æ—¥æ›†', 'error'); return; }
            if (typeof gapi === 'undefined' || !gapi.client) { showToast('âŒ Google API æœªè¼‰å…¥', 'error'); return; }
            gapi.client.setToken({ access_token: accessToken });
            if (!gapi.client.calendar) { try { await gapi.client.load('calendar', 'v3'); } catch (e) { showToast('âŒ Calendar API è¼‰å…¥å¤±æ•—', 'error'); return; } }
            showToast('ğŸ“¤ æ­£åœ¨åŒ¯å…¥åˆ° Google æ—¥æ›†...', 'info');
            var successCount = 0, failCount = 0;
            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(input) { reminders.push(parseInt(input.value)); });
            for (var i = 0; i < parsedEvents.length; i++) {
                var event = parsedEvents[i];
                try {
                    await gapi.client.calendar.events.insert({
                        calendarId: 'primary',
                        resource: {
                            summary: event.title, location: event.location || '', description: event.description || '',
                            start: { dateTime: event.startDateTime, timeZone: 'Asia/Taipei' },
                            end: { dateTime: event.endDateTime, timeZone: 'Asia/Taipei' },
                            reminders: { useDefault: false, overrides: reminders.map(function(mins) { return { method: 'popup', minutes: mins }; }) }
                        }
                    });
                    successCount++;
                } catch (error) {
                    failCount++;
                    if (error.status === 401) { clearCachedToken(); updateAuthButtonStatus(false); return; }
                }
            }
            if (successCount > 0) {
                showToast('âœ… æˆåŠŸåŒ¯å…¥ ' + successCount + ' å€‹äº‹ä»¶ï¼', 'success');
                var hasLineSettings = document.getElementById('lineChannelAccessToken').value.trim() && document.getElementById('lineUserId').value.trim() && document.getElementById('gasWebAppUrl').value.trim() && document.getElementById('gasSecretKey').value.trim();
                if (hasLineSettings && getSelectedLineReminders().length > 0) setTimeout(function() { createReminderSchedules(parsedEvents); }, 500);
                setTimeout(function() {
                    parsedEvents = [];
                    document.getElementById('eventCount').textContent = '0';
                    document.getElementById('eventsPreview').innerHTML = '';
                    document.getElementById('eventsPreview').style.display = 'none';
                    document.getElementById('homeEventList').innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
                    document.getElementById('importActions').style.display = 'none';
                }, 1500);
            }
            if (failCount > 0) showToast('âš ï¸ ' + failCount + ' å€‹äº‹ä»¶åŒ¯å…¥å¤±æ•—', 'error');
        }

        function updateLineStatus() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            updateStatus('token', token); updateStatus('userId', userId); updateStatus('gas', gasUrl); updateStatus('secret', gasSecret);
        }
        function updateStatus(name, value) {
            var statusEl = document.getElementById(name + 'Status');
            var iconEl = document.getElementById(name + 'Icon');
            if (value) { statusEl.textContent = 'å·²è¨­å®š (' + value.substring(0, 8) + '...)'; iconEl.textContent = 'âœ…'; }
            else { statusEl.textContent = 'æœªè¨­å®š'; iconEl.textContent = 'âŒ'; }
        }

        function testLineNotification() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!token || !userId || !gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å…ˆå¡«å¯«å®Œæ•´çš„ LINE è¨­å®š', 'error'); return; }
            showToast('ğŸ“¨ æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...', 'info');
            var tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(9, 0, 0, 0);
            fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ secret: gasSecret, token: token, userId: userId, workshops: [{ title: 'ğŸ“š æ¸¬è©¦ç ”ç¿’', startDateTime: tomorrow.toISOString(), endDateTime: new Date(tomorrow.getTime() + 10800000).toISOString(), location: 'æ¸¬è©¦åœ°é»', description: 'æ¸¬è©¦é€šçŸ¥' }] }) })
            .then(function(r) { return r.json(); })
            .then(function(result) { showToast(result.success ? 'âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼' : 'âŒ ç™¼é€å¤±æ•—', result.success ? 'success' : 'error'); })
            .catch(function(error) { showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + error.message, 'error'); });
        }

        function viewScheduledReminders() {
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL å’Œ Secret Key', 'error'); return; }
            showToast('ğŸ“‹ æ­£åœ¨æŸ¥è©¢æ’ç¨‹...', 'info');
            fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'getSchedules', secret: gasSecret }) })
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.success) {
                    var schedules = result.schedules || [];
                    if (schedules.length === 0) { showToast('ğŸ“­ ç›®å‰æ²’æœ‰æ’ç¨‹', 'info'); alert('ğŸ“­ ç›®å‰æ²’æœ‰æ’ç¨‹'); }
                    else {
                        var pending = schedules.filter(function(s) { return s.status === 'pending'; });
                        var msg = 'ğŸ“‹ æ’ç¨‹æ¸…å–®\nâ³ å¾…ç™¼é€: ' + pending.length + ' ç­†\n';
                        pending.slice(0, 10).forEach(function(s, i) { msg += (i + 1) + '. ' + s.workshopTitle + ' - ' + s.reminderLabel + '\n'; });
                        showToast('âœ… æŸ¥è©¢æˆåŠŸ', 'success');
                        alert(msg);
                    }
                } else { showToast('âŒ æŸ¥è©¢å¤±æ•—', 'error'); }
            })
            .catch(function(error) { showToast('âŒ æŸ¥è©¢å¤±æ•—ï¼š' + error.message, 'error'); });
        }

        function clearAllReminders() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’ç¨‹å—ï¼Ÿ')) return;
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL å’Œ Secret Key', 'error'); return; }
            fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'clearSchedules', secret: gasSecret }) })
            .then(function(r) { return r.json(); })
            .then(function(result) { showToast(result.success ? 'âœ… å·²æ¸…é™¤æ‰€æœ‰æ’ç¨‹' : 'âŒ æ¸…é™¤å¤±æ•—', result.success ? 'success' : 'error'); })
            .catch(function(error) { showToast('âŒ æ¸…é™¤å¤±æ•—ï¼š' + error.message, 'error'); });
        }

        function createReminderSchedules(workshops) {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!token || !userId || !gasUrl || !gasSecret) return;
            var reminderMinutes = getSelectedLineReminders();
            if (reminderMinutes.length === 0) return;
            var schedules = [];
            workshops.forEach(function(workshop) {
                var startTime = new Date(workshop.startDateTime);
                var meetLink = '';
                var allText = (workshop.location || '') + ' ' + (workshop.description || '');
                var meetMatch = allText.match(/https?:\/\/meet\.google\.com\/[a-z\-]+/i);
                if (meetMatch) meetLink = meetMatch[0];
                reminderMinutes.forEach(function(mins) {
                    var reminderTime = new Date(startTime.getTime() - mins * 60 * 1000);
                    if (reminderTime > new Date()) {
                        schedules.push({ workshopTitle: workshop.title, workshopStart: workshop.startDateTime, workshopEnd: workshop.endDateTime, workshopLocation: workshop.location || '', meetLink: meetLink, workshopDescription: workshop.description || '', reminderTime: reminderTime.toISOString(), reminderMinutes: mins, reminderLabel: getReminderLabel(mins), status: 'pending' });
                    }
                });
            });
            if (schedules.length === 0) return;
            fetch(gasUrl, { method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify({ action: 'createSchedules', secret: gasSecret, token: token, userId: userId, schedules: schedules }) })
            .then(function(r) { return r.json(); })
            .then(function(result) { if (result.success) showToast('âœ… å·²å»ºç«‹ ' + (result.count || schedules.length) + ' å€‹æé†’æ’ç¨‹', 'success'); })
            .catch(function(error) { console.error('æ’ç¨‹å»ºç«‹éŒ¯èª¤:', error); });
        }

        function getSelectedLineReminders() {
            var reminders = [];
            document.querySelectorAll('#lineReminderGrid input[type="checkbox"]').forEach(function(cb) { if (cb.checked) reminders.push(parseInt(cb.value)); });
            return reminders;
        }

        function getReminderLabel(minutes) {
            if (minutes >= 1440) return 'å‰ ' + Math.floor(minutes / 1440) + ' å¤©';
            if (minutes >= 60) return 'å‰ ' + Math.floor(minutes / 60) + ' å°æ™‚';
            return 'å‰ ' + minutes + ' åˆ†é˜';
        }

        function toggleLocalStorage() {
            var toggle = document.getElementById('localStorageToggle');
            if (toggle.classList.contains('active')) {
                if (confirm('ç¢ºå®šè¦åœç”¨æœ¬æ©Ÿå„²å­˜å—ï¼Ÿ')) { toggle.classList.remove('active'); localStorageEnabled = false; localStorage.removeItem(STORAGE_PREFIX + 'enabled'); showToast('âœ… å·²åœç”¨æœ¬æ©Ÿå„²å­˜', 'success'); }
            } else {
                if (confirm('âš ï¸ å•Ÿç”¨å¾Œè¨­å®šæœƒå­˜åœ¨æœ¬æ©Ÿï¼Œç¢ºå®šå—ï¼Ÿ')) { toggle.classList.add('active'); localStorageEnabled = true; localStorage.setItem(STORAGE_PREFIX + 'enabled', 'true'); saveSettings(); showToast('âœ… å·²å•Ÿç”¨æœ¬æ©Ÿå„²å­˜', 'success'); }
            }
        }

        function saveSettings() {
            if (!localStorageEnabled) return;
            try {
                localStorage.setItem(STORAGE_PREFIX + 'geminiApiKey', document.getElementById('geminiApiKey').value);
                localStorage.setItem(STORAGE_PREFIX + 'googleClientId', document.getElementById('googleClientId').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineToken', document.getElementById('lineChannelAccessToken').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineUserId', document.getElementById('lineUserId').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasUrl', document.getElementById('gasWebAppUrl').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasSecret', document.getElementById('gasSecretKey').value);
            } catch (e) {}
        }

        function loadSettings() {
            try {
                if (localStorage.getItem(STORAGE_PREFIX + 'enabled') === 'true') {
                    localStorageEnabled = true;
                    document.getElementById('localStorageToggle').classList.add('active');
                    var geminiKey = localStorage.getItem(STORAGE_PREFIX + 'geminiApiKey');
                    var googleId = localStorage.getItem(STORAGE_PREFIX + 'googleClientId');
                    var lineToken = localStorage.getItem(STORAGE_PREFIX + 'lineToken');
                    var lineUserId = localStorage.getItem(STORAGE_PREFIX + 'lineUserId');
                    var gasUrl = localStorage.getItem(STORAGE_PREFIX + 'gasUrl');
                    var gasSecret = localStorage.getItem(STORAGE_PREFIX + 'gasSecret');
                    if (geminiKey) document.getElementById('geminiApiKey').value = geminiKey;
                    if (googleId) document.getElementById('googleClientId').value = googleId;
                    if (lineToken) document.getElementById('lineChannelAccessToken').value = lineToken;
                    if (lineUserId) document.getElementById('lineUserId').value = lineUserId;
                    if (gasUrl) document.getElementById('gasWebAppUrl').value = gasUrl;
                    if (gasSecret) document.getElementById('gasSecretKey').value = gasSecret;
                    if (googleId) setTimeout(function() { if (typeof google !== 'undefined' && google.accounts) initTokenClient(googleId); }, 1000);
                }
                setTimeout(function() { restoreCachedToken(); }, 1500);
            } catch (e) {}
        }

        function clearScheduleText() {
            var textarea = document.getElementById('scheduleText');
            if (textarea.value.trim()) { if (confirm('ç¢ºå®šè¦æ¸…é™¤è¼¸å…¥çš„æ–‡å­—å—ï¼Ÿ')) { textarea.value = ''; showToast('âœ… å·²æ¸…é™¤æ–‡å­—', 'success'); } }
            else { showToast('ğŸ“ è¼¸å…¥å€å·²ç¶“æ˜¯ç©ºçš„', 'info'); }
        }

        function clearAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;
            try { Object.keys(localStorage).forEach(function(key) { if (key.startsWith(STORAGE_PREFIX)) localStorage.removeItem(key); }); } catch (e) {}
            document.getElementById('geminiApiKey').value = '';
            document.getElementById('googleClientId').value = '';
            document.getElementById('lineChannelAccessToken').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('gasWebAppUrl').value = '';
            document.getElementById('gasSecretKey').value = '';
            document.getElementById('scheduleText').value = '';
            document.getElementById('localStorageToggle').classList.remove('active');
            localStorageEnabled = false;
            parsedEvents = [];
            uploadedFilesContentArray = [];
            uploadedImagesArray = [];
            document.getElementById('eventsPreview').innerHTML = '';
            document.getElementById('eventsPreview').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('fileCount').textContent = '0';
            showToast('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
        }

        document.querySelectorAll('.input-field').forEach(function(input) {
            input.addEventListener('change', function() { if (localStorageEnabled) saveSettings(); });
        });

        (function() {
            var splash = document.getElementById('splashScreen');
            var minDisplayTime = 3800;
            var startTime = Date.now();
            function hideSplash() {
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, minDisplayTime - elapsed);
                setTimeout(function() {
                    splash.classList.add('hide');
                    setTimeout(function() { splash.style.display = 'none'; }, 800);
                }, remaining);
            }
            if (document.readyState === 'complete') hideSplash();
            else window.addEventListener('load', hideSplash);
        })();
    </script>
</body>
</html>
