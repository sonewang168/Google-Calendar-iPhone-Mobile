<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>ç ”ç¿’æ—¥æ›†åŠ©æ‰‹ Mobile</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.3);
            --purple: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.3);
            --emerald: #10b981;
            --emerald-glow: rgba(16, 185, 129, 0.3);
            --orange: #f59e0b;
            --red: #ef4444;
            --gold: #fbbf24;
            --text-light: #e2e8f0;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .app-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: calc(var(--nav-height) + 20px);
            display: none;
            -webkit-overflow-scrolling: touch;
        }

        .page.active {
            display: block;
        }

        /* Bottom Nav */
        .bottom-nav {
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            flex-shrink: 0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            padding: 8px 0;
            position: relative;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--cyan);
            border-radius: 0 0 3px 3px;
            transition: width 0.3s;
        }

        .nav-item.active {
            color: var(--cyan);
        }

        .nav-item.active::before {
            width: 30px;
        }

        .nav-icon {
            font-size: 1.5em;
        }

        .nav-label {
            font-size: 0.75em;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
        }

        .card-icon.cyan { background: var(--cyan-glow); }
        .card-icon.purple { background: var(--purple-glow); }
        .card-icon.emerald { background: var(--emerald-glow); }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.85em;
            color: var(--text-dim);
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--cyan);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action:active {
            transform: scale(0.98);
            background: var(--bg-card-hover);
        }

        .quick-action-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .quick-action-text {
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Input */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1em;
            -webkit-appearance: none;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        textarea.input-field {
            min-height: 150px;
            resize: vertical;
            line-height: 1.6;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row .input-field {
            flex: 1;
        }

        .input-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: var(--bg-card-hover);
            border-radius: 12px;
            color: var(--text-dim);
            font-size: 1.2em;
            flex-shrink: 0;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-size: 1.05em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--cyan);
            color: var(--cyan);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn-sm {
            padding: 12px 16px;
            font-size: 0.95em;
        }

        .action-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .action-row .btn {
            flex: 1;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-dark);
            padding: 6px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 8px;
        }

        .tab.active {
            background: var(--cyan);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(6, 182, 212, 0.05);
        }

        .upload-area:active {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .upload-text {
            font-size: 1em;
            font-weight: 500;
            color: var(--cyan);
        }

        .upload-hint {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Reminders */
        .reminder-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .reminder-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
        }

        .reminder-option.checked {
            border-color: var(--cyan);
            background: var(--cyan-glow);
        }

        .reminder-option input {
            display: none;
        }

        .reminder-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
        }

        .reminder-option.checked .reminder-checkbox {
            background: var(--cyan);
            border-color: var(--cyan);
            color: white;
        }

        .reminder-label {
            font-size: 0.95em;
        }

        /* Events */
        .event-list {
            margin-top: 20px;
        }

        .event-item {
            background: var(--bg-dark);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--cyan);
        }

        .event-title {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .event-meta {
            font-size: 0.9em;
            color: var(--text-dim);
        }

        .event-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .day-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            color: white;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .event-item.deleted {
            opacity: 0.4;
            text-decoration: line-through;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-light);
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: calc(100% - 40px);
            text-align: center;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--emerald); background: rgba(16, 185, 129, 0.2); }
        .toast.error { border-color: var(--red); background: rgba(239, 68, 68, 0.2); }
        .toast.info { border-color: var(--cyan); background: rgba(6, 182, 212, 0.2); }

        /* Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: flex-end;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            max-height: 85vh;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-dark);
            color: var(--text-dim);
            border-radius: 10px;
            font-size: 1.2em;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(85vh - 80px);
            overflow-y: auto;
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-title {
            font-weight: 500;
        }

        .toggle-desc {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .toggle-switch {
            width: 52px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--cyan);
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* Image Preview */
        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
            margin-top: 12px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        /* File Badge */
        .file-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--emerald-glow);
            border: 1px solid var(--emerald);
            color: var(--emerald);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.9em;
            margin-top: 12px;
        }

        /* Help Accordion */
        .accordion-item {
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-header {
            width: 100%;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 1em;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-body {
            display: none;
            padding: 0 16px 16px;
            color: var(--text-dim);
            font-size: 0.9em;
            line-height: 1.7;
        }

        .accordion-item.open .accordion-body {
            display: block;
        }

        .accordion-icon {
            transition: transform 0.3s;
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <span>ğŸ“…</span>
                <span>ç ”ç¿’åŠ©æ‰‹</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="helpBtn">â“</button>
                <button class="header-btn" id="settingsBtn">âš™ï¸</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-content">
            <!-- é¦–é  -->
            <div class="page active" id="page-home">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">å¾…åŒ¯å…¥äº‹ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="fileCount">0</div>
                        <div class="stat-label">å·²ä¸Šå‚³æª”æ¡ˆ</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action" id="qa-text">
                        <div class="quick-action-icon">âœï¸</div>
                        <div class="quick-action-text">æ–‡å­—è¼¸å…¥</div>
                    </div>
                    <div class="quick-action" id="qa-file">
                        <div class="quick-action-icon">ğŸ“„</div>
                        <div class="quick-action-text">ä¸Šå‚³æª”æ¡ˆ</div>
                    </div>
                    <div class="quick-action" id="qa-image">
                        <div class="quick-action-icon">ğŸ“¸</div>
                        <div class="quick-action-text">æ‹ç…§è¾¨è­˜</div>
                    </div>
                    <div class="quick-action" id="qa-api">
                        <div class="quick-action-icon">ğŸ”‘</div>
                        <div class="quick-action-text">API è¨­å®š</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“‹</div>
                        <div>
                            <div class="card-title">å¾…è™•ç†äº‹ä»¶</div>
                            <div class="card-subtitle">è§£æå®Œæˆå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                        </div>
                    </div>
                    <div id="homeEventList">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¼¸å…¥é  -->
            <div class="page" id="page-input">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ“</div>
                        <div>
                            <div class="card-title">è¼¸å…¥ç ”ç¿’è³‡è¨Š</div>
                            <div class="card-subtitle">é¸æ“‡è¼¸å…¥æ–¹å¼</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" id="tab-text">âœï¸ æ–‡å­—</button>
                        <button class="tab" id="tab-file">ğŸ“„ æª”æ¡ˆ</button>
                        <button class="tab" id="tab-image">ğŸ“¸ åœ–ç‰‡</button>
                    </div>

                    <!-- æ–‡å­—è¼¸å…¥ -->
                    <div class="tab-content active" id="content-text">
                        <div class="input-group">
                            <label class="input-label">è²¼ä¸Šç ”ç¿’æ™‚ç¨‹è¡¨</label>
                            <textarea class="input-field" id="scheduleText" placeholder="ç¯„ä¾‹ï¼š
11/25ï¼ˆä¸€ï¼‰14:00-16:00
AI æ•™å­¸æ‡‰ç”¨å·¥ä½œåŠ
åœ°é»ï¼šç·šä¸Š Google Meet
è¬›å¸«ï¼šç‹è€å¸«"></textarea>
                        </div>
                    </div>

                    <!-- æª”æ¡ˆä¸Šå‚³ -->
                    <div class="tab-content" id="content-file">
                        <label class="upload-area" for="fileUpload" style="display: block; cursor: pointer;">
                            <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.txt,.pdf" style="display:none;">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">é»æ“Šä¸Šå‚³æª”æ¡ˆ</div>
                            <div class="upload-hint">æ”¯æ´ Excelã€TXTã€CSVã€PDF</div>
                        </label>
                        <div id="fileInfo" style="display: none;">
                            <div class="file-badge">
                                <span>âœ…</span>
                                <span id="fileName">æª”æ¡ˆå·²è¼‰å…¥</span>
                            </div>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡ä¸Šå‚³ -->
                    <div class="tab-content" id="content-image">
                        <label class="upload-area" for="imageUpload" style="display: block; cursor: pointer;">
                            <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">é»æ“Šé¸æ“‡åœ–ç‰‡æˆ–æ‹ç…§</div>
                            <div class="upload-hint">æ”¯æ´ JPGã€PNGã€WEBP</div>
                        </label>
                        <img id="imagePreview" class="image-preview">
                    </div>
                </div>

                <!-- æé†’è¨­å®š -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">â°</div>
                        <div>
                            <div class="card-title">æé†’è¨­å®š</div>
                            <div class="card-subtitle">é¸æ“‡äº‹ä»¶æé†’æ™‚é–“</div>
                        </div>
                    </div>
                    <div class="reminder-grid" id="reminderGrid">
                        <label class="reminder-option" data-value="30">
                            <input type="checkbox" value="30">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">30 åˆ†é˜å‰</span>
                        </label>
                        <label class="reminder-option checked" data-value="60">
                            <input type="checkbox" value="60" checked>
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">1 å°æ™‚å‰</span>
                        </label>
                        <label class="reminder-option" data-value="120">
                            <input type="checkbox" value="120">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">2 å°æ™‚å‰</span>
                        </label>
                        <label class="reminder-option" data-value="1440">
                            <input type="checkbox" value="1440">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">1 å¤©å‰</span>
                        </label>
                    </div>
                </div>

                <!-- è§£ææŒ‰éˆ• -->
                <button class="btn btn-primary" id="parseBtn">
                    <span id="parseBtnText">ğŸš€ AI æ™ºèƒ½è§£æ</span>
                    <div class="spinner" id="parseSpinner"></div>
                </button>

                <!-- è§£æçµæœ -->
                <div id="eventsPreview" class="event-list" style="display: none;"></div>

                <!-- åŒ¯å…¥æŒ‰éˆ• -->
                <div class="action-row" id="importActions" style="display: none;">
                    <button class="btn btn-secondary" id="importCalendarBtn">ğŸ”— åŒ¯å…¥æ—¥æ›†</button>
                    <button class="btn btn-outline" id="downloadIcsBtn">ğŸ“¥ ä¸‹è¼‰ ICS</button>
                </div>
            </div>

            <!-- LINE é  -->
            <div class="page" id="page-line">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ””</div>
                        <div>
                            <div class="card-title">LINE æé†’æ’ç¨‹</div>
                            <div class="card-subtitle">ç ”ç¿’è‡ªå‹•æé†’è¨­å®š</div>
                        </div>
                    </div>

                    <div class="reminder-grid" id="lineReminderGrid">
                        <label class="reminder-option" data-value="1440">
                            <input type="checkbox" id="reminder1Day" value="1440">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 1 å¤©</span>
                        </label>
                        <label class="reminder-option" data-value="120">
                            <input type="checkbox" id="reminder2Hours" value="120">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 2 å°æ™‚</span>
                        </label>
                        <label class="reminder-option checked" data-value="60">
                            <input type="checkbox" id="reminder1Hour" value="60" checked>
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 1 å°æ™‚</span>
                        </label>
                        <label class="reminder-option" data-value="30">
                            <input type="checkbox" id="reminder30Min" value="30">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 30 åˆ†é˜</span>
                        </label>
                    </div>

                    <div class="action-row">
                        <button class="btn btn-outline btn-sm" id="viewSchedulesBtn">ğŸ“‹ æŸ¥çœ‹æ’ç¨‹</button>
                        <button class="btn btn-danger btn-sm" id="clearSchedulesBtn">ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“Š</div>
                        <div>
                            <div class="card-title">è¨­å®šç‹€æ…‹</div>
                            <div class="card-subtitle">LINE é€šçŸ¥è¨­å®šæª¢æŸ¥</div>
                        </div>
                    </div>
                    <div id="lineStatusList">
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">Channel Token</div>
                                <div class="toggle-desc" id="tokenStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="tokenIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">User ID</div>
                                <div class="toggle-desc" id="userIdStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="userIdIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">GAS URL</div>
                                <div class="toggle-desc" id="gasStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="gasIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">Secret Key</div>
                                <div class="toggle-desc" id="secretStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="secretIcon">âŒ</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="goToSettingsBtn" style="margin-top: 16px;">âš™ï¸ å‰å¾€è¨­å®š</button>
                </div>
            </div>

            <!-- è¨­å®šé  -->
            <div class="page" id="page-settings">
                <!-- Gemini API -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ¤–</div>
                        <div>
                            <div class="card-title">Gemini API</div>
                            <div class="card-subtitle">AI æ™ºèƒ½è§£æï¼ˆé¸å¡«ï¼‰</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="geminiApiKey" placeholder="é¸å¡«ï¼šå•Ÿç”¨ AI æ™ºèƒ½è§£æ">
                            <button class="input-btn" id="toggleGeminiKey">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>

                <!-- Google OAuth -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ”</div>
                        <div>
                            <div class="card-title">Google OAuth</div>
                            <div class="card-subtitle">ç”¨æ–¼è‡ªå‹•åŒ¯å…¥æ—¥æ›†</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Client ID</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID">
                            <button class="input-btn" id="toggleGoogleId">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>

                <!-- LINE é€šçŸ¥ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ“±</div>
                        <div>
                            <div class="card-title">LINE é€šçŸ¥</div>
                            <div class="card-subtitle">ç ”ç¿’æé†’æ¨æ’­</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Channel Access Token</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="lineChannelAccessToken" placeholder="è¼¸å…¥ LINE Token">
                            <button class="input-btn" id="toggleLineToken">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">User ID</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="lineUserId" placeholder="è¼¸å…¥ LINE User ID">
                            <button class="input-btn" id="toggleLineUserId">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">GAS Web App URL</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="gasWebAppUrl" placeholder="è¼¸å…¥ GAS ç¶²å€">
                            <button class="input-btn" id="toggleGasUrl">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ğŸ” Secret Key</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="gasSecretKey" placeholder="è¼¸å…¥å®‰å…¨é‡‘é‘°">
                            <button class="input-btn" id="toggleGasSecret">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" id="testLineBtn">ğŸ“¤ ç™¼é€æ¸¬è©¦è¨Šæ¯</button>
                </div>

                <!-- æœ¬æ©Ÿå„²å­˜ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ’¾</div>
                        <div>
                            <div class="card-title">æœ¬æ©Ÿå„²å­˜</div>
                            <div class="card-subtitle">è‡ªå‹•è¨˜ä½è¨­å®š</div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <div>
                            <div class="toggle-title">å•Ÿç”¨æœ¬æ©Ÿå„²å­˜</div>
                            <div class="toggle-desc">API é‡‘é‘°å°‡å„²å­˜åœ¨æœ¬æ©Ÿ</div>
                        </div>
                        <div class="toggle-switch" id="localStorageToggle"></div>
                    </div>
                </div>

                <button class="btn btn-danger" id="clearAllBtn" style="margin-top: 20px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é </span>
            </button>
            <button class="nav-item" data-page="input">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">è¼¸å…¥</span>
            </button>
            <button class="nav-item" data-page="line">
                <span class="nav-icon">ğŸ“±</span>
                <span class="nav-label">LINE</span>
            </button>
            <button class="nav-item" data-page="settings">
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-label">è¨­å®š</span>
            </button>
        </nav>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“š å¹«åŠ©ä¸­å¿ƒ</div>
                <button class="modal-close" id="closeHelpBtn">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="accordion-item open">
                    <button class="accordion-header">
                        <span>ğŸš€ å¦‚ä½•é–‹å§‹ä½¿ç”¨ï¼Ÿ</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. é»æ“Šã€Œè¼¸å…¥ã€é é¢<br>
                        2. é¸æ“‡æ–‡å­—ã€æª”æ¡ˆæˆ–åœ–ç‰‡è¼¸å…¥<br>
                        3. è²¼ä¸Šæˆ–ä¸Šå‚³ç ”ç¿’è³‡è¨Š<br>
                        4. é»æ“Šã€ŒAI æ™ºèƒ½è§£æã€<br>
                        5. ç¢ºèªè§£æçµæœå¾ŒåŒ¯å…¥æ—¥æ›†
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>ğŸ”‘ Gemini API è¨­å®š</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. å‰å¾€ Google AI Studio<br>
                        2. é»æ“Šã€ŒGet API keyã€<br>
                        3. å»ºç«‹æˆ–é¸æ“‡å°ˆæ¡ˆ<br>
                        4. è¤‡è£½ API Key è²¼åˆ°è¨­å®šé é¢
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>ğŸ“± LINE é€šçŸ¥è¨­å®š</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. å‰å¾€ LINE Developers Console<br>
                        2. å»ºç«‹ Messaging API Channel<br>
                        3. å–å¾— Channel Access Token<br>
                        4. å–å¾—æ‚¨çš„ User ID<br>
                        5. éƒ¨ç½² Google Apps Script
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // å…¨åŸŸè®Šæ•¸
        // ========================================
        var parsedEvents = [];
        var uploadedFilesContentArray = [];
        var uploadedImagesArray = [];
        var activeInputTab = 'text';
        var localStorageEnabled = false;
        var STORAGE_PREFIX = 'workshop_mobile_';

        // ========================================
        // DOM Ready
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ App åˆå§‹åŒ–ä¸­...');
            initNavigation();
            initTabs();
            initButtons();
            initReminders();
            initUploads();
            initToggles();
            initModals();
            loadSettings();
            console.log('âœ… App åˆå§‹åŒ–å®Œæˆï¼');
        });

        // ========================================
        // å°èˆªåˆå§‹åŒ–
        // ========================================
        function initNavigation() {
            var navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    var page = this.getAttribute('data-page');
                    switchToPage(page);
                });
            });
        }

        function switchToPage(pageName) {
            // æ›´æ–°é é¢
            document.querySelectorAll('.page').forEach(function(page) {
                page.classList.remove('active');
            });
            var targetPage = document.getElementById('page-' + pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // æ›´æ–°å°èˆª
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) {
                    item.classList.add('active');
                }
            });

            // æ›´æ–° LINE ç‹€æ…‹
            if (pageName === 'line') {
                updateLineStatus();
            }

            console.log('ğŸ“„ åˆ‡æ›åˆ°é é¢:', pageName);
        }

        // ========================================
        // Tab åˆå§‹åŒ–
        // ========================================
        function initTabs() {
            var tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var tabId = this.id.replace('tab-', '');
                    switchInputTab(tabId);
                });
            });
        }

        function switchInputTab(tabName) {
            activeInputTab = tabName;
            
            document.querySelectorAll('.tabs .tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            var targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            var targetContent = document.getElementById('content-' + tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            console.log('ğŸ“‘ åˆ‡æ›åˆ° Tab:', tabName);
        }

        // ========================================
        // æŒ‰éˆ•åˆå§‹åŒ–
        // ========================================
        function initButtons() {
            // å¿«æ·æ“ä½œ
            document.getElementById('qa-text').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('text');
            });
            document.getElementById('qa-file').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('file');
            });
            document.getElementById('qa-image').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('image');
            });
            document.getElementById('qa-api').addEventListener('click', function() {
                switchToPage('settings');
            });

            // Header æŒ‰éˆ•
            document.getElementById('helpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.add('show');
            });
            document.getElementById('settingsBtn').addEventListener('click', function() {
                switchToPage('settings');
            });

            // è§£ææŒ‰éˆ•
            document.getElementById('parseBtn').addEventListener('click', parseSchedule);

            // åŒ¯å…¥æŒ‰éˆ•
            document.getElementById('importCalendarBtn').addEventListener('click', function() {
                showToast('ğŸ”— åŒ¯å…¥æ—¥æ›†åŠŸèƒ½ï¼ˆéœ€è¨­å®š Google OAuthï¼‰', 'info');
            });
            document.getElementById('downloadIcsBtn').addEventListener('click', downloadICS);

            // LINE é é¢æŒ‰éˆ•
            document.getElementById('viewSchedulesBtn').addEventListener('click', viewScheduledReminders);
            document.getElementById('clearSchedulesBtn').addEventListener('click', clearAllReminders);
            document.getElementById('goToSettingsBtn').addEventListener('click', function() {
                switchToPage('settings');
            });

            // è¨­å®šé é¢æŒ‰éˆ•
            document.getElementById('testLineBtn').addEventListener('click', testLineNotification);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);

            // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
            document.getElementById('toggleGeminiKey').addEventListener('click', function() {
                toggleVisibility('geminiApiKey');
            });
            document.getElementById('toggleGoogleId').addEventListener('click', function() {
                toggleVisibility('googleClientId');
            });
            document.getElementById('toggleLineToken').addEventListener('click', function() {
                toggleVisibility('lineChannelAccessToken');
            });
            document.getElementById('toggleLineUserId').addEventListener('click', function() {
                toggleVisibility('lineUserId');
            });
            document.getElementById('toggleGasUrl').addEventListener('click', function() {
                toggleVisibility('gasWebAppUrl');
            });
            document.getElementById('toggleGasSecret').addEventListener('click', function() {
                toggleVisibility('gasSecretKey');
            });

            console.log('ğŸ”˜ æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
        }

        // ========================================
        // æé†’é¸é …åˆå§‹åŒ–
        // ========================================
        function initReminders() {
            document.querySelectorAll('.reminder-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    var checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('checked', checkbox.checked);
                });
            });
        }

        // ========================================
        // ä¸Šå‚³åˆå§‹åŒ–
        // ========================================
        function initUploads() {
            // æª”æ¡ˆä¸Šå‚³ - ä½¿ç”¨ label forï¼Œä¸éœ€è¦é¡å¤–çš„ click handler
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

            // åœ–ç‰‡ä¸Šå‚³ - ä½¿ç”¨ label forï¼Œä¸éœ€è¦é¡å¤–çš„ click handler
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        // ========================================
        // Toggle åˆå§‹åŒ–
        // ========================================
        function initToggles() {
            document.getElementById('localStorageToggle').addEventListener('click', toggleLocalStorage);
        }

        // ========================================
        // Modal åˆå§‹åŒ–
        // ========================================
        function initModals() {
            // é—œé–‰å¹«åŠ©
            document.getElementById('closeHelpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.remove('show');
            });

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            document.getElementById('helpModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });

            // Accordion
            document.querySelectorAll('.accordion-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    this.parentElement.classList.toggle('open');
                });
            });
        }

        // ========================================
        // Toast æç¤º
        // ========================================
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || '');
            toast.classList.add('show');
            
            setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========================================
        // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
        // ========================================
        function toggleVisibility(inputId) {
            var input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // ========================================
        // æª”æ¡ˆä¸Šå‚³
        // ========================================
        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            showToast('ğŸ“„ æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

            var reader = new FileReader();
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        var workbook = XLSX.read(e.target.result, { type: 'binary' });
                        var content = '';
                        workbook.SheetNames.forEach(function(name) {
                            var sheet = workbook.Sheets[name];
                            content += XLSX.utils.sheet_to_csv(sheet) + '\n';
                        });
                        uploadedFilesContentArray.push({ name: file.name, content: content });
                        updateFileInfo(file.name);
                    } catch (err) {
                        showToast('âŒ Excel è®€å–å¤±æ•—', 'error');
                    }
                };
                reader.readAsBinaryString(file);
            } else {
                reader.onload = function(e) {
                    uploadedFilesContentArray.push({ name: file.name, content: e.target.result });
                    updateFileInfo(file.name);
                };
                reader.readAsText(file);
            }
        }

        function updateFileInfo(fileName) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileCount').textContent = uploadedFilesContentArray.length;
            showToast('âœ… æª”æ¡ˆå·²è¼‰å…¥ï¼š' + fileName, 'success');
        }

        // ========================================
        // åœ–ç‰‡ä¸Šå‚³
        // ========================================
        function handleImageUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            showToast('ğŸ“¸ æ­£åœ¨è®€å–åœ–ç‰‡...', 'info');

            var reader = new FileReader();
            reader.onload = function(e) {
                var base64 = e.target.result.split(',')[1];
                uploadedImagesArray.push(base64);
                
                var preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.add('show');
                
                showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        // ========================================
        // AI è§£æ
        // ========================================
        function parseSchedule() {
            var apiKey = document.getElementById('geminiApiKey').value.trim();
            var scheduleText = document.getElementById('scheduleText').value.trim();

            // é©—è­‰è¼¸å…¥
            if (activeInputTab === 'text' && !scheduleText) {
                showToast('âš ï¸ è«‹è¼¸å…¥ç ”ç¿’è³‡è¨Š', 'error');
                return;
            }
            if (activeInputTab === 'file' && uploadedFilesContentArray.length === 0) {
                showToast('âš ï¸ è«‹ä¸Šå‚³æª”æ¡ˆ', 'error');
                return;
            }
            if (activeInputTab === 'image' && uploadedImagesArray.length === 0) {
                showToast('âš ï¸ è«‹ä¸Šå‚³åœ–ç‰‡', 'error');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            document.getElementById('parseBtnText').style.display = 'none';
            document.getElementById('parseSpinner').style.display = 'block';
            showToast('ğŸ”„ æ­£åœ¨è§£æä¸­...', 'info');

            // æ¨¡æ“¬è§£æï¼ˆå¦‚æœæ²’æœ‰ API Key å°±ç”¨å…§å»ºè§£æï¼‰
            setTimeout(function() {
                var events;
                
                if (apiKey) {
                    // æœ‰ API Key å°±å˜—è©¦ç”¨ Gemini
                    parseWithGemini(apiKey, scheduleText);
                } else {
                    // æ²’æœ‰å°±ç”¨å…§å»ºè§£æ
                    events = parseWithBuiltIn(scheduleText);
                    handleParseResult(events);
                }
            }, 500);
        }

        function handleParseResult(events) {
            document.getElementById('parseBtnText').style.display = 'inline';
            document.getElementById('parseSpinner').style.display = 'none';

            if (events && events.length > 0) {
                parsedEvents = events;
                displayEvents(events);
                document.getElementById('eventsPreview').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
                document.getElementById('eventCount').textContent = events.length;
                showToast('âœ… è§£ææˆåŠŸï¼æ‰¾åˆ° ' + events.length + ' å€‹äº‹ä»¶', 'success');
            } else {
                showToast('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº‹ä»¶ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼', 'error');
            }
        }

        // ========================================
        // Gemini AI è§£æ
        // ========================================
        function parseWithGemini(apiKey, scheduleText) {
            var now = new Date();
            var currentYear = now.getFullYear();
            var currentMonth = now.getMonth() + 1;
            var currentDate = now.getDate();

            var prompt = 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„æ™‚ç¨‹è¡¨è§£æåŠ©æ‰‹ã€‚è«‹å°‡ä»¥ä¸‹ç ”ç¿’è³‡è¨Šè§£æç‚º JSON æ ¼å¼ã€‚\n\n';
            prompt += 'ä»Šå¤©æ˜¯ ' + currentYear + ' å¹´ ' + currentMonth + ' æœˆ ' + currentDate + ' æ—¥\n\n';
            prompt += 'è«‹è¼¸å‡ºä»¥ä¸‹ JSON æ ¼å¼ï¼ˆç´” JSONï¼Œä¸è¦ markdownï¼‰ï¼š\n';
            prompt += '{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°"}]}\n\n';
            prompt += 'è¦å‰‡ï¼š\n';
            prompt += '1. æ—¥æœŸæ ¼å¼å¿…é ˆæ˜¯ ISO 8601\n';
            prompt += '2. å¦‚æœæ²’æœ‰çµæŸæ™‚é–“ï¼Œé è¨­æ´»å‹• 3 å°æ™‚\n';
            prompt += '3. å¦‚æœåªæœ‰æ—¥æœŸæ²’æœ‰æ™‚é–“ï¼Œé è¨­ 09:00-12:00\n\n';

            var content = '';
            if (activeInputTab === 'text') {
                content = scheduleText;
            } else if (activeInputTab === 'file') {
                content = uploadedFilesContentArray.map(function(f) { return f.content; }).join('\n\n');
            }

            var requestBody = {
                contents: [{ parts: [{ text: prompt + 'æ™‚ç¨‹è¡¨å…§å®¹ï¼š\n' + content }] }],
                generationConfig: { temperature: 0.2 }
            };

            // åœ–ç‰‡è™•ç†
            if (activeInputTab === 'image' && uploadedImagesArray.length > 0) {
                var parts = [{ text: prompt + '\nè«‹è¾¨è­˜åœ–ç‰‡ä¸­çš„ç ”ç¿’è³‡è¨Šï¼š' }];
                uploadedImagesArray.forEach(function(img) {
                    parts.push({ inline_data: { mime_type: 'image/jpeg', data: img } });
                });
                requestBody = {
                    contents: [{ parts: parts }],
                    generationConfig: { temperature: 0.2 }
                };
            }

            fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.error) {
                    throw new Error(data.error.message);
                }
                var text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                var result = JSON.parse(text);
                handleParseResult(result.events || []);
            })
            .catch(function(error) {
                console.error('Gemini éŒ¯èª¤:', error);
                showToast('âŒ AI è§£æå¤±æ•—ï¼Œæ”¹ç”¨å…§å»ºè§£æ', 'error');
                var events = parseWithBuiltIn(scheduleText);
                handleParseResult(events);
            });
        }

        // ========================================
        // å…§å»ºè§£æå™¨
        // ========================================
        function parseWithBuiltIn(text) {
            if (!text) return [];
            
            var events = [];
            var lines = text.split('\n');
            var currentEvent = null;
            var now = new Date();

            var dateTimeRegex = /(\d{1,2})[\/\-](\d{1,2}).*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            var dateOnlyRegex = /(\d{1,2})[\/\-](\d{1,2})/;

            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return;

                var dateTimeMatch = line.match(dateTimeRegex);
                var dateOnlyMatch = line.match(dateOnlyRegex);

                if (dateTimeMatch) {
                    if (currentEvent && currentEvent.title) {
                        events.push(currentEvent);
                    }
                    
                    var month = parseInt(dateTimeMatch[1]);
                    var day = parseInt(dateTimeMatch[2]);
                    var startHour = parseInt(dateTimeMatch[3]);
                    var startMin = parseInt(dateTimeMatch[4]);
                    var endHour = parseInt(dateTimeMatch[5]);
                    var endMin = parseInt(dateTimeMatch[6]);
                    var year = now.getFullYear();

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(startHour).padStart(2, '0') + ':' + String(startMin).padStart(2, '0') + ':00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(endHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0') + ':00',
                        location: '',
                        description: ''
                    };
                } else if (dateOnlyMatch && !currentEvent) {
                    var month = parseInt(dateOnlyMatch[1]);
                    var day = parseInt(dateOnlyMatch[2]);
                    var year = now.getFullYear();

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T09:00:00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T12:00:00',
                        location: '',
                        description: ''
                    };
                } else if (currentEvent) {
                    if (line.includes('åœ°é»') || line.includes('å ´åœ°') || line.includes('Location')) {
                        currentEvent.location = line.replace(/åœ°é»[:ï¼š]?\s*/, '').replace(/å ´åœ°[:ï¼š]?\s*/, '').replace(/Location[:ï¼š]?\s*/i, '');
                    } else if (!currentEvent.title && line.length > 2) {
                        currentEvent.title = line;
                    } else if (currentEvent.title) {
                        currentEvent.description += line + '\n';
                    }
                }
            });

            if (currentEvent && currentEvent.title) {
                events.push(currentEvent);
            }

            return events;
        }

        // ========================================
        // é¡¯ç¤ºäº‹ä»¶
        // ========================================
        function displayEvents(events) {
            var container = document.getElementById('eventsPreview');
            var html = '';
            var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            events.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                var dayOfWeek = weekdays[startDate.getDay()];

                html += '<div class="event-item" id="event_' + index + '">';
                html += '<div class="event-title">' + (event.title || 'æœªå‘½åäº‹ä»¶') + '</div>';
                html += '<div class="event-meta">';
                html += '<div class="event-meta-item">ğŸ“… ' + formatDate(startDate) + '<span class="day-badge">é€±' + dayOfWeek + '</span></div>';
                html += '<div class="event-meta-item">â° ' + formatTime(startDate) + ' - ' + formatTime(endDate) + '</div>';
                if (event.location) {
                    html += '<div class="event-meta-item">ğŸ“ ' + event.location + '</div>';
                }
                html += '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
            document.getElementById('homeEventList').innerHTML = html || '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
        }

        function formatDate(date) {
            return date.getFullYear() + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + String(date.getDate()).padStart(2, '0');
        }

        function formatTime(date) {
            return String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
        }

        // ========================================
        // ICS ä¸‹è¼‰
        // ========================================
        function downloadICS() {
            if (parsedEvents.length === 0) {
                showToast('âŒ æ²’æœ‰å¯åŒ¯å‡ºçš„äº‹ä»¶', 'error');
                return;
            }

            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(input) {
                reminders.push(parseInt(input.value));
            });

            var icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Workshop Mobile//EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n';

            parsedEvents.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                var now = new Date();
                var uid = 'workshop-' + index + '-' + Date.now() + '@mobile';

                icsContent += 'BEGIN:VEVENT\n';
                icsContent += 'UID:' + uid + '\n';
                icsContent += 'DTSTAMP:' + formatICSDate(now) + '\n';
                icsContent += 'DTSTART:' + formatICSDate(startDate) + '\n';
                icsContent += 'DTEND:' + formatICSDate(endDate) + '\n';
                icsContent += 'SUMMARY:' + escapeICS(event.title) + '\n';
                if (event.location) icsContent += 'LOCATION:' + escapeICS(event.location) + '\n';
                if (event.description) icsContent += 'DESCRIPTION:' + escapeICS(event.description) + '\n';
                
                reminders.forEach(function(mins) {
                    icsContent += 'BEGIN:VALARM\nTRIGGER:-PT' + mins + 'M\nACTION:DISPLAY\nDESCRIPTION:ç ”ç¿’æé†’\nEND:VALARM\n';
                });

                icsContent += 'END:VEVENT\n';
            });

            icsContent += 'END:VCALENDAR';

            var blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ç ”ç¿’è¡Œäº‹æ›†_' + formatDate(new Date()).replace(/\//g, '') + '.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('âœ… ICS æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
        }

        function formatICSDate(date) {
            return date.getFullYear() +
                String(date.getMonth() + 1).padStart(2, '0') +
                String(date.getDate()).padStart(2, '0') + 'T' +
                String(date.getHours()).padStart(2, '0') +
                String(date.getMinutes()).padStart(2, '0') +
                String(date.getSeconds()).padStart(2, '0');
        }

        function escapeICS(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
        }

        // ========================================
        // LINE åŠŸèƒ½
        // ========================================
        function updateLineStatus() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            updateStatus('token', token);
            updateStatus('userId', userId);
            updateStatus('gas', gasUrl);
            updateStatus('secret', gasSecret);
        }

        function updateStatus(name, value) {
            var statusEl = document.getElementById(name + 'Status');
            var iconEl = document.getElementById(name + 'Icon');
            
            if (value) {
                statusEl.textContent = 'å·²è¨­å®š (' + value.substring(0, 8) + '...)';
                iconEl.textContent = 'âœ…';
            } else {
                statusEl.textContent = 'æœªè¨­å®š';
                iconEl.textContent = 'âŒ';
            }
        }

        function testLineNotification() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            if (!token || !userId || !gasUrl || !gasSecret) {
                showToast('âš ï¸ è«‹å…ˆå¡«å¯«å®Œæ•´çš„ LINE è¨­å®š', 'error');
                return;
            }

            showToast('ğŸ“¨ æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...', 'info');

            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);

            var testData = {
                secret: gasSecret,
                token: token,
                userId: userId,
                workshops: [{
                    title: 'ğŸ“š æ¸¬è©¦ç ”ç¿’ - åŠŸèƒ½æ¸¬è©¦',
                    startDateTime: tomorrow.toISOString(),
                    endDateTime: new Date(tomorrow.getTime() + 3 * 60 * 60 * 1000).toISOString(),
                    location: 'æ¸¬è©¦åœ°é»',
                    description: 'é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥'
                }]
            };

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(testData)
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    showToast('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æŸ¥çœ‹ LINE', 'success');
                } else {
                    showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(function(error) {
                showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + error.message, 'error');
            });
        }

        function viewScheduledReminders() {
            showToast('ğŸ“‹ æŸ¥çœ‹æ’ç¨‹åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        function clearAllReminders() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’ç¨‹å—ï¼Ÿ')) return;
            showToast('ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        // ========================================
        // æœ¬æ©Ÿå„²å­˜
        // ========================================
        function toggleLocalStorage() {
            var toggle = document.getElementById('localStorageToggle');
            
            if (toggle.classList.contains('active')) {
                if (confirm('ç¢ºå®šè¦åœç”¨æœ¬æ©Ÿå„²å­˜å—ï¼Ÿ')) {
                    toggle.classList.remove('active');
                    localStorageEnabled = false;
                    localStorage.removeItem(STORAGE_PREFIX + 'enabled');
                    showToast('âœ… å·²åœç”¨æœ¬æ©Ÿå„²å­˜', 'success');
                }
            } else {
                if (confirm('âš ï¸ å•Ÿç”¨å¾Œè¨­å®šæœƒå­˜åœ¨æœ¬æ©Ÿï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    toggle.classList.add('active');
                    localStorageEnabled = true;
                    localStorage.setItem(STORAGE_PREFIX + 'enabled', 'true');
                    saveSettings();
                    showToast('âœ… å·²å•Ÿç”¨æœ¬æ©Ÿå„²å­˜', 'success');
                }
            }
        }

        function saveSettings() {
            if (!localStorageEnabled) return;
            
            try {
                localStorage.setItem(STORAGE_PREFIX + 'geminiApiKey', document.getElementById('geminiApiKey').value);
                localStorage.setItem(STORAGE_PREFIX + 'googleClientId', document.getElementById('googleClientId').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineToken', document.getElementById('lineChannelAccessToken').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineUserId', document.getElementById('lineUserId').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasUrl', document.getElementById('gasWebAppUrl').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasSecret', document.getElementById('gasSecretKey').value);
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }

        function loadSettings() {
            try {
                if (localStorage.getItem(STORAGE_PREFIX + 'enabled') === 'true') {
                    localStorageEnabled = true;
                    document.getElementById('localStorageToggle').classList.add('active');
                    
                    var geminiKey = localStorage.getItem(STORAGE_PREFIX + 'geminiApiKey');
                    var googleId = localStorage.getItem(STORAGE_PREFIX + 'googleClientId');
                    var lineToken = localStorage.getItem(STORAGE_PREFIX + 'lineToken');
                    var lineUserId = localStorage.getItem(STORAGE_PREFIX + 'lineUserId');
                    var gasUrl = localStorage.getItem(STORAGE_PREFIX + 'gasUrl');
                    var gasSecret = localStorage.getItem(STORAGE_PREFIX + 'gasSecret');

                    if (geminiKey) document.getElementById('geminiApiKey').value = geminiKey;
                    if (googleId) document.getElementById('googleClientId').value = googleId;
                    if (lineToken) document.getElementById('lineChannelAccessToken').value = lineToken;
                    if (lineUserId) document.getElementById('lineUserId').value = lineUserId;
                    if (gasUrl) document.getElementById('gasWebAppUrl').value = gasUrl;
                    if (gasSecret) document.getElementById('gasSecretKey').value = gasSecret;

                    console.log('âœ… å·²è¼‰å…¥å„²å­˜çš„è¨­å®š');
                }
            } catch (e) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
            }
        }

        function clearAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;

            try {
                Object.keys(localStorage).forEach(function(key) {
                    if (key.startsWith(STORAGE_PREFIX)) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {}

            document.getElementById('geminiApiKey').value = '';
            document.getElementById('googleClientId').value = '';
            document.getElementById('lineChannelAccessToken').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('gasWebAppUrl').value = '';
            document.getElementById('gasSecretKey').value = '';
            document.getElementById('scheduleText').value = '';
            document.getElementById('localStorageToggle').classList.remove('active');
            localStorageEnabled = false;
            parsedEvents = [];
            uploadedFilesContentArray = [];
            uploadedImagesArray = [];
            document.getElementById('eventsPreview').innerHTML = '';
            document.getElementById('eventsPreview').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('fileCount').textContent = '0';

            showToast('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
        }

        // è‡ªå‹•å„²å­˜è¨­å®š
        document.querySelectorAll('.input-field').forEach(function(input) {
            input.addEventListener('change', function() {
                if (localStorageEnabled) {
                    saveSettings();
                }
            });
        });
    </script>
</body>
</html>
