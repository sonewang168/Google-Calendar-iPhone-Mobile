<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>è¡Œç¨‹æ—¥æ›†åŠ©æ‰‹ Mobile v3.2</title>
    
    <!-- å¤–éƒ¨å‡½å¼åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <!-- Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.3);
            --purple: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.3);
            --emerald: #10b981;
            --emerald-glow: rgba(16, 185, 129, 0.3);
            --orange: #f59e0b;
            --red: #ef4444;
            --gold: #fbbf24;
            --text-light: #e2e8f0;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --nav-height: 70px;
            --header-height: 60px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        .app-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding-top: env(safe-area-inset-top, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        /* Header */
        .app-header {
            height: var(--header-height);
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .app-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Main Content */
        .app-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: calc(var(--nav-height) + 20px);
            display: none;
            -webkit-overflow-scrolling: touch;
        }

        .page.active {
            display: block;
        }

        /* Bottom Nav */
        .bottom-nav {
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            flex-shrink: 0;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            padding: 8px 0;
            position: relative;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: var(--cyan);
            border-radius: 0 0 3px 3px;
            transition: width 0.3s;
        }

        .nav-item.active {
            color: var(--cyan);
        }

        .nav-item.active::before {
            width: 30px;
        }

        .nav-icon {
            font-size: 1.5em;
        }

        .nav-label {
            font-size: 0.75em;
            font-weight: 500;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .card-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
        }

        .card-icon.cyan { background: var(--cyan-glow); }
        .card-icon.purple { background: var(--purple-glow); }
        .card-icon.emerald { background: var(--emerald-glow); }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        .card-subtitle {
            font-size: 0.85em;
            color: var(--text-dim);
        }

        /* Stats */
        .stats-row {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-card);
            border-radius: 14px;
            padding: 16px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: var(--cyan);
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .quick-action {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .quick-action:active {
            transform: scale(0.98);
            background: var(--bg-card-hover);
        }

        .quick-action-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .quick-action-text {
            font-size: 0.9em;
            font-weight: 500;
        }

        /* Input */
        .input-group {
            margin-bottom: 16px;
        }

        .input-label {
            display: block;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .input-field {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-light);
            font-size: 1em;
            -webkit-appearance: none;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--cyan);
        }

        .input-field::placeholder {
            color: var(--text-muted);
        }

        textarea.input-field {
            min-height: 150px;
            resize: vertical;
            line-height: 1.6;
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-row .input-field {
            flex: 1;
        }

        .input-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: var(--bg-card-hover);
            border-radius: 12px;
            color: var(--text-dim);
            font-size: 1.2em;
            flex-shrink: 0;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-size: 1.05em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--cyan);
            color: var(--cyan);
        }

        .btn-danger {
            background: var(--red);
            color: white;
        }

        .btn.authorized {
            background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%);
            color: white;
            cursor: default;
        }

        .btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-sm {
            padding: 12px 16px;
            font-size: 0.95em;
        }

        .action-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .action-row .btn {
            flex: 1;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            background: var(--bg-dark);
            padding: 6px;
            border-radius: 12px;
        }

        .tab {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.9em;
            font-weight: 500;
            border-radius: 8px;
        }

        .tab.active {
            background: var(--cyan);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 30px 20px;
            text-align: center;
            background: rgba(6, 182, 212, 0.05);
        }

        .upload-area:active {
            border-color: var(--cyan);
            background: rgba(6, 182, 212, 0.1);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 12px;
        }

        .upload-text {
            font-size: 1em;
            font-weight: 500;
            color: var(--cyan);
        }

        .upload-hint {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Reminders */
        .reminder-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .reminder-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px;
            background: var(--bg-dark);
            border: 2px solid var(--border);
            border-radius: 12px;
        }

        .reminder-option.checked {
            border-color: var(--cyan);
            background: var(--cyan-glow);
        }

        .reminder-option input {
            display: none;
        }

        .reminder-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: transparent;
        }

        .reminder-option.checked .reminder-checkbox {
            background: var(--cyan);
            border-color: var(--cyan);
            color: white;
        }

        .reminder-label {
            font-size: 0.95em;
        }

        /* Events */
        .event-list {
            margin-top: 20px;
        }

        .event-item {
            background: var(--bg-dark);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            border-left: 4px solid var(--cyan);
        }

        .event-title {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .event-meta {
            font-size: 0.9em;
            color: var(--text-dim);
        }

        .event-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .day-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%);
            color: white;
            padding: 2px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            margin-left: 8px;
        }

        .event-item.deleted {
            opacity: 0.4;
            text-decoration: line-through;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .empty-icon {
            font-size: 3em;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: calc(var(--nav-height) + 20px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-light);
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: calc(100% - 40px);
            text-align: center;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { border-color: var(--emerald); background: rgba(16, 185, 129, 0.2); }
        .toast.error { border-color: var(--red); background: rgba(239, 68, 68, 0.2); }
        .toast.info { border-color: var(--cyan); background: rgba(6, 182, 212, 0.2); }

        /* Spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: flex-end;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            width: 100%;
            max-height: 85vh;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--bg-dark);
            color: var(--text-dim);
            border-radius: 10px;
            font-size: 1.2em;
        }

        .modal-body {
            padding: 20px;
            max-height: calc(85vh - 80px);
            overflow-y: auto;
        }

        /* Toggle */
        .toggle-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-row:last-child {
            border-bottom: none;
        }

        .toggle-title {
            font-weight: 500;
        }

        .toggle-desc {
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .toggle-switch {
            width: 52px;
            height: 30px;
            background: var(--border);
            border-radius: 15px;
            position: relative;
            transition: all 0.3s;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: var(--cyan);
        }

        .toggle-switch.active::after {
            left: 25px;
        }

        /* Image Preview */
        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 12px;
            margin-top: 12px;
            display: none;
        }

        .image-preview.show {
            display: block;
        }

        /* File Badge */
        .file-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--emerald-glow);
            border: 1px solid var(--emerald);
            color: var(--emerald);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.9em;
            margin-top: 12px;
        }

        /* Help Accordion */
        .accordion-item {
            background: var(--bg-dark);
            border-radius: 12px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .accordion-header {
            width: 100%;
            padding: 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            font-size: 1em;
            font-weight: 500;
            text-align: left;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .accordion-body {
            display: none;
            padding: 0 16px 16px;
            color: var(--text-dim);
            font-size: 0.9em;
            line-height: 1.7;
        }

        .accordion-item.open .accordion-body {
            display: block;
        }

        .accordion-icon {
            transition: transform 0.3s;
        }

        .accordion-item.open .accordion-icon {
            transform: rotate(180deg);
        }

        /* ============================================
           ğŸŒŸ å†·å…‰ç§‘æŠ€é¢¨é–‹æ©Ÿå‹•ç•« Splash Screen
           ============================================ */
        .splash-screen {
            position: fixed;
            inset: 0;
            background: radial-gradient(ellipse at center, #0a1628 0%, #050d1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            overflow: hidden;
            transition: opacity 0.8s ease, visibility 0.8s ease;
        }

        .splash-screen.hide {
            opacity: 0;
            visibility: hidden;
        }

        /* èƒŒæ™¯ç§‘æŠ€ç¶²æ ¼ */
        .splash-grid {
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(6, 182, 212, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(6, 182, 212, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: gridPulse 3s ease-in-out infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.7; }
        }

        /* å…­é‚Šå½¢èƒŒæ™¯è£é£¾ */
        .hex-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background: 
                radial-gradient(circle at 20% 30%, var(--cyan) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, var(--purple) 0%, transparent 40%);
            animation: hexFloat 8s ease-in-out infinite;
        }

        @keyframes hexFloat {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(5deg); }
        }

        /* é£„æµ®ç²’å­ */
        .splash-particles {
            position: absolute;
            inset: 0;
            overflow: hidden;
        }

        .splash-particle {
            position: absolute;
            width: 3px;
            height: 3px;
            background: var(--cyan);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--cyan), 0 0 20px var(--cyan);
            animation: particleRise 5s ease-in-out infinite;
        }

        .splash-particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .splash-particle:nth-child(2) { left: 20%; animation-delay: 0.8s; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .splash-particle:nth-child(3) { left: 30%; animation-delay: 1.6s; }
        .splash-particle:nth-child(4) { left: 40%; animation-delay: 0.4s; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }
        .splash-particle:nth-child(5) { left: 50%; animation-delay: 1.2s; }
        .splash-particle:nth-child(6) { left: 60%; animation-delay: 2s; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .splash-particle:nth-child(7) { left: 70%; animation-delay: 0.6s; }
        .splash-particle:nth-child(8) { left: 80%; animation-delay: 1.4s; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }
        .splash-particle:nth-child(9) { left: 90%; animation-delay: 2.2s; }

        @keyframes particleRise {
            0% { transform: translateY(100vh) scale(0); opacity: 0; }
            10% { opacity: 1; transform: scale(1); }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
        }

        /* Logo å®¹å™¨ */
        .splash-logo-container {
            position: relative;
            width: 160px;
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        /* å¤–å±¤æ—‹è½‰ç’° - å†·å…‰æ•ˆæœ */
        .splash-ring {
            position: absolute;
            border: 2px solid transparent;
            border-radius: 50%;
            animation: ringRotate linear infinite;
        }

        .splash-ring-1 {
            width: 160px;
            height: 160px;
            border-top-color: var(--cyan);
            border-right-color: var(--cyan);
            animation-duration: 3s;
            filter: drop-shadow(0 0 8px var(--cyan));
        }

        .splash-ring-2 {
            width: 130px;
            height: 130px;
            border-bottom-color: var(--purple);
            border-left-color: var(--purple);
            animation-duration: 2.5s;
            animation-direction: reverse;
            filter: drop-shadow(0 0 8px var(--purple));
        }

        .splash-ring-3 {
            width: 100px;
            height: 100px;
            border-top-color: var(--emerald);
            animation-duration: 2s;
            filter: drop-shadow(0 0 8px var(--emerald));
        }

        @keyframes ringRotate {
            to { transform: rotate(360deg); }
        }

        /* ä¸­å¿ƒ Logo - å†·å…‰ç§‘æŠ€é¢¨ */
        .splash-logo-inner {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%);
            border: 2px solid var(--cyan);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: logoSpin 2s ease-in-out, logoPulse 2s ease-in-out infinite 2s;
            box-shadow: 
                0 0 30px rgba(6, 182, 212, 0.5),
                inset 0 0 20px rgba(6, 182, 212, 0.1);
            z-index: 10;
        }

        @keyframes logoSpin {
            0% { transform: rotateY(0deg) scale(0.3); opacity: 0; }
            50% { transform: rotateY(180deg) scale(1.1); }
            100% { transform: rotateY(360deg) scale(1); opacity: 1; }
        }

        @keyframes logoPulse {
            0%, 100% { 
                box-shadow: 0 0 30px rgba(6, 182, 212, 0.5), inset 0 0 20px rgba(6, 182, 212, 0.1); 
                border-color: var(--cyan);
            }
            50% { 
                box-shadow: 0 0 50px rgba(6, 182, 212, 0.8), 0 0 80px rgba(168, 85, 247, 0.4), inset 0 0 30px rgba(6, 182, 212, 0.2); 
                border-color: var(--purple);
            }
        }

        /* è»Œé“ç²’å­ */
        .orbit-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--cyan);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--cyan);
        }

        .orbit-particle:nth-child(1) { animation: orbit1 3s linear infinite; }
        .orbit-particle:nth-child(2) { animation: orbit2 2.5s linear infinite; background: var(--purple); box-shadow: 0 0 10px var(--purple); }
        .orbit-particle:nth-child(3) { animation: orbit3 2s linear infinite; background: var(--emerald); box-shadow: 0 0 10px var(--emerald); }

        @keyframes orbit1 {
            0% { transform: rotate(0deg) translateX(80px) rotate(0deg); }
            100% { transform: rotate(360deg) translateX(80px) rotate(-360deg); }
        }
        @keyframes orbit2 {
            0% { transform: rotate(120deg) translateX(65px) rotate(-120deg); }
            100% { transform: rotate(480deg) translateX(65px) rotate(-480deg); }
        }
        @keyframes orbit3 {
            0% { transform: rotate(240deg) translateX(50px) rotate(-240deg); }
            100% { transform: rotate(600deg) translateX(50px) rotate(-600deg); }
        }

        /* æ¨™é¡Œæ–‡å­— - å†·å…‰æ•ˆæœ */
        .splash-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--cyan);
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.8);
            opacity: 0;
            animation: textFadeUp 0.8s ease forwards 1s;
            text-align: center;
            letter-spacing: 2px;
        }

        .splash-subtitle {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
            opacity: 0;
            animation: textFadeUp 0.8s ease forwards 1.3s;
            letter-spacing: 4px;
        }

        .splash-version {
            font-size: 10px;
            color: var(--purple);
            margin-top: 6px;
            opacity: 0;
            animation: textFadeUp 0.8s ease forwards 1.5s;
        }

        @keyframes textFadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* è¼‰å…¥é€²åº¦æ¢ - å†·å…‰é¢¨æ ¼ */
        .splash-progress {
            width: 180px;
            height: 3px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 2px;
            margin-top: 35px;
            overflow: hidden;
            opacity: 0;
            animation: textFadeUp 0.8s ease forwards 1.7s;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .splash-progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--cyan), var(--purple), var(--emerald));
            border-radius: 2px;
            animation: progressFill 2s ease forwards 1.9s;
            box-shadow: 0 0 10px var(--cyan);
        }

        @keyframes progressFill {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* è¼‰å…¥ç‹€æ…‹æ–‡å­— */
        .splash-status {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 15px;
            opacity: 0;
            animation: textFadeUp 0.8s ease forwards 2s, statusBlink 1s ease-in-out infinite 2s;
        }

        @keyframes statusBlink {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* æƒæç·šæ•ˆæœ */
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--cyan), transparent);
            top: 0;
            animation: scanMove 3s linear infinite;
            opacity: 0.3;
        }

        @keyframes scanMove {
            0% { top: 0; }
            100% { top: 100%; }
        }
    </style>
</head>
<body>
    <!-- ğŸŒŸ å†·å…‰ç§‘æŠ€é¢¨é–‹æ©Ÿå‹•ç•« -->
    <div class="splash-screen" id="splashScreen">
        <div class="splash-grid"></div>
        <div class="hex-bg"></div>
        <div class="scan-line"></div>
        <div class="splash-particles">
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
            <div class="splash-particle"></div>
        </div>
        <div class="splash-logo-container">
            <div class="splash-ring splash-ring-1"></div>
            <div class="splash-ring splash-ring-2"></div>
            <div class="splash-ring splash-ring-3"></div>
            <div class="splash-logo-inner">ğŸ“…</div>
            <div class="orbit-particle"></div>
            <div class="orbit-particle"></div>
            <div class="orbit-particle"></div>
        </div>
        <div class="splash-title">è¡Œç¨‹æ—¥æ›†åŠ©æ‰‹</div>
        <div class="splash-subtitle">SCHEDULE CALENDAR</div>
        <div class="splash-version">Mobile v3.0</div>
        <div class="splash-progress">
            <div class="splash-progress-bar"></div>
        </div>
        <div class="splash-status">INITIALIZING SYSTEM...</div>
    </div>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo">
                <span>ğŸ“…</span>
                <span>è¡Œç¨‹åŠ©æ‰‹</span>
            </div>
            <div class="header-actions">
                <button class="header-btn" id="helpBtn">â“</button>
                <button class="header-btn" id="settingsBtn">âš™ï¸</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-content">
            <!-- é¦–é  -->
            <div class="page active" id="page-home">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">å¾…åŒ¯å…¥äº‹ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="fileCount">0</div>
                        <div class="stat-label">å·²ä¸Šå‚³æª”æ¡ˆ</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action" id="qa-text">
                        <div class="quick-action-icon">âœï¸</div>
                        <div class="quick-action-text">æ–‡å­—è¼¸å…¥</div>
                    </div>
                    <div class="quick-action" id="qa-file">
                        <div class="quick-action-icon">ğŸ“„</div>
                        <div class="quick-action-text">ä¸Šå‚³æª”æ¡ˆ</div>
                    </div>
                    <div class="quick-action" id="qa-image">
                        <div class="quick-action-icon">ğŸ“¸</div>
                        <div class="quick-action-text">æ‹ç…§è¾¨è­˜</div>
                    </div>
                    <div class="quick-action" id="qa-api">
                        <div class="quick-action-icon">ğŸ”‘</div>
                        <div class="quick-action-text">API è¨­å®š</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“‹</div>
                        <div>
                            <div class="card-title">å¾…è™•ç†äº‹ä»¶</div>
                            <div class="card-subtitle">è§£æå®Œæˆå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                        </div>
                    </div>
                    <div id="homeEventList">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¼¸å…¥é  -->
            <div class="page" id="page-input">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ“</div>
                        <div>
                            <div class="card-title">è¼¸å…¥æ´»å‹•è³‡è¨Š</div>
                            <div class="card-subtitle">é¸æ“‡è¼¸å…¥æ–¹å¼</div>
                        </div>
                    </div>

                    <div class="tabs">
                        <button class="tab active" id="tab-text">âœï¸ æ–‡å­—</button>
                        <button class="tab" id="tab-file">ğŸ“„ æª”æ¡ˆ</button>
                        <button class="tab" id="tab-image">ğŸ“¸ åœ–ç‰‡</button>
                    </div>

                    <!-- æ–‡å­—è¼¸å…¥ -->
                    <div class="tab-content active" id="content-text">
                        <div class="input-group">
                            <label class="input-label">è²¼ä¸Šæ´»å‹•æ™‚ç¨‹è¡¨ <span style="color: var(--cyan); font-size: 0.85em;">ï¼ˆæ”¯æ´ç ”ç¿’/ç•¢æ—…/æ´»å‹•ï¼‰</span></label>
                            <textarea class="input-field" id="scheduleText" placeholder="ç¯„ä¾‹ 1 - ç ”ç¿’ï¼š
114å¹´12æœˆ25æ—¥ï¼ˆä¸‰ï¼‰14:00-16:00
AI æ•™å­¸æ‡‰ç”¨å·¥ä½œåŠ
åœ°é»ï¼šç·šä¸Š Google Meet

ç¯„ä¾‹ 2 - ç•¢æ¥­æ—…è¡Œï¼š
ç¬¬ä¸€å¤© 12/20ï¼ˆäº”ï¼‰
07:30 å­¸æ ¡é›†åˆå‡ºç™¼
12:00 æŠµé”ä¹æ—æ–‡åŒ–æ‘
18:00 é£¯åº— Check-in

ğŸ’¡ æ”¯æ´ï¼šç ”ç¿’ã€ç•¢æ—…ã€æ ¡å¤–æ•™å­¸ã€æ´»å‹•è¡Œç¨‹"></textarea>
                            <button class="btn btn-outline btn-sm" onclick="clearScheduleText()" style="margin-top: 10px;">ğŸ—‘ï¸ æ¸…é™¤æ–‡å­—</button>
                        </div>
                    </div>

                    <!-- æª”æ¡ˆä¸Šå‚³ -->
                    <div class="tab-content" id="content-file">
                        <div class="upload-area" id="fileUploadArea">
                            <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.txt,.pdf">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">é»æ“Šä¸Šå‚³æª”æ¡ˆ</div>
                            <div class="upload-hint">æ”¯æ´ Excelã€TXTã€CSVã€PDF</div>
                        </div>
                        <div id="fileInfo" style="display: none;">
                            <div class="file-badge">
                                <span>âœ…</span>
                                <span id="fileName">æª”æ¡ˆå·²è¼‰å…¥</span>
                            </div>
                        </div>
                    </div>

                    <!-- åœ–ç‰‡ä¸Šå‚³ -->
                    <div class="tab-content" id="content-image">
                        <div class="upload-area" id="imageUploadArea">
                            <input type="file" id="imageUpload" accept="image/*">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">æ‹ç…§æˆ–é¸æ“‡åœ–ç‰‡</div>
                            <div class="upload-hint">AI OCR æ™ºèƒ½è¾¨è­˜è¡Œç¨‹è¡¨</div>
                        </div>
                        <div class="ocr-tips" style="margin-top: 12px; padding: 12px; background: rgba(6, 182, 212, 0.1); border-radius: 12px; font-size: 0.85em; color: var(--text-dim);">
                            <div style="margin-bottom: 6px; color: var(--cyan);">ğŸ“¸ OCR è¾¨è­˜æ”¯æ´ï¼š</div>
                            <div>â€¢ ç ”ç¿’é€šçŸ¥ã€å…¬æ–‡</div>
                            <div>â€¢ ç•¢æ¥­æ—…è¡Œè¡Œç¨‹è¡¨</div>
                            <div>â€¢ æ ¡å¤–æ•™å­¸é€šçŸ¥å–®</div>
                            <div>â€¢ å„ç¨®æ´»å‹•æ™‚ç¨‹è¡¨</div>
                        </div>
                        <img id="imagePreview" class="image-preview">
                    </div>
                </div>

                <!-- æé†’è¨­å®š -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">â°</div>
                        <div>
                            <div class="card-title">æé†’è¨­å®š</div>
                            <div class="card-subtitle">é¸æ“‡äº‹ä»¶æé†’æ™‚é–“</div>
                        </div>
                    </div>
                    <div class="reminder-grid" id="reminderGrid">
                        <label class="reminder-option" data-value="30">
                            <input type="checkbox" value="30">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">30 åˆ†é˜å‰</span>
                        </label>
                        <label class="reminder-option checked" data-value="60">
                            <input type="checkbox" value="60" checked>
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">1 å°æ™‚å‰</span>
                        </label>
                        <label class="reminder-option" data-value="120">
                            <input type="checkbox" value="120">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">2 å°æ™‚å‰</span>
                        </label>
                        <label class="reminder-option" data-value="1440">
                            <input type="checkbox" value="1440">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">1 å¤©å‰</span>
                        </label>
                    </div>
                </div>

                <!-- è§£ææŒ‰éˆ• -->
                <button class="btn btn-primary" id="parseBtn">
                    <span id="parseBtnText">ğŸš€ AI æ™ºèƒ½è§£æ</span>
                    <div class="spinner" id="parseSpinner"></div>
                </button>

                <!-- è§£æçµæœ -->
                <div id="eventsPreview" class="event-list" style="display: none;"></div>

                <!-- åŒ¯å…¥æŒ‰éˆ• -->
                <div class="action-row" id="importActions" style="display: none;">
                    <button class="btn btn-secondary" id="importCalendarBtn">ğŸ”— åŒ¯å…¥æ—¥æ›†</button>
                    <button class="btn btn-outline" id="downloadIcsBtn">ğŸ“¥ ä¸‹è¼‰ ICS</button>
                </div>
            </div>

            <!-- LINE é  -->
            <div class="page" id="page-line">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ””</div>
                        <div>
                            <div class="card-title">LINE æé†’æ’ç¨‹</div>
                            <div class="card-subtitle">ç ”ç¿’è‡ªå‹•æé†’è¨­å®š</div>
                        </div>
                    </div>

                    <div class="reminder-grid" id="lineReminderGrid">
                        <label class="reminder-option" data-value="1440">
                            <input type="checkbox" id="reminder1Day" value="1440">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 1 å¤©</span>
                        </label>
                        <label class="reminder-option" data-value="120">
                            <input type="checkbox" id="reminder2Hours" value="120">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 2 å°æ™‚</span>
                        </label>
                        <label class="reminder-option checked" data-value="60">
                            <input type="checkbox" id="reminder1Hour" value="60" checked>
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 1 å°æ™‚</span>
                        </label>
                        <label class="reminder-option" data-value="30">
                            <input type="checkbox" id="reminder30Min" value="30">
                            <div class="reminder-checkbox">âœ“</div>
                            <span class="reminder-label">å‰ 30 åˆ†é˜</span>
                        </label>
                    </div>

                    <div class="action-row">
                        <button class="btn btn-outline btn-sm" id="viewSchedulesBtn">ğŸ“‹ æŸ¥çœ‹æ’ç¨‹</button>
                        <button class="btn btn-danger btn-sm" id="clearSchedulesBtn">ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“Š</div>
                        <div>
                            <div class="card-title">è¨­å®šç‹€æ…‹</div>
                            <div class="card-subtitle">LINE é€šçŸ¥è¨­å®šæª¢æŸ¥</div>
                        </div>
                    </div>
                    <div id="lineStatusList">
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">Channel Token</div>
                                <div class="toggle-desc" id="tokenStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="tokenIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">User ID</div>
                                <div class="toggle-desc" id="userIdStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="userIdIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">GAS URL</div>
                                <div class="toggle-desc" id="gasStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="gasIcon">âŒ</span>
                        </div>
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-title">Secret Key</div>
                                <div class="toggle-desc" id="secretStatus">æœªè¨­å®š</div>
                            </div>
                            <span id="secretIcon">âŒ</span>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="goToSettingsBtn" style="margin-top: 16px;">âš™ï¸ å‰å¾€è¨­å®š</button>
                </div>
            </div>

            <!-- è¨­å®šé  -->
            <div class="page" id="page-settings">
                <!-- Gemini API -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ¤–</div>
                        <div>
                            <div class="card-title">Gemini API</div>
                            <div class="card-subtitle">AI æ™ºèƒ½è§£æï¼ˆé¸å¡«ï¼‰</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="geminiApiKey" placeholder="é¸å¡«ï¼šå•Ÿç”¨ AI æ™ºèƒ½è§£æ">
                            <button class="input-btn" id="toggleGeminiKey">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>

                <!-- Google OAuth -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ”</div>
                        <div>
                            <div class="card-title">Google OAuth</div>
                            <div class="card-subtitle">ç”¨æ–¼è‡ªå‹•åŒ¯å…¥æ—¥æ›†ï¼ˆæˆæ¬Šä¿ç•™24å°æ™‚ï¼‰</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Client ID</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID">
                            <button class="input-btn" id="toggleGoogleId">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="action-row" style="margin-top: 12px;">
                        <button class="btn btn-primary btn-sm" id="googleAuthBtn" onclick="handleGoogleAuth()">ğŸ”‘ æˆæ¬Š Google</button>
                        <button class="btn btn-outline btn-sm" onclick="handleGoogleSignOut()">ğŸšª ç™»å‡º</button>
                    </div>
                    <div id="googleAuthStatus" style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted);">
                        âŒ æœªæˆæ¬Š
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="showApiDiagnostics()" style="margin-top: 12px;">ğŸ” API è¨ºæ–·</button>
                </div>

                <!-- LINE é€šçŸ¥ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ“±</div>
                        <div>
                            <div class="card-title">LINE é€šçŸ¥</div>
                            <div class="card-subtitle">ç ”ç¿’æé†’æ¨æ’­</div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Channel Access Token</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="lineChannelAccessToken" placeholder="è¼¸å…¥ LINE Token">
                            <button class="input-btn" id="toggleLineToken">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">User ID</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="lineUserId" placeholder="è¼¸å…¥ LINE User ID">
                            <button class="input-btn" id="toggleLineUserId">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">GAS Web App URL</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="gasWebAppUrl" placeholder="è¼¸å…¥ GAS ç¶²å€">
                            <button class="input-btn" id="toggleGasUrl">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ğŸ” Secret Key</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="gasSecretKey" placeholder="è¼¸å…¥å®‰å…¨é‡‘é‘°">
                            <button class="input-btn" id="toggleGasSecret">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" id="testLineBtn">ğŸ“¤ ç™¼é€æ¸¬è©¦è¨Šæ¯</button>
                </div>

                <!-- æœ¬æ©Ÿå„²å­˜ -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ’¾</div>
                        <div>
                            <div class="card-title">æœ¬æ©Ÿå„²å­˜</div>
                            <div class="card-subtitle">è‡ªå‹•è¨˜ä½è¨­å®š</div>
                        </div>
                    </div>
                    <div class="toggle-row">
                        <div>
                            <div class="toggle-title">å•Ÿç”¨æœ¬æ©Ÿå„²å­˜</div>
                            <div class="toggle-desc">API é‡‘é‘°å°‡å„²å­˜åœ¨æœ¬æ©Ÿ</div>
                        </div>
                        <div class="toggle-switch" id="localStorageToggle"></div>
                    </div>
                </div>

                <button class="btn btn-danger" id="clearAllBtn" style="margin-top: 20px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">é¦–é </span>
            </button>
            <button class="nav-item" data-page="input">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-label">è¼¸å…¥</span>
            </button>
            <button class="nav-item" data-page="line">
                <span class="nav-icon">ğŸ“±</span>
                <span class="nav-label">LINE</span>
            </button>
            <button class="nav-item" data-page="settings">
                <span class="nav-icon">âš™ï¸</span>
                <span class="nav-label">è¨­å®š</span>
            </button>
        </nav>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ“š å¹«åŠ©ä¸­å¿ƒ</div>
                <button class="modal-close" id="closeHelpBtn">âœ•</button>
            </div>
            <div class="modal-body">
                <div class="accordion-item open">
                    <button class="accordion-header">
                        <span>ğŸš€ å¦‚ä½•é–‹å§‹ä½¿ç”¨ï¼Ÿ</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. é»æ“Šã€Œè¼¸å…¥ã€é é¢<br>
                        2. é¸æ“‡æ–‡å­—ã€æª”æ¡ˆæˆ–åœ–ç‰‡è¼¸å…¥<br>
                        3. è²¼ä¸Šæˆ–ä¸Šå‚³ç ”ç¿’è³‡è¨Š<br>
                        4. é»æ“Šã€ŒAI æ™ºèƒ½è§£æã€<br>
                        5. ç¢ºèªè§£æçµæœå¾ŒåŒ¯å…¥æ—¥æ›†
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>ğŸ”‘ Gemini API è¨­å®š</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. å‰å¾€ Google AI Studio<br>
                        2. é»æ“Šã€ŒGet API keyã€<br>
                        3. å»ºç«‹æˆ–é¸æ“‡å°ˆæ¡ˆ<br>
                        4. è¤‡è£½ API Key è²¼åˆ°è¨­å®šé é¢
                    </div>
                </div>
                <div class="accordion-item">
                    <button class="accordion-header">
                        <span>ğŸ“± LINE é€šçŸ¥è¨­å®š</span>
                        <span class="accordion-icon">â–¼</span>
                    </button>
                    <div class="accordion-body">
                        1. å‰å¾€ LINE Developers Console<br>
                        2. å»ºç«‹ Messaging API Channel<br>
                        3. å–å¾— Channel Access Token<br>
                        4. å–å¾—æ‚¨çš„ User ID<br>
                        5. éƒ¨ç½² Google Apps Script
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // å…¨åŸŸè®Šæ•¸
        // ========================================
        var parsedEvents = [];
        var uploadedFilesContentArray = [];
        var uploadedImagesArray = [];
        var activeInputTab = 'text';
        var localStorageEnabled = false;
        var STORAGE_PREFIX = 'workshop_mobile_';

        // ========================================
        // Google Calendar API è¨­å®š
        // ========================================
        var DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        var SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        var tokenClient = null;
        var gapiInited = false;
        var gisInited = false;
        var accessToken = null;
        
        // Token å¿«å–è¨­å®šï¼ˆ24 å°æ™‚ = 86400000 æ¯«ç§’ï¼‰
        var TOKEN_CACHE_KEY = STORAGE_PREFIX + 'google_token';
        var TOKEN_EXPIRY_KEY = STORAGE_PREFIX + 'google_token_expiry';
        var TOKEN_CACHE_DURATION = 24 * 60 * 60 * 1000; // 24 å°æ™‚

        // ========================================
        // DOM Ready
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ App åˆå§‹åŒ–ä¸­...');
            initNavigation();
            initTabs();
            initButtons();
            initReminders();
            initUploads();
            initToggles();
            initModals();
            loadSettings();
            console.log('âœ… App åˆå§‹åŒ–å®Œæˆï¼');
        });

        // ========================================
        // å°èˆªåˆå§‹åŒ–
        // ========================================
        function initNavigation() {
            var navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(function(item) {
                item.addEventListener('click', function() {
                    var page = this.getAttribute('data-page');
                    switchToPage(page);
                });
            });
        }

        function switchToPage(pageName) {
            // æ›´æ–°é é¢
            document.querySelectorAll('.page').forEach(function(page) {
                page.classList.remove('active');
            });
            var targetPage = document.getElementById('page-' + pageName);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // æ›´æ–°å°èˆª
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) {
                    item.classList.add('active');
                }
            });

            // æ›´æ–° LINE ç‹€æ…‹
            if (pageName === 'line') {
                updateLineStatus();
            }

            console.log('ğŸ“„ åˆ‡æ›åˆ°é é¢:', pageName);
        }

        // ========================================
        // Tab åˆå§‹åŒ–
        // ========================================
        function initTabs() {
            var tabs = document.querySelectorAll('.tabs .tab');
            tabs.forEach(function(tab) {
                tab.addEventListener('click', function() {
                    var tabId = this.id.replace('tab-', '');
                    switchInputTab(tabId);
                });
            });
        }

        function switchInputTab(tabName) {
            activeInputTab = tabName;
            
            document.querySelectorAll('.tabs .tab').forEach(function(tab) {
                tab.classList.remove('active');
            });
            var targetTab = document.getElementById('tab-' + tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            document.querySelectorAll('.tab-content').forEach(function(content) {
                content.classList.remove('active');
            });
            var targetContent = document.getElementById('content-' + tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            console.log('ğŸ“‘ åˆ‡æ›åˆ° Tab:', tabName);
        }

        // ========================================
        // æŒ‰éˆ•åˆå§‹åŒ–
        // ========================================
        function initButtons() {
            // å¿«æ·æ“ä½œ
            document.getElementById('qa-text').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('text');
            });
            document.getElementById('qa-file').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('file');
            });
            document.getElementById('qa-image').addEventListener('click', function() {
                switchToPage('input');
                switchInputTab('image');
            });
            document.getElementById('qa-api').addEventListener('click', function() {
                switchToPage('settings');
            });

            // Header æŒ‰éˆ•
            document.getElementById('helpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.add('show');
            });
            document.getElementById('settingsBtn').addEventListener('click', function() {
                switchToPage('settings');
            });

            // è§£ææŒ‰éˆ•
            document.getElementById('parseBtn').addEventListener('click', parseSchedule);

            // åŒ¯å…¥æŒ‰éˆ•
            document.getElementById('importCalendarBtn').addEventListener('click', importToGoogleCalendar);
            document.getElementById('downloadIcsBtn').addEventListener('click', downloadICS);

            // LINE é é¢æŒ‰éˆ•
            document.getElementById('viewSchedulesBtn').addEventListener('click', viewScheduledReminders);
            document.getElementById('clearSchedulesBtn').addEventListener('click', clearAllReminders);
            document.getElementById('goToSettingsBtn').addEventListener('click', function() {
                switchToPage('settings');
            });

            // è¨­å®šé é¢æŒ‰éˆ•
            document.getElementById('testLineBtn').addEventListener('click', testLineNotification);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);

            // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
            document.getElementById('toggleGeminiKey').addEventListener('click', function() {
                toggleVisibility('geminiApiKey');
            });
            document.getElementById('toggleGoogleId').addEventListener('click', function() {
                toggleVisibility('googleClientId');
            });
            document.getElementById('toggleLineToken').addEventListener('click', function() {
                toggleVisibility('lineChannelAccessToken');
            });
            document.getElementById('toggleLineUserId').addEventListener('click', function() {
                toggleVisibility('lineUserId');
            });
            document.getElementById('toggleGasUrl').addEventListener('click', function() {
                toggleVisibility('gasWebAppUrl');
            });
            document.getElementById('toggleGasSecret').addEventListener('click', function() {
                toggleVisibility('gasSecretKey');
            });

            console.log('ğŸ”˜ æŒ‰éˆ•äº‹ä»¶å·²ç¶å®š');
        }

        // ========================================
        // æé†’é¸é …åˆå§‹åŒ–
        // ========================================
        function initReminders() {
            document.querySelectorAll('.reminder-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    var checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('checked', checkbox.checked);
                });
            });
        }

        // ========================================
        // ä¸Šå‚³åˆå§‹åŒ–
        // ========================================
        function initUploads() {
            // æª”æ¡ˆä¸Šå‚³
            document.getElementById('fileUploadArea').addEventListener('click', function() {
                document.getElementById('fileUpload').click();
            });
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);

            // åœ–ç‰‡ä¸Šå‚³
            document.getElementById('imageUploadArea').addEventListener('click', function() {
                document.getElementById('imageUpload').click();
            });
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        // ========================================
        // Toggle åˆå§‹åŒ–
        // ========================================
        function initToggles() {
            document.getElementById('localStorageToggle').addEventListener('click', toggleLocalStorage);
        }

        // ========================================
        // Modal åˆå§‹åŒ–
        // ========================================
        function initModals() {
            // é—œé–‰å¹«åŠ©
            document.getElementById('closeHelpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.remove('show');
            });

            // é»æ“ŠèƒŒæ™¯é—œé–‰
            document.getElementById('helpModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });

            // Accordion
            document.querySelectorAll('.accordion-header').forEach(function(header) {
                header.addEventListener('click', function() {
                    this.parentElement.classList.toggle('open');
                });
            });
        }

        // ========================================
        // Toast æç¤º
        // ========================================
        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || '');
            toast.classList.add('show');
            
            setTimeout(function() {
                toast.classList.remove('show');
            }, 3000);
        }

        // ========================================
        // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
        // ========================================
        function toggleVisibility(inputId) {
            var input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
            } else {
                input.type = 'password';
            }
        }

        // ========================================
        // æª”æ¡ˆä¸Šå‚³
        // ========================================
        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            showToast('ğŸ“„ æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');

            var reader = new FileReader();
            
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        var workbook = XLSX.read(e.target.result, { type: 'binary' });
                        var content = '';
                        workbook.SheetNames.forEach(function(name) {
                            var sheet = workbook.Sheets[name];
                            content += XLSX.utils.sheet_to_csv(sheet) + '\n';
                        });
                        uploadedFilesContentArray.push({ name: file.name, content: content });
                        updateFileInfo(file.name);
                    } catch (err) {
                        showToast('âŒ Excel è®€å–å¤±æ•—', 'error');
                    }
                };
                reader.readAsBinaryString(file);
            } else {
                reader.onload = function(e) {
                    uploadedFilesContentArray.push({ name: file.name, content: e.target.result });
                    updateFileInfo(file.name);
                };
                reader.readAsText(file);
            }
        }

        function updateFileInfo(fileName) {
            document.getElementById('fileInfo').style.display = 'block';
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileCount').textContent = uploadedFilesContentArray.length;
            showToast('âœ… æª”æ¡ˆå·²è¼‰å…¥ï¼š' + fileName, 'success');
        }

        // ========================================
        // åœ–ç‰‡ä¸Šå‚³
        // ========================================
        function handleImageUpload(event) {
            var file = event.target.files[0];
            if (!file) return;

            showToast('ğŸ“¸ æ­£åœ¨è®€å–åœ–ç‰‡...', 'info');

            var reader = new FileReader();
            reader.onload = function(e) {
                var base64 = e.target.result.split(',')[1];
                uploadedImagesArray.push(base64);
                
                var preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.add('show');
                
                showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        // ========================================
        // AI è§£æ
        // ========================================
        function parseSchedule() {
            var apiKey = document.getElementById('geminiApiKey').value.trim();
            var scheduleText = document.getElementById('scheduleText').value.trim();

            // é©—è­‰è¼¸å…¥
            if (activeInputTab === 'text' && !scheduleText) {
                showToast('âš ï¸ è«‹è¼¸å…¥æ´»å‹•è³‡è¨Š', 'error');
                return;
            }
            if (activeInputTab === 'file' && uploadedFilesContentArray.length === 0) {
                showToast('âš ï¸ è«‹ä¸Šå‚³æª”æ¡ˆ', 'error');
                return;
            }
            if (activeInputTab === 'image' && uploadedImagesArray.length === 0) {
                showToast('âš ï¸ è«‹ä¸Šå‚³åœ–ç‰‡', 'error');
                return;
            }

            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            document.getElementById('parseBtnText').style.display = 'none';
            document.getElementById('parseSpinner').style.display = 'block';
            showToast('ğŸ”„ æ­£åœ¨è§£æä¸­...', 'info');

            // æ¨¡æ“¬è§£æï¼ˆå¦‚æœæ²’æœ‰ API Key å°±ç”¨å…§å»ºè§£æï¼‰
            setTimeout(function() {
                var events;
                
                if (apiKey) {
                    // æœ‰ API Key å°±å˜—è©¦ç”¨ Gemini
                    parseWithGemini(apiKey, scheduleText);
                } else {
                    // æ²’æœ‰å°±ç”¨å…§å»ºè§£æ
                    events = parseWithBuiltIn(scheduleText);
                    handleParseResult(events);
                }
            }, 500);
        }

        // ========================================
        // æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´è¼”åŠ©å‡½æ•¸
        // ========================================
        function convertMinguoToWestern(text) {
            if (!text) return text;
            var result = text;
            
            // æ¨¡å¼1: æ°‘åœ‹XXXå¹´ / ä¸­è¯æ°‘åœ‹XXXå¹´ â†’ è¥¿å…ƒå¹´
            result = result.replace(/(?:æ°‘åœ‹|ä¸­è¯æ°‘åœ‹)\s*(\d{2,3})\s*å¹´/g, function(match, year) {
                var minguo = parseInt(year);
                if (minguo <= 200) {
                    var western = minguo + 1911;
                    console.log('ğŸ”„ æ°‘åœ‹å¹´è½‰æ›: ' + minguo + 'å¹´ â†’ ' + western + 'å¹´');
                    return western + 'å¹´';
                }
                return match;
            });
            
            // æ¨¡å¼2: XXXå¹´MMæœˆ (å¹´ä»½â‰¤200è¦–ç‚ºæ°‘åœ‹å¹´)
            result = result.replace(/(\d{2,3})å¹´(\d{1,2})æœˆ/g, function(match, year, month) {
                var yearNum = parseInt(year);
                if (yearNum <= 200) {
                    var western = yearNum + 1911;
                    console.log('ğŸ”„ æ°‘åœ‹å¹´è½‰æ›: ' + yearNum + 'å¹´' + month + 'æœˆ â†’ ' + western + 'å¹´' + month + 'æœˆ');
                    return western + 'å¹´' + month + 'æœˆ';
                }
                return match;
            });
            
            // æ¨¡å¼3: XXX/MM/DD æˆ– XXX-MM-DD (å¹´ä»½â‰¤200è¦–ç‚ºæ°‘åœ‹å¹´)
            result = result.replace(/(\d{2,3})([\/\-])(\d{1,2})\2(\d{1,2})/g, function(match, year, sep, month, day) {
                var yearNum = parseInt(year);
                if (yearNum <= 200) {
                    var western = yearNum + 1911;
                    console.log('ğŸ”„ æ°‘åœ‹å¹´è½‰æ›: ' + match + ' â†’ ' + western + sep + month + sep + day);
                    return western + sep + month + sep + day;
                }
                return match;
            });
            
            // æ¨¡å¼4: ç ”ç¿’ä»£ç¢¼æ ¼å¼ 1140919 â†’ 2025-09-19
            result = result.replace(/(\d{3})(\d{2})(\d{2})(?=\D|$)/g, function(match, year, month, day) {
                var yearNum = parseInt(year);
                var monthNum = parseInt(month);
                var dayNum = parseInt(day);
                if (yearNum >= 100 && yearNum <= 200 && monthNum >= 1 && monthNum <= 12 && dayNum >= 1 && dayNum <= 31) {
                    var western = yearNum + 1911;
                    console.log('ğŸ”„ ç ”ç¿’ä»£ç¢¼è½‰æ›: ' + match + ' â†’ ' + western + '-' + month + '-' + day);
                    return western + '-' + month + '-' + day;
                }
                return match;
            });
            
            return result;
        }

        // ========================================
        // æ°‘åœ‹å¹´äºŒæ¬¡é©—è­‰å‡½æ•¸ï¼ˆé‡å° OCR çµæœï¼‰
        // ========================================
        function fixMinguoYearInDate(dateStr, rocYear) {
            if (!dateStr) return dateStr;
            
            // å¦‚æœæœ‰æä¾› rocYearï¼Œé©—è­‰è½‰æ›æ˜¯å¦æ­£ç¢º
            if (rocYear && rocYear >= 100 && rocYear <= 200) {
                var expectedWesternYear = rocYear + 1911;
                var match = dateStr.match(/^(\d{4})/);
                if (match) {
                    var actualYear = parseInt(match[1]);
                    if (actualYear !== expectedWesternYear) {
                        console.log('ğŸ”§ ä¿®æ­£æ°‘åœ‹å¹´è½‰æ›éŒ¯èª¤: è­˜åˆ¥åˆ°æ°‘åœ‹' + rocYear + 'å¹´, é æœŸè¥¿å…ƒ' + expectedWesternYear + 'å¹´, å¯¦éš›' + actualYear + 'å¹´');
                        dateStr = dateStr.replace(/^\d{4}/, expectedWesternYear.toString());
                    }
                }
            }
            
            // å¦‚æœå¹´ä»½çœ‹èµ·ä¾†åƒæ°‘åœ‹å¹´ï¼ˆå°æ–¼ 200ï¼‰ï¼Œç›´æ¥è½‰æ›
            var match = dateStr.match(/^(\d{2,3})-/);
            if (match) {
                var yearNum = parseInt(match[1]);
                if (yearNum >= 100 && yearNum <= 200) {
                    var western = yearNum + 1911;
                    console.log('ğŸ”§ ç™¼ç¾æœªè½‰æ›çš„æ°‘åœ‹å¹´: ' + yearNum + ' â†’ ' + western);
                    dateStr = dateStr.replace(/^\d{2,3}/, western.toString());
                }
            }
            
            return dateStr;
        }

        // ğŸ”§ å¾åŸå§‹è¼¸å…¥ä¸­æå–è¥¿å…ƒå¹´ä»½ï¼ˆ2020-2030ï¼‰
        function extractWesternYearFromInput(text) {
            if (!text) return null;
            
            // åŒ¹é… 2020-2030 ç¯„åœçš„è¥¿å…ƒå¹´ä»½
            var matches = text.match(/\b(202[0-9]|2030)\b/g);
            if (matches && matches.length > 0) {
                // è¿”å›æ‰¾åˆ°çš„ç¬¬ä¸€å€‹å¹´ä»½
                return parseInt(matches[0]);
            }
            return null;
        }

        // ğŸ”§ ä¿®æ­£ AI è§£æçµæœä¸­çš„è¥¿å…ƒå¹´ä»½
        function fixWesternYearInDate(dateStr, originalYear) {
            if (!dateStr || !originalYear) return dateStr;
            
            // æå– AI è¿”å›çš„å¹´ä»½
            var match = dateStr.match(/^(\d{4})/);
            if (match) {
                var aiYear = parseInt(match[1]);
                
                // å¦‚æœ AI è¿”å›çš„å¹´ä»½èˆ‡åŸå§‹å¹´ä»½ä¸åŒï¼Œè€Œä¸”åŸå§‹å¹´ä»½æ˜¯åˆç†çš„æœªä¾†å¹´ä»½
                if (aiYear !== originalYear && originalYear >= 2024 && originalYear <= 2030) {
                    console.log('ğŸ”§ ä¿®æ­£è¥¿å…ƒå¹´ä»½: AI è¿”å› ' + aiYear + ' â†’ åŸå§‹è¼¸å…¥ ' + originalYear);
                    dateStr = dateStr.replace(/^\d{4}/, originalYear.toString());
                }
            }
            
            return dateStr;
        }

        // ğŸ†• ç°¡å–®çš„ç•°å¸¸å¹´ä»½ä¿®æ­£ï¼ˆåªè™•ç†æ˜é¡¯éŒ¯èª¤ï¼‰
        function fixCrazyYear(dateStr) {
            if (!dateStr) return dateStr;
            var match = dateStr.match(/^(\d+)-(\d+)-(\d+)/);
            if (match) {
                var yearNum = parseInt(match[1]);
                var month = parseInt(match[2]);
                // åªä¿®æ­£æ˜é¡¯éŒ¯èª¤çš„å¹´ä»½ï¼ˆè¶…é 2100ï¼‰
                if (yearNum > 2100) {
                    var now = new Date();
                    var currentYear = now.getFullYear();
                    // æ ¹æ“šæœˆä»½æ±ºå®šå¹´ä»½ï¼ˆ1æœˆ=æ˜å¹´ï¼Œå…¶ä»–=ä»Šå¹´ï¼‰
                    var fixed = (month === 1) ? currentYear + 1 : currentYear;
                    console.log('ğŸ”§ ä¿®æ­£ç•°å¸¸å¹´ä»½: ' + yearNum + ' â†’ ' + fixed);
                    return dateStr.replace(/^\d+/, fixed.toString());
                }
            }
            return dateStr;
        }

        function handleParseResult(events) {
            document.getElementById('parseBtnText').style.display = 'inline';
            document.getElementById('parseSpinner').style.display = 'none';

            if (events && events.length > 0) {
                // ä¿®æ­£ç•°å¸¸å¹´ä»½
                events = events.map(function(e) {
                    if (e.startDateTime) e.startDateTime = fixCrazyYear(e.startDateTime);
                    if (e.endDateTime) e.endDateTime = fixCrazyYear(e.endDateTime);
                    return e;
                });
                parsedEvents = events;
                displayEvents(events);
                document.getElementById('eventsPreview').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
                document.getElementById('eventCount').textContent = events.length;
                showToast('âœ… è§£ææˆåŠŸï¼æ‰¾åˆ° ' + events.length + ' å€‹äº‹ä»¶', 'success');
            } else {
                showToast('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆçš„äº‹ä»¶ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ ¼å¼', 'error');
            }
        }

        // ========================================
        // Gemini AI è§£æ
        // ========================================
        function parseWithGemini(apiKey, scheduleText) {
            var now = new Date();
            var currentYear = now.getFullYear();
            var currentMonth = now.getMonth() + 1;
            var currentDate = now.getDate();

            var prompt = 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œç¨‹è¡¨è§£æåŠ©æ‰‹ã€‚è«‹å°‡ä»¥ä¸‹æ´»å‹•è³‡è¨Šè§£æç‚º JSON æ ¼å¼ã€‚\n\n';
            prompt += 'ä»Šå¤©æ˜¯ ' + currentYear + ' å¹´ ' + currentMonth + ' æœˆ ' + currentDate + ' æ—¥\n\n';
            prompt += 'è«‹è¼¸å‡ºä»¥ä¸‹ JSON æ ¼å¼ï¼ˆç´” JSONï¼Œä¸è¦ markdownï¼‰ï¼š\n';
            prompt += '{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°"}]}\n\n';
            
            prompt += 'ã€é©ç”¨ç¯„åœã€‘æœ¬å·¥å…·å¯è§£æå„ç¨®æ´»å‹•ï¼š\n';
            prompt += 'â€¢ æ•™å¸«ç ”ç¿’ã€ç ”è¨æœƒã€å·¥ä½œåŠ\n';
            prompt += 'â€¢ ç•¢æ¥­æ—…è¡Œã€æ ¡å¤–æ•™å­¸ã€æˆ¶å¤–æ´»å‹•\n';
            prompt += 'â€¢ å­¸æ ¡æ´»å‹•ã€é‹å‹•æœƒã€åœ’éŠæœƒ\n';
            prompt += 'â€¢ æœƒè­°ã€è¬›åº§ã€èª²ç¨‹\n';
            prompt += 'â€¢ æ—…éŠè¡Œç¨‹ã€åƒè¨ªæ´»å‹•\n\n';
            
            prompt += 'ã€é‡è¦ã€‘æ—¥æœŸæ™‚é–“è™•ç†è¦å‰‡ï¼ˆæŒ‰å„ªå…ˆé †åºï¼‰ï¼š\n';
            prompt += 'â­ ã€æœ€æœ€é‡è¦ - ä¿ç•™åŸå§‹å¹´ä»½ã€‘å¦‚æœåŸå§‹è³‡æ–™å·²ç¶“åŒ…å«å®Œæ•´è¥¿å…ƒå¹´ä»½ï¼ˆå¦‚ 2026ã€2025ã€2024ï¼‰ï¼Œå¿…é ˆ 100% å®Œå…¨ä¿ç•™åŸå§‹å¹´ä»½ï¼Œçµ•å°ä¸èƒ½ä¿®æ”¹ï¼ä¾‹å¦‚ï¼šã€Œ2026-01-03ã€å°±æ˜¯ 2026 å¹´ï¼Œä¸èƒ½æ”¹æˆ 2025 å¹´ï¼\n';
            prompt += '0. ã€æ°‘åœ‹å¹´è½‰æ›ã€‘å¦‚æœçœ‹åˆ°ã€Œ114å¹´ã€ã€Œ115å¹´ã€ã€Œæ°‘åœ‹114å¹´ã€ã€Œä¸­è¯æ°‘åœ‹115å¹´ã€ã€Œ114/12/05ã€ç­‰æ ¼å¼ï¼Œé€™æ˜¯å°ç£æ°‘åœ‹å¹´ï¼Œå¿…é ˆè½‰æ›ï¼šæ°‘åœ‹å¹´ + 1911 = è¥¿å…ƒå¹´ã€‚ä¾‹å¦‚ï¼š114å¹´ = 2025å¹´ã€115å¹´9æœˆ = 2026å¹´9æœˆã€113/11/21 = 2024-11-21ã€‚åˆ¤æ–·æ¨™æº–ï¼šå¹´ä»½æ•¸å­— â‰¤ 200 æ™‚è¦–ç‚ºæ°‘åœ‹å¹´ã€‚\n';
            prompt += '1. æ—¥æœŸæ ¼å¼å¿…é ˆæ˜¯ ISO 8601ï¼ˆYYYY-MM-DDTHH:MM:SSï¼‰\n';
            prompt += '2. å¦‚æœæ²’æœ‰çµæŸæ™‚é–“ï¼Œé è¨­æ´»å‹• 2 å°æ™‚\n';
            prompt += '3. å¦‚æœåªæœ‰æ—¥æœŸæ²’æœ‰æ™‚é–“ï¼Œé è¨­ 08:00-17:00ï¼ˆå…¨å¤©æ´»å‹•ï¼‰\n';
            prompt += '4. å¦‚æœæ—¥æœŸåªæœ‰æœˆ/æ—¥æ²’æœ‰å¹´ä»½ï¼Œæ ¹æ“šä»Šå¤©æ—¥æœŸæ¨æ–·ï¼šå¦‚æœè©²æ—¥æœŸå·²éå‰‡ç‚ºæ˜å¹´ï¼Œå¦å‰‡ç‚ºä»Šå¹´\n';
            prompt += '5. ç ”ç¿’ä»£ç¢¼æ ¼å¼å¦‚ã€Œ1140919ã€å‰ä¸‰ç¢¼114æ˜¯æ°‘åœ‹å¹´ï¼Œå¾Œå››ç¢¼0919æ˜¯9æœˆ19æ—¥\n';
            prompt += '6. å¸¸è¦‹æ°‘åœ‹å¹´æ ¼å¼ï¼š114å¹´ã€æ°‘åœ‹114å¹´ã€ä¸­è¯æ°‘åœ‹114å¹´ã€114/MM/DDã€114.MM.DD\n\n';
            
            prompt += 'ã€æ™‚é–“æ ¼å¼è¾¨è­˜ã€‘è«‹ç‰¹åˆ¥æ³¨æ„é€™äº›å¸¸è¦‹æ ¼å¼ï¼š\n';
            prompt += 'â€¢ ã€Œ08:00ã€ã€Œ8:00ã€ã€Œä¸Šåˆ8é»ã€ã€Œæ—©ä¸Šå…«é»ã€â†’ 08:00:00\n';
            prompt += 'â€¢ ã€Œä¸‹åˆ2é»ã€ã€Œ14:00ã€ã€ŒPM 2:00ã€â†’ 14:00:00\n';
            prompt += 'â€¢ ã€Œ08:00-12:00ã€ã€Œ8:00~12:00ã€ã€Œ08:00è‡³12:00ã€â†’ é–‹å§‹08:00 çµæŸ12:00\n';
            prompt += 'â€¢ ã€Œç¬¬ä¸€å¤©ã€ã€ŒDay 1ã€ã€ŒD1ã€â†’ è¡Œç¨‹çš„ç¬¬ä¸€å¤©\n';
            prompt += 'â€¢ ã€Œ09:00 å‡ºç™¼ã€ã€Œ10:30 æŠµé”ã€â†’ è©²æ™‚é–“é»çš„æ´»å‹•\n';
            prompt += 'â€¢ ã€Œåˆé¤ã€ã€Œæ™šé¤ã€ã€Œæ—©é¤ã€â†’ 12:00/18:00/07:30\n\n';
            
            prompt += 'ã€è¡Œç¨‹è¡¨ç‰¹æ®Šè™•ç†ã€‘\n';
            prompt += 'â€¢ å¦‚æœæ˜¯å¤šæ—¥è¡Œç¨‹ï¼ˆå¦‚ç•¢æ¥­æ—…è¡Œï¼‰ï¼Œè«‹ç‚ºæ¯å¤©çš„é‡è¦æ´»å‹•å»ºç«‹ç¨ç«‹äº‹ä»¶\n';
            prompt += 'â€¢ å¦‚æœåŒä¸€å¤©æœ‰å¤šå€‹æ™‚æ®µï¼Œè«‹åˆ†åˆ¥å»ºç«‹å¤šå€‹äº‹ä»¶\n';
            prompt += 'â€¢ æ´»å‹•æ¨™é¡Œè¦ç°¡æ½”æ˜ç¢ºï¼Œå¯åŠ å…¥æ—¥æœŸæ¨™è¨˜å¦‚ã€Œç•¢æ—…Day1-ä¹æ—æ–‡åŒ–æ‘ã€\n';
            prompt += 'â€¢ åœ°é»è¦ç›¡é‡å…·é«”ï¼Œå¦‚ã€Œå°ä¸­â†’ä¹æ—æ–‡åŒ–æ‘â†’æ—¥æœˆæ½­ã€\n\n';

            var content = '';
            if (activeInputTab === 'text') {
                content = convertMinguoToWestern(scheduleText);
            } else if (activeInputTab === 'file') {
                content = uploadedFilesContentArray.map(function(f) { return convertMinguoToWestern(f.content); }).join('\n\n');
            }

            var requestBody = {
                contents: [{ parts: [{ text: prompt + 'è¡Œç¨‹å…§å®¹ï¼š\n' + content }] }],
                generationConfig: { temperature: 0.1 }
            };

            // åœ–ç‰‡è™•ç† - å¤§å¹…åŠ å¼· OCR è¾¨è­˜æŒ‡ä»¤
            if (activeInputTab === 'image' && uploadedImagesArray.length > 0) {
                var ocrPrompt = 'ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„è¡Œç¨‹è¡¨ OCR è¾¨è­˜åŠ©æ‰‹ã€‚è«‹ä»”ç´°è¾¨è­˜åœ–ç‰‡ä¸­çš„æ‰€æœ‰æ–‡å­—ï¼Œä¸¦è§£æç‚ºè¡Œäº‹æ›†äº‹ä»¶ã€‚\n\n';
                ocrPrompt += 'ä»Šå¤©æ˜¯ ' + currentYear + ' å¹´ ' + currentMonth + ' æœˆ ' + currentDate + ' æ—¥\n\n';
                ocrPrompt += 'è«‹è¼¸å‡ºä»¥ä¸‹ JSON æ ¼å¼ï¼ˆç´” JSONï¼Œä¸è¦ markdownï¼‰ï¼š\n';
                ocrPrompt += '{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°","rocYear":è­˜åˆ¥åˆ°çš„æ°‘åœ‹å¹´æ•¸å­—}]}\n\n';
                ocrPrompt += 'âš ï¸ rocYear æ¬„ä½èªªæ˜ï¼šå¡«å…¥ä½ åœ¨åœ–ç‰‡ä¸­è­˜åˆ¥åˆ°çš„æ°‘åœ‹å¹´æ•¸å­—ï¼Œä¾‹å¦‚çœ‹åˆ°ã€Œ115å¹´ã€å°±å¡« 115ï¼Œçœ‹åˆ°ã€Œ114å¹´ã€å°±å¡« 114ã€‚é€™ç”¨æ–¼å‰ç«¯é©—è­‰è½‰æ›æ˜¯å¦æ­£ç¢ºã€‚\n\n';
                
                ocrPrompt += 'ã€OCR è¾¨è­˜é‡é»æŒ‡ç¤ºã€‘\n';
                ocrPrompt += '1. ã€æœ€é‡è¦ã€‘ä»”ç´°è¾¨è­˜æ‰€æœ‰æ—¥æœŸå’Œæ™‚é–“ï¼Œé€™æ˜¯æœ€é—œéµçš„è³‡è¨Š\n';
                ocrPrompt += '2. å°ç£æ–‡ä»¶å¸¸ç”¨æ°‘åœ‹å¹´ï¼ˆ114å¹´=2025å¹´ï¼‰ï¼Œå¹´ä»½â‰¤200æ™‚è¦–ç‚ºæ°‘åœ‹å¹´\n';
                ocrPrompt += '3. è¾¨è­˜å„ç¨®æ™‚é–“è¡¨ç¤ºï¼š08:00ã€8é»ã€ä¸Šåˆ8æ™‚ã€AM8:00\n';
                ocrPrompt += '4. è¾¨è­˜æ™‚é–“ç¯„åœï¼š08:00-12:00ã€8:00~12:00ã€08:00è‡³12:00\n';
                ocrPrompt += '5. å¦‚æœåœ–ç‰‡æ¨¡ç³Šï¼Œç›¡é‡å¾ä¸Šä¸‹æ–‡æ¨æ–·åˆç†çš„æ—¥æœŸæ™‚é–“\n\n';
                
                ocrPrompt += 'ã€é©ç”¨çš„æ´»å‹•é¡å‹ã€‘\n';
                ocrPrompt += 'â€¢ ç ”ç¿’ã€ç ”è¨æœƒã€å·¥ä½œåŠã€è¬›åº§\n';
                ocrPrompt += 'â€¢ ç•¢æ¥­æ—…è¡Œã€æ ¡å¤–æ•™å­¸ã€æˆ¶å¤–æ´»å‹•è¡Œç¨‹è¡¨\n';
                ocrPrompt += 'â€¢ å­¸æ ¡æ´»å‹•é€šçŸ¥ã€é‹å‹•æœƒã€åœ’éŠæœƒ\n';
                ocrPrompt += 'â€¢ æ—…éŠè¡Œç¨‹è¡¨ã€åƒè¨ªæ´»å‹•\n';
                ocrPrompt += 'â€¢ æœƒè­°é€šçŸ¥ã€èª²ç¨‹è¡¨\n\n';
                
                ocrPrompt += 'ã€å¤šæ—¥è¡Œç¨‹è™•ç†ã€‘\n';
                ocrPrompt += 'â€¢ å¦‚æœæ˜¯å¤šæ—¥æ´»å‹•ï¼ˆå¦‚3å¤©2å¤œç•¢æ¥­æ—…è¡Œï¼‰ï¼Œè«‹ç‚ºæ¯å¤©å»ºç«‹ç¨ç«‹äº‹ä»¶\n';
                ocrPrompt += 'â€¢ æ¨™é¡ŒåŠ ä¸Šæ—¥æœŸæ¨™è¨˜ï¼Œå¦‚ã€Œç•¢æ—…Day1-å‡ºç™¼ã€ã€Œç•¢æ—…Day2-éŠæ¨‚åœ’ã€\n';
                ocrPrompt += 'â€¢ æ¯å€‹é‡è¦æ™‚æ®µå¯ä»¥æ˜¯ç¨ç«‹äº‹ä»¶\n\n';
                
                ocrPrompt += 'ã€æ™‚é–“æ¨æ–·è¦å‰‡ã€‘\n';
                ocrPrompt += 'â€¢ ã€Œé›†åˆã€ã€Œå‡ºç™¼ã€é€šå¸¸æ˜¯ 07:00-08:00\n';
                ocrPrompt += 'â€¢ ã€Œæ—©é¤ã€ç´„ 07:30ã€ã€Œåˆé¤ã€ç´„ 12:00ã€ã€Œæ™šé¤ã€ç´„ 18:00\n';
                ocrPrompt += 'â€¢ ã€Œå…¥ä½ã€ã€ŒCheck-inã€é€šå¸¸æ˜¯ 15:00-16:00\n';
                ocrPrompt += 'â€¢ ã€Œè¿”ç¨‹ã€ã€Œè³¦æ­¸ã€é€šå¸¸æ˜¯ 15:00-17:00\n';
                ocrPrompt += 'â€¢ å¦‚æœåªæœ‰ã€Œç¬¬ä¸€å¤©ã€ã€ŒDay1ã€ç­‰æ¨™è¨˜ï¼Œè«‹å¾è¡Œç¨‹æ—¥æœŸæ¨ç®—ç¢ºåˆ‡æ—¥æœŸ\n\n';
                
                ocrPrompt += 'ã€âš ï¸ æ°‘åœ‹å¹´è½‰æ› - æœ€é‡è¦ï¼ã€‘\n';
                ocrPrompt += 'å°ç£ä½¿ç”¨æ°‘åœ‹ç´€å¹´ï¼Œè½‰æ›å…¬å¼ï¼šæ°‘åœ‹å¹´ + 1911 = è¥¿å…ƒå¹´\n';
                ocrPrompt += 'â€¢ 113å¹´ = 113 + 1911 = 2024å¹´\n';
                ocrPrompt += 'â€¢ 114å¹´ = 114 + 1911 = 2025å¹´\n';
                ocrPrompt += 'â€¢ 115å¹´ = 115 + 1911 = 2026å¹´ â­\n';
                ocrPrompt += 'â€¢ 116å¹´ = 116 + 1911 = 2027å¹´\n';
                ocrPrompt += 'â€¢ ç ”ç¿’ä»£ç¢¼ã€Œ1150922ã€= 2026-09-22\n';
                ocrPrompt += 'ã€åš´é‡è­¦å‘Šã€‘å¦‚æœåœ–ç‰‡é¡¯ç¤ºã€Œ115å¹´ã€ï¼Œçµ•å°ä¸èƒ½è¼¸å‡º2025å¹´ï¼å¿…é ˆæ˜¯2026å¹´ï¼\n\n';
                
                ocrPrompt += 'è«‹è¾¨è­˜ä»¥ä¸‹åœ–ç‰‡ä¸­çš„è¡Œç¨‹è³‡è¨Šï¼Œæå–æ‰€æœ‰æ´»å‹•çš„æ—¥æœŸã€æ™‚é–“ã€åœ°é»ï¼š';
                
                var parts = [{ text: ocrPrompt }];
                uploadedImagesArray.forEach(function(img) {
                    parts.push({ inline_data: { mime_type: 'image/jpeg', data: img } });
                });
                requestBody = {
                    contents: [{ parts: parts }],
                    generationConfig: { temperature: 0.1 }
                };
            }

            fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.error) {
                    throw new Error(data.error.message);
                }
                var text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                var result = JSON.parse(text);
                
                // æ°‘åœ‹å¹´äºŒæ¬¡æª¢æŸ¥èˆ‡ä¿®æ­£ï¼ˆé‡å° OCR çµæœï¼‰
                var events = result.events || [];
                
                // ğŸ”§ å–å¾—åŸå§‹è¼¸å…¥ä¸­çš„è¥¿å…ƒå¹´ä»½
                var originalYear = extractWesternYearFromInput(content);
                console.log('ğŸ“… åŸå§‹è¼¸å…¥ä¸­åµæ¸¬åˆ°çš„è¥¿å…ƒå¹´ä»½:', originalYear);
                
                events = events.map(function(event) {
                    var rocYear = event.rocYear || null;
                    // æª¢æŸ¥æ—¥æœŸæ˜¯å¦éœ€è¦ä¿®æ­£
                    if (event.startDateTime) {
                        event.startDateTime = fixMinguoYearInDate(event.startDateTime, rocYear);
                        // ğŸ”§ è¥¿å…ƒå¹´ä»½ä¿®æ­£
                        event.startDateTime = fixWesternYearInDate(event.startDateTime, originalYear);
                    }
                    if (event.endDateTime) {
                        event.endDateTime = fixMinguoYearInDate(event.endDateTime, rocYear);
                        // ğŸ”§ è¥¿å…ƒå¹´ä»½ä¿®æ­£
                        event.endDateTime = fixWesternYearInDate(event.endDateTime, originalYear);
                    }
                    return event;
                });
                
                handleParseResult(events);
            })
            .catch(function(error) {
                console.error('Gemini éŒ¯èª¤:', error);
                showToast('âŒ AI è§£æå¤±æ•—ï¼Œæ”¹ç”¨å…§å»ºè§£æ', 'error');
                var events = parseWithBuiltIn(scheduleText);
                handleParseResult(events);
            });
        }

        // ========================================
        // å…§å»ºè§£æå™¨
        // ========================================
        function parseWithBuiltIn(text) {
            if (!text) return [];
            
            // å…ˆé€²è¡Œæ°‘åœ‹å¹´è½‰æ›
            text = convertMinguoToWestern(text);
            
            var events = [];
            var lines = text.split('\n');
            var currentEvent = null;
            var now = new Date();

            // æ›´æ–°æ­£å‰‡è¡¨é”å¼ä»¥æ”¯æ´æ›´å¤šæ—¥æœŸæ ¼å¼
            var fullDateTimeRegex = /(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2}).*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            var dateTimeRegex = /(\d{1,2})[\/\-](\d{1,2}).*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            var fullDateOnlyRegex = /(\d{4})[\/\-å¹´](\d{1,2})[\/\-æœˆ](\d{1,2})/;
            var dateOnlyRegex = /(\d{1,2})[\/\-](\d{1,2})/;

            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return;

                var fullDateTimeMatch = line.match(fullDateTimeRegex);
                var dateTimeMatch = line.match(dateTimeRegex);
                var fullDateOnlyMatch = line.match(fullDateOnlyRegex);
                var dateOnlyMatch = line.match(dateOnlyRegex);

                if (fullDateTimeMatch) {
                    // å®Œæ•´æ—¥æœŸæ™‚é–“ï¼ˆå«å¹´ä»½ï¼‰
                    if (currentEvent && currentEvent.title) {
                        events.push(currentEvent);
                    }
                    
                    var year = parseInt(fullDateTimeMatch[1]);
                    var month = parseInt(fullDateTimeMatch[2]);
                    var day = parseInt(fullDateTimeMatch[3]);
                    var startHour = parseInt(fullDateTimeMatch[4]);
                    var startMin = parseInt(fullDateTimeMatch[5]);
                    var endHour = parseInt(fullDateTimeMatch[6]);
                    var endMin = parseInt(fullDateTimeMatch[7]);

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(startHour).padStart(2, '0') + ':' + String(startMin).padStart(2, '0') + ':00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(endHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0') + ':00',
                        location: '',
                        description: ''
                    };
                } else if (dateTimeMatch) {
                    if (currentEvent && currentEvent.title) {
                        events.push(currentEvent);
                    }
                    
                    var month = parseInt(dateTimeMatch[1]);
                    var day = parseInt(dateTimeMatch[2]);
                    var startHour = parseInt(dateTimeMatch[3]);
                    var startMin = parseInt(dateTimeMatch[4]);
                    var endHour = parseInt(dateTimeMatch[5]);
                    var endMin = parseInt(dateTimeMatch[6]);
                    var year = now.getFullYear();

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(startHour).padStart(2, '0') + ':' + String(startMin).padStart(2, '0') + ':00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T' + String(endHour).padStart(2, '0') + ':' + String(endMin).padStart(2, '0') + ':00',
                        location: '',
                        description: ''
                    };
                } else if (fullDateOnlyMatch && !currentEvent) {
                    // å®Œæ•´æ—¥æœŸï¼ˆå«å¹´ä»½ï¼‰
                    var year = parseInt(fullDateOnlyMatch[1]);
                    var month = parseInt(fullDateOnlyMatch[2]);
                    var day = parseInt(fullDateOnlyMatch[3]);

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T09:00:00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T12:00:00',
                        location: '',
                        description: ''
                    };
                } else if (dateOnlyMatch && !currentEvent) {
                    var month = parseInt(dateOnlyMatch[1]);
                    var day = parseInt(dateOnlyMatch[2]);
                    var year = now.getFullYear();

                    currentEvent = {
                        title: '',
                        startDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T09:00:00',
                        endDateTime: year + '-' + String(month).padStart(2, '0') + '-' + String(day).padStart(2, '0') + 'T12:00:00',
                        location: '',
                        description: ''
                    };
                } else if (currentEvent) {
                    if (line.includes('åœ°é»') || line.includes('å ´åœ°') || line.includes('Location')) {
                        currentEvent.location = line.replace(/åœ°é»[:ï¼š]?\s*/, '').replace(/å ´åœ°[:ï¼š]?\s*/, '').replace(/Location[:ï¼š]?\s*/i, '');
                    } else if (!currentEvent.title && line.length > 2) {
                        currentEvent.title = line;
                    } else if (currentEvent.title) {
                        currentEvent.description += line + '\n';
                    }
                }
            });

            if (currentEvent && currentEvent.title) {
                events.push(currentEvent);
            }

            return events;
        }

        // ========================================
        // é¡¯ç¤ºäº‹ä»¶
        // ========================================
        function displayEvents(events) {
            var container = document.getElementById('eventsPreview');
            var html = '';
            var weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            events.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                var dayOfWeek = weekdays[startDate.getDay()];

                html += '<div class="event-item" id="event_' + index + '">';
                html += '<div class="event-title">' + (event.title || 'æœªå‘½åäº‹ä»¶') + '</div>';
                html += '<div class="event-meta">';
                html += '<div class="event-meta-item">ğŸ“… ' + formatDate(startDate) + '<span class="day-badge">é€±' + dayOfWeek + '</span></div>';
                html += '<div class="event-meta-item">â° ' + formatTime(startDate) + ' - ' + formatTime(endDate) + '</div>';
                if (event.location) {
                    html += '<div class="event-meta-item">ğŸ“ ' + event.location + '</div>';
                }
                html += '</div>';
                html += '</div>';
            });

            container.innerHTML = html;
            document.getElementById('homeEventList').innerHTML = html || '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
        }

        function formatDate(date) {
            return date.getFullYear() + '/' + String(date.getMonth() + 1).padStart(2, '0') + '/' + String(date.getDate()).padStart(2, '0');
        }

        function formatTime(date) {
            return String(date.getHours()).padStart(2, '0') + ':' + String(date.getMinutes()).padStart(2, '0');
        }

        // ========================================
        // ICS ä¸‹è¼‰
        // ========================================
        function downloadICS() {
            if (parsedEvents.length === 0) {
                showToast('âŒ æ²’æœ‰å¯åŒ¯å‡ºçš„äº‹ä»¶', 'error');
                return;
            }

            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(input) {
                reminders.push(parseInt(input.value));
            });

            var icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Workshop Mobile//EN\nCALSCALE:GREGORIAN\nMETHOD:PUBLISH\n';

            parsedEvents.forEach(function(event, index) {
                var startDate = new Date(event.startDateTime);
                var endDate = new Date(event.endDateTime);
                var now = new Date();
                var uid = 'workshop-' + index + '-' + Date.now() + '@mobile';

                icsContent += 'BEGIN:VEVENT\n';
                icsContent += 'UID:' + uid + '\n';
                icsContent += 'DTSTAMP:' + formatICSDate(now) + '\n';
                icsContent += 'DTSTART:' + formatICSDate(startDate) + '\n';
                icsContent += 'DTEND:' + formatICSDate(endDate) + '\n';
                icsContent += 'SUMMARY:' + escapeICS(event.title) + '\n';
                if (event.location) icsContent += 'LOCATION:' + escapeICS(event.location) + '\n';
                if (event.description) icsContent += 'DESCRIPTION:' + escapeICS(event.description) + '\n';
                
                reminders.forEach(function(mins) {
                    icsContent += 'BEGIN:VALARM\nTRIGGER:-PT' + mins + 'M\nACTION:DISPLAY\nDESCRIPTION:ç ”ç¿’æé†’\nEND:VALARM\n';
                });

                icsContent += 'END:VEVENT\n';
            });

            icsContent += 'END:VCALENDAR';

            var blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ç ”ç¿’è¡Œäº‹æ›†_' + formatDate(new Date()).replace(/\//g, '') + '.ics';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('âœ… ICS æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
            
            // ğŸ”” è‡ªå‹•å»ºç«‹ LINE æ’ç¨‹æé†’ï¼ˆå¦‚æœæœ‰è¨­å®šï¼‰
            var hasLineSettings = document.getElementById('lineChannelAccessToken').value.trim() &&
                                  document.getElementById('lineUserId').value.trim() &&
                                  document.getElementById('gasWebAppUrl').value.trim() &&
                                  document.getElementById('gasSecretKey').value.trim();
            
            if (hasLineSettings && getSelectedLineReminders().length > 0) {
                setTimeout(function() {
                    createReminderSchedules(parsedEvents);
                }, 500);
            }
        }

        function formatICSDate(date) {
            return date.getFullYear() +
                String(date.getMonth() + 1).padStart(2, '0') +
                String(date.getDate()).padStart(2, '0') + 'T' +
                String(date.getHours()).padStart(2, '0') +
                String(date.getMinutes()).padStart(2, '0') +
                String(date.getSeconds()).padStart(2, '0');
        }

        function escapeICS(text) {
            if (!text) return '';
            return text.replace(/\\/g, '\\\\').replace(/;/g, '\\;').replace(/,/g, '\\,').replace(/\n/g, '\\n');
        }

        // ========================================
        // Google Calendar API - OAuth æˆæ¬Šï¼ˆ24å°æ™‚å¿«å–ï¼‰
        // ========================================
        function gapiLoaded() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', initializeGapiClient);
            }
        }

        async function initializeGapiClient() {
            console.log('ğŸ”„ é–‹å§‹åˆå§‹åŒ– Google API Client...');
            try {
                await gapi.client.init({ discoveryDocs: [DISCOVERY_DOC] });
                console.log('âœ… gapi.client.init æˆåŠŸ');
                
                // ğŸ”§ æª¢æŸ¥ Calendar API æ˜¯å¦è¼‰å…¥
                if (!gapi.client.calendar) {
                    console.log('âš ï¸ Discovery Doc æœªæ­£ç¢ºè¼‰å…¥ Calendar APIï¼Œå˜—è©¦å‚™ç”¨æ–¹æ¡ˆ...');
                    try {
                        await gapi.client.load('calendar', 'v3');
                        console.log('âœ… å‚™ç”¨è¼‰å…¥æˆåŠŸ: gapi.client.load("calendar", "v3")');
                    } catch (loadErr) {
                        console.error('âŒ å‚™ç”¨è¼‰å…¥å¤±æ•—:', loadErr);
                    }
                }
                
                gapiInited = true;
                console.log('âœ… Google API Client åˆå§‹åŒ–å®Œæˆ');
                console.log('   gapi.client.calendar:', gapi.client.calendar ? 'å·²è¼‰å…¥' : 'æœªè¼‰å…¥');
                
                // å˜—è©¦æ¢å¾©å¿«å–çš„ token
                restoreCachedToken();
                maybeEnableCalendarButton();
            } catch (error) {
                console.error('âŒ Google API åˆå§‹åŒ–å¤±æ•—:', error);
                console.error('   éŒ¯èª¤è¨Šæ¯:', error.message || JSON.stringify(error));
                
                // ğŸ”§ å‚™ç”¨æ–¹æ¡ˆï¼šå˜—è©¦ç›´æ¥è¼‰å…¥ Calendar API
                try {
                    console.log('ğŸ”„ å˜—è©¦å‚™ç”¨è¼‰å…¥æ–¹å¼...');
                    await gapi.client.load('calendar', 'v3');
                    gapiInited = true;
                    console.log('âœ… å‚™ç”¨è¼‰å…¥æˆåŠŸ');
                    maybeEnableCalendarButton();
                } catch (e2) {
                    console.error('âŒ å‚™ç”¨è¼‰å…¥ä¹Ÿå¤±æ•—:', e2);
                }
            }
        }

        function gisLoaded() {
            var clientIdInput = document.getElementById('googleClientId');
            if (clientIdInput && clientIdInput.value.trim()) {
                initTokenClient(clientIdInput.value.trim());
            }
            if (clientIdInput) {
                clientIdInput.addEventListener('change', function() {
                    if (this.value.trim()) {
                        initTokenClient(this.value.trim());
                    }
                });
            }
        }

        function initTokenClient(clientId) {
            if (typeof google === 'undefined' || !google.accounts) {
                console.warn('âš ï¸ Google Identity Services å°šæœªè¼‰å…¥');
                return;
            }
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: ''
            });
            gisInited = true;
            console.log('âœ… Token Client åˆå§‹åŒ–å®Œæˆ');
            
            // å˜—è©¦æ¢å¾©å¿«å–çš„ token
            restoreCachedToken();
            maybeEnableCalendarButton();
        }

        function maybeEnableCalendarButton() {
            var authBtn = document.getElementById('googleAuthBtn');
            if (authBtn && gapiInited && gisInited) {
                authBtn.disabled = false;
                authBtn.classList.remove('disabled');
                
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰æœ‰æ•ˆçš„å¿«å– token
                if (accessToken && isCachedTokenValid()) {
                    updateAuthButtonStatus(true);
                }
            }
        }

        // ğŸ” Token å¿«å–åŠŸèƒ½ï¼ˆ24 å°æ™‚æœ‰æ•ˆï¼‰
        function saveCachedToken(token) {
            try {
                var expiry = Date.now() + TOKEN_CACHE_DURATION;
                localStorage.setItem(TOKEN_CACHE_KEY, token);
                localStorage.setItem(TOKEN_EXPIRY_KEY, expiry.toString());
                console.log('ğŸ’¾ Token å·²å¿«å–ï¼ˆ24å°æ™‚æœ‰æ•ˆï¼‰');
                console.log('   åˆ°æœŸæ™‚é–“:', new Date(expiry).toLocaleString('zh-TW'));
            } catch (e) {
                console.error('âŒ Token å¿«å–å¤±æ•—:', e);
            }
        }

        function restoreCachedToken() {
            try {
                var cachedToken = localStorage.getItem(TOKEN_CACHE_KEY);
                var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY);
                
                if (cachedToken && expiry) {
                    var expiryTime = parseInt(expiry);
                    if (Date.now() < expiryTime) {
                        accessToken = cachedToken;
                        
                        // è¨­å®š gapi client token
                        if (gapiInited && typeof gapi !== 'undefined') {
                            gapi.client.setToken({ access_token: cachedToken });
                        }
                        
                        var remainingHours = Math.round((expiryTime - Date.now()) / (60 * 60 * 1000) * 10) / 10;
                        console.log('ğŸ”„ å·²æ¢å¾©å¿«å–çš„ Token');
                        console.log('   å‰©é¤˜æœ‰æ•ˆæ™‚é–“:', remainingHours, 'å°æ™‚');
                        
                        updateAuthButtonStatus(true, remainingHours);
                        return true;
                    } else {
                        // Token å·²éæœŸï¼Œæ¸…é™¤
                        clearCachedToken();
                        console.log('â° å¿«å–çš„ Token å·²éæœŸï¼Œå·²æ¸…é™¤');
                    }
                }
            } catch (e) {
                console.error('âŒ æ¢å¾© Token å¤±æ•—:', e);
            }
            return false;
        }

        function isCachedTokenValid() {
            try {
                var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY);
                if (expiry) {
                    return Date.now() < parseInt(expiry);
                }
            } catch (e) {}
            return false;
        }

        function clearCachedToken() {
            try {
                localStorage.removeItem(TOKEN_CACHE_KEY);
                localStorage.removeItem(TOKEN_EXPIRY_KEY);
                accessToken = null;
            } catch (e) {}
        }

        function getCachedTokenRemainingTime() {
            try {
                var expiry = localStorage.getItem(TOKEN_EXPIRY_KEY);
                if (expiry) {
                    var remaining = parseInt(expiry) - Date.now();
                    if (remaining > 0) {
                        return Math.round(remaining / (60 * 60 * 1000) * 10) / 10; // å°æ™‚
                    }
                }
            } catch (e) {}
            return 0;
        }

        // ğŸ”‘ Google æˆæ¬ŠæŒ‰éˆ•é»æ“Š
        function handleGoogleAuth() {
            var clientId = document.getElementById('googleClientId').value.trim();
            
            if (!clientId) {
                showToast('âš ï¸ è«‹å…ˆè¼¸å…¥ Google OAuth Client ID', 'error');
                return;
            }

            // ç¢ºä¿ tokenClient å·²åˆå§‹åŒ–
            if (!tokenClient) {
                initTokenClient(clientId);
            }

            if (!tokenClient) {
                showToast('âŒ Google æˆæ¬Šæœå‹™æœªå°±ç·’ï¼Œè«‹é‡æ–°æ•´ç†é é¢', 'error');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å¿«å– token
            if (accessToken && isCachedTokenValid()) {
                var remaining = getCachedTokenRemainingTime();
                showToast('âœ… æˆæ¬Šä»æœ‰æ•ˆï¼ˆå‰©é¤˜ ' + remaining + ' å°æ™‚ï¼‰', 'success');
                return;
            }

            showToast('ğŸ” æ­£åœ¨é–‹å•Ÿ Google æˆæ¬Š...', 'info');

            tokenClient.callback = function(response) {
                if (response.error !== undefined) {
                    showToast('âŒ æˆæ¬Šå¤±æ•—: ' + response.error, 'error');
                    console.error('Google æˆæ¬ŠéŒ¯èª¤:', response);
                    return;
                }

                // å–å¾— token
                var token = gapi.client.getToken();
                if (token && token.access_token) {
                    accessToken = token.access_token;
                    
                    // å¿«å– tokenï¼ˆ24 å°æ™‚ï¼‰
                    saveCachedToken(accessToken);
                    
                    showToast('âœ… Google æ—¥æ›†æˆæ¬ŠæˆåŠŸï¼ï¼ˆ24å°æ™‚æœ‰æ•ˆï¼‰', 'success');
                    updateAuthButtonStatus(true);
                }
            };

            // è«‹æ±‚æˆæ¬Š
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({ prompt: 'consent' });
            } else {
                tokenClient.requestAccessToken({ prompt: '' });
            }
        }

        function updateAuthButtonStatus(authorized, remainingHours) {
            var authBtn = document.getElementById('googleAuthBtn');
            var authStatus = document.getElementById('googleAuthStatus');
            
            if (authorized) {
                if (authBtn) {
                    authBtn.innerHTML = 'âœ… å·²æˆæ¬Š';
                    authBtn.classList.add('authorized');
                }
                if (authStatus) {
                    var hours = remainingHours || getCachedTokenRemainingTime();
                    authStatus.innerHTML = 'âœ… å·²æˆæ¬Šï¼ˆå‰©é¤˜ ' + hours + ' å°æ™‚ï¼‰';
                    authStatus.style.color = 'var(--emerald)';
                }
            } else {
                if (authBtn) {
                    authBtn.innerHTML = 'ğŸ”‘ æˆæ¬Š Google';
                    authBtn.classList.remove('authorized');
                }
                if (authStatus) {
                    authStatus.innerHTML = 'âŒ æœªæˆæ¬Š';
                    authStatus.style.color = 'var(--red)';
                }
            }
        }

        // ç™»å‡º / æ¸…é™¤æˆæ¬Š
        function handleGoogleSignOut() {
            if (accessToken && typeof google !== 'undefined' && google.accounts) {
                google.accounts.oauth2.revoke(accessToken, function() {
                    console.log('ğŸšª å·²æ’¤éŠ· Google æˆæ¬Š');
                });
            }
            
            // æ¸…é™¤ gapi token
            if (typeof gapi !== 'undefined' && gapi.client) {
                gapi.client.setToken(null);
            }
            
            // æ¸…é™¤å¿«å–
            clearCachedToken();
            
            updateAuthButtonStatus(false);
            showToast('âœ… å·²ç™»å‡º Google å¸³è™Ÿ', 'success');
        }

        // ğŸ” API è¨ºæ–·å‡½æ•¸
        function showApiDiagnostics() {
            var info = [];
            info.push('â•â•â• API è¨ºæ–·å ±å‘Š â•â•â•');
            info.push('');
            info.push('ğŸ“ é–‹å•Ÿæ–¹å¼:');
            info.push('   URL: ' + window.location.href.substring(0, 50) + '...');
            info.push('   å”å®š: ' + window.location.protocol);
            info.push('');
            info.push('ğŸ“¦ Google API ç‹€æ…‹:');
            info.push('   gapi: ' + (typeof gapi !== 'undefined' ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'));
            info.push('   gapi.client: ' + (typeof gapi !== 'undefined' && gapi.client ? 'âœ… å·²åˆå§‹åŒ–' : 'âŒ æœªåˆå§‹åŒ–'));
            info.push('   gapi.client.calendar: ' + (typeof gapi !== 'undefined' && gapi.client && gapi.client.calendar ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥'));
            info.push('   gapiInited: ' + (gapiInited ? 'âœ…' : 'âŒ'));
            info.push('   gisInited: ' + (gisInited ? 'âœ…' : 'âŒ'));
            info.push('');
            info.push('ğŸ” æˆæ¬Šç‹€æ…‹:');
            info.push('   accessToken: ' + (accessToken ? 'âœ… æœ‰ (' + accessToken.substring(0,10) + '...)' : 'âŒ ç„¡'));
            info.push('   Token æœ‰æ•ˆ: ' + (isCachedTokenValid() ? 'âœ… æ˜¯' : 'âŒ å¦'));
            info.push('   å‰©é¤˜æ™‚é–“: ' + getCachedTokenRemainingTime() + ' å°æ™‚');
            info.push('');
            info.push('âš™ï¸ è¨­å®šç‹€æ…‹:');
            info.push('   Client ID: ' + (document.getElementById('googleClientId').value ? 'âœ… å·²å¡«å¯«' : 'âŒ æœªå¡«å¯«'));
            info.push('');
            
            if (window.location.protocol === 'file:') {
                info.push('âš ï¸ è­¦å‘Š: ä½¿ç”¨ file:// å”å®šé–‹å•Ÿ');
                info.push('   Google API ç„¡æ³•åœ¨æœ¬æ©Ÿæª”æ¡ˆä¸­æ­£å¸¸é‹ä½œ');
                info.push('   è«‹ä½¿ç”¨ https:// ç¶²å€é–‹å•Ÿ');
            }
            
            var report = info.join('\n');
            console.log(report);
            alert(report);
        }

        // ========================================
        // åŒ¯å…¥äº‹ä»¶åˆ° Google æ—¥æ›†
        // ========================================
        async function importToGoogleCalendar() {
            // ğŸ”§ è¨ºæ–·æ¨¡å¼ï¼šé¡¯ç¤ºè©³ç´°ç‹€æ…‹
            var debugInfo = [];
            debugInfo.push('=== åŒ¯å…¥è¨ºæ–· ===');
            debugInfo.push('æ™‚é–“: ' + new Date().toLocaleString('zh-TW'));
            debugInfo.push('äº‹ä»¶æ•¸é‡: ' + parsedEvents.length);
            debugInfo.push('gapi å­˜åœ¨: ' + (typeof gapi !== 'undefined'));
            debugInfo.push('gapi.client å­˜åœ¨: ' + (typeof gapi !== 'undefined' && !!gapi.client));
            debugInfo.push('gapi.client.calendar å­˜åœ¨: ' + (typeof gapi !== 'undefined' && gapi.client && !!gapi.client.calendar));
            debugInfo.push('accessToken å­˜åœ¨: ' + !!accessToken);
            debugInfo.push('Token æœ‰æ•ˆ: ' + isCachedTokenValid());
            console.log(debugInfo.join('\n'));
            
            if (parsedEvents.length === 0) {
                showToast('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„äº‹ä»¶', 'error');
                return;
            }

            // æª¢æŸ¥æˆæ¬Š
            if (!accessToken || !isCachedTokenValid()) {
                showToast('âš ï¸ è«‹å…ˆæˆæ¬Š Google æ—¥æ›†', 'error');
                alert('âŒ æˆæ¬Šå•é¡Œ\n\naccessToken: ' + (accessToken ? 'æœ‰' : 'ç„¡') + '\nTokenæœ‰æ•ˆ: ' + isCachedTokenValid());
                return;
            }

            // ğŸ”§ æª¢æŸ¥ gapi ç‹€æ…‹
            if (typeof gapi === 'undefined') {
                showToast('âŒ Google API æœªè¼‰å…¥', 'error');
                alert('âŒ gapi æœªå®šç¾©\n\nè«‹ç¢ºèªï¼š\n1. ç¶²è·¯é€£ç·šæ­£å¸¸\n2. ä½¿ç”¨ https:// ç¶²å€é–‹å•Ÿ\n3. ä¸æ˜¯ç›´æ¥é–‹å•Ÿ HTML æª”æ¡ˆ');
                return;
            }
            
            if (!gapi.client) {
                showToast('âŒ Google API Client æœªåˆå§‹åŒ–', 'error');
                alert('âŒ gapi.client æœªå®šç¾©\n\nè«‹é‡æ–°æ•´ç†é é¢');
                return;
            }

            // ç¢ºä¿ gapi client æœ‰ token
            gapi.client.setToken({ access_token: accessToken });

            // ğŸ”§ æª¢æŸ¥ä¸¦è¼‰å…¥ Calendar API
            if (!gapi.client.calendar) {
                showToast('ğŸ”„ æ­£åœ¨è¼‰å…¥ Calendar API...', 'info');
                console.log('âš ï¸ gapi.client.calendar æœªå®šç¾©ï¼Œå˜—è©¦è¼‰å…¥...');
                
                try {
                    await gapi.client.load('calendar', 'v3');
                    console.log('âœ… Calendar API è¼‰å…¥æˆåŠŸ');
                    showToast('âœ… Calendar API å·²è¼‰å…¥', 'success');
                } catch (loadError) {
                    console.error('âŒ Calendar API è¼‰å…¥å¤±æ•—:', loadError);
                    showToast('âŒ Calendar API è¼‰å…¥å¤±æ•—', 'error');
                    alert('âŒ Calendar API è¼‰å…¥å¤±æ•—\n\néŒ¯èª¤: ' + (loadError.message || JSON.stringify(loadError)) + '\n\nå¯èƒ½åŸå› ï¼š\n1. ç¶²è·¯å•é¡Œ\n2. API æœªå•Ÿç”¨\n3. ä½¿ç”¨ file:// é–‹å•Ÿ');
                    return;
                }
            }

            // å†æ¬¡ç¢ºèª
            if (!gapi.client.calendar || !gapi.client.calendar.events) {
                showToast('âŒ Calendar API ç„¡æ³•ä½¿ç”¨', 'error');
                alert('âŒ Calendar API ç„¡æ³•ä½¿ç”¨\n\ngapi.client.calendar: ' + !!gapi.client.calendar + '\ngapi.client.calendar.events: ' + (gapi.client.calendar && !!gapi.client.calendar.events));
                return;
            }

            showToast('ğŸ“¤ æ­£åœ¨åŒ¯å…¥åˆ° Google æ—¥æ›†...', 'info');

            var successCount = 0;
            var failCount = 0;
            var reminders = [];
            
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(input) {
                reminders.push(parseInt(input.value));
            });

            for (var i = 0; i < parsedEvents.length; i++) {
                var event = parsedEvents[i];
                
                try {
                    var calendarEvent = {
                        summary: event.title,
                        location: event.location || '',
                        description: event.description || '',
                        start: {
                            dateTime: event.startDateTime,
                            timeZone: 'Asia/Taipei'
                        },
                        end: {
                            dateTime: event.endDateTime,
                            timeZone: 'Asia/Taipei'
                        },
                        reminders: {
                            useDefault: false,
                            overrides: reminders.map(function(mins) {
                                return { method: 'popup', minutes: mins };
                            })
                        }
                    };

                    await gapi.client.calendar.events.insert({
                        calendarId: 'primary',
                        resource: calendarEvent
                    });
                    
                    successCount++;
                    console.log('âœ… å·²åŒ¯å…¥:', event.title);
                } catch (error) {
                    failCount++;
                    console.error('âŒ åŒ¯å…¥å¤±æ•—:', event.title, error);
                    
                    // ğŸ”§ è©³ç´°éŒ¯èª¤åˆ†æ
                    var errorCode = error.status || (error.result && error.result.error && error.result.error.code) || 0;
                    var errorMsg = 'æœªçŸ¥éŒ¯èª¤';
                    var errorDetails = '';
                    
                    if (error.result && error.result.error) {
                        errorMsg = error.result.error.message || error.result.error.status || 'æœªçŸ¥';
                        errorDetails = JSON.stringify(error.result.error, null, 2);
                    } else if (error.message) {
                        errorMsg = error.message;
                        errorDetails = error.stack || '';
                    } else if (typeof error === 'string') {
                        errorMsg = error;
                    } else {
                        try {
                            errorDetails = JSON.stringify(error, null, 2);
                        } catch (e) {
                            errorDetails = error.toString();
                        }
                    }
                    
                    console.error('éŒ¯èª¤ä»£ç¢¼:', errorCode);
                    console.error('éŒ¯èª¤è¨Šæ¯:', errorMsg);
                    console.error('éŒ¯èª¤è©³æƒ…:', errorDetails);
                    
                    // ç¬¬ä¸€æ¬¡å¤±æ•—æ™‚é¡¯ç¤ºè©³ç´°éŒ¯èª¤
                    if (failCount === 1) {
                        var alertMsg = 'âŒ åŒ¯å…¥å¤±æ•—\n\n';
                        alertMsg += 'äº‹ä»¶: ' + event.title + '\n';
                        alertMsg += 'éŒ¯èª¤ä»£ç¢¼: ' + errorCode + '\n';
                        alertMsg += 'éŒ¯èª¤è¨Šæ¯: ' + errorMsg + '\n\n';
                        
                        if (errorCode === 401) {
                            alertMsg += 'ğŸ’¡ è§£æ±ºæ–¹å¼: æˆæ¬Šå·²éæœŸï¼Œè«‹é‡æ–°æˆæ¬Š';
                        } else if (errorCode === 403) {
                            alertMsg += 'ğŸ’¡ è§£æ±ºæ–¹å¼:\n1. å‰å¾€ Google Cloud Console\n2. å•Ÿç”¨ Google Calendar API\n3. æª¢æŸ¥ OAuth åŒæ„ç•«é¢è¨­å®š';
                        } else if (errorCode === 404) {
                            alertMsg += 'ğŸ’¡ è§£æ±ºæ–¹å¼: æ—¥æ›†ä¸å­˜åœ¨æˆ–ç„¡æ¬Šé™å­˜å–';
                        } else {
                            alertMsg += 'ğŸ’¡ è«‹æª¢æŸ¥:\n1. ç¶²è·¯é€£ç·š\n2. æ˜¯å¦ä½¿ç”¨ https:// ç¶²å€\n3. Google Cloud Console è¨­å®š';
                        }
                        
                        alert(alertMsg);
                        showToast('âŒ åŒ¯å…¥å¤±æ•—: ' + errorMsg, 'error');
                    }
                    
                    // å¦‚æœæ˜¯æˆæ¬ŠéŒ¯èª¤ï¼Œå˜—è©¦é‡æ–°æˆæ¬Š
                    if (errorCode === 401) {
                        clearCachedToken();
                        updateAuthButtonStatus(false);
                        return;
                    }
                    
                    // 403 éŒ¯èª¤ç›´æ¥åœæ­¢
                    if (errorCode === 403) {
                        return;
                    }
                }
            }

            if (successCount > 0) {
                showToast('âœ… æˆåŠŸåŒ¯å…¥ ' + successCount + ' å€‹äº‹ä»¶åˆ° Google æ—¥æ›†ï¼', 'success');
                
                // åŒæ™‚å»ºç«‹ LINE æ’ç¨‹
                var hasLineSettings = document.getElementById('lineChannelAccessToken').value.trim() &&
                                      document.getElementById('lineUserId').value.trim() &&
                                      document.getElementById('gasWebAppUrl').value.trim() &&
                                      document.getElementById('gasSecretKey').value.trim();
                
                if (hasLineSettings && getSelectedLineReminders().length > 0) {
                    setTimeout(function() {
                        createReminderSchedules(parsedEvents);
                    }, 500);
                }
                
                // âœ… åŒ¯å…¥æˆåŠŸå¾Œæ¸…é™¤å¾…è™•ç†äº‹ä»¶
                setTimeout(function() {
                    parsedEvents = [];
                    document.getElementById('eventCount').textContent = '0';
                    
                    // æ¸…é™¤è¼¸å…¥é çš„äº‹ä»¶é è¦½
                    var eventsPreview = document.getElementById('eventsPreview');
                    if (eventsPreview) {
                        eventsPreview.innerHTML = '';
                        eventsPreview.style.display = 'none';
                    }
                    
                    // æ¸…é™¤é¦–é çš„äº‹ä»¶åˆ—è¡¨
                    var homeEventList = document.getElementById('homeEventList');
                    if (homeEventList) {
                        homeEventList.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
                    }
                    
                    // éš±è—åŒ¯å…¥æŒ‰éˆ•
                    var importActions = document.getElementById('importActions');
                    if (importActions) {
                        importActions.style.display = 'none';
                    }
                }, 1500);
            }
            
            if (failCount > 0) {
                showToast('âš ï¸ ' + failCount + ' å€‹äº‹ä»¶åŒ¯å…¥å¤±æ•—', 'error');
            }
        }

        // ========================================
        // LINE åŠŸèƒ½
        // ========================================
        function updateLineStatus() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            updateStatus('token', token);
            updateStatus('userId', userId);
            updateStatus('gas', gasUrl);
            updateStatus('secret', gasSecret);
        }

        function updateStatus(name, value) {
            var statusEl = document.getElementById(name + 'Status');
            var iconEl = document.getElementById(name + 'Icon');
            
            if (value) {
                statusEl.textContent = 'å·²è¨­å®š (' + value.substring(0, 8) + '...)';
                iconEl.textContent = 'âœ…';
            } else {
                statusEl.textContent = 'æœªè¨­å®š';
                iconEl.textContent = 'âŒ';
            }
        }

        function testLineNotification() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            if (!token || !userId || !gasUrl || !gasSecret) {
                showToast('âš ï¸ è«‹å…ˆå¡«å¯«å®Œæ•´çš„ LINE è¨­å®š', 'error');
                return;
            }

            showToast('ğŸ“¨ æ­£åœ¨ç™¼é€æ¸¬è©¦è¨Šæ¯...', 'info');

            var tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9, 0, 0, 0);

            var testData = {
                secret: gasSecret,
                token: token,
                userId: userId,
                workshops: [{
                    title: 'ğŸ“š æ¸¬è©¦ç ”ç¿’ - åŠŸèƒ½æ¸¬è©¦',
                    startDateTime: tomorrow.toISOString(),
                    endDateTime: new Date(tomorrow.getTime() + 3 * 60 * 60 * 1000).toISOString(),
                    location: 'æ¸¬è©¦åœ°é»',
                    description: 'é€™æ˜¯ä¸€å‰‡æ¸¬è©¦é€šçŸ¥'
                }]
            };

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify(testData)
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    showToast('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼è«‹æŸ¥çœ‹ LINE', 'success');
                } else {
                    showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(function(error) {
                showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + error.message, 'error');
            });
        }

        function viewScheduledReminders() {
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            if (!gasUrl || !gasSecret) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL å’Œ Secret Key', 'error');
                return;
            }

            showToast('ğŸ“‹ æ­£åœ¨æŸ¥è©¢æ’ç¨‹...', 'info');

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'getSchedules',
                    secret: gasSecret
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    var schedules = result.schedules || [];
                    if (schedules.length === 0) {
                        showToast('ğŸ“­ ç›®å‰æ²’æœ‰æ’ç¨‹', 'info');
                        alert('ğŸ“­ ç›®å‰æ²’æœ‰æ’ç¨‹');
                    } else {
                        var pending = schedules.filter(function(s) { return s.status === 'pending'; });
                        var sent = schedules.filter(function(s) { return s.status === 'sent'; });
                        
                        var msg = 'ğŸ“‹ æ’ç¨‹æ¸…å–®\n';
                        msg += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
                        msg += 'â³ å¾…ç™¼é€: ' + pending.length + ' ç­†\n';
                        msg += 'âœ… å·²ç™¼é€: ' + sent.length + ' ç­†\n';
                        msg += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
                        
                        pending.slice(0, 10).forEach(function(s, i) {
                            var reminderTime = new Date(s.reminderTime);
                            msg += (i + 1) + '. ' + s.workshopTitle + '\n';
                            msg += '   ğŸ”” ' + s.reminderLabel + '\n';
                            msg += '   â° ' + reminderTime.toLocaleString('zh-TW') + '\n\n';
                        });
                        
                        if (pending.length > 10) {
                            msg += '... é‚„æœ‰ ' + (pending.length - 10) + ' ç­†\n';
                        }
                        
                        showToast('âœ… æŸ¥è©¢æˆåŠŸï¼š' + schedules.length + ' ç­†æ’ç¨‹', 'success');
                        alert(msg);
                    }
                } else {
                    showToast('âŒ æŸ¥è©¢å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(function(error) {
                showToast('âŒ æŸ¥è©¢å¤±æ•—ï¼š' + error.message, 'error');
            });
        }

        function clearAllReminders() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’ç¨‹å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
            
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            if (!gasUrl || !gasSecret) {
                showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS URL å’Œ Secret Key', 'error');
                return;
            }

            showToast('ğŸ—‘ï¸ æ­£åœ¨æ¸…é™¤æ’ç¨‹...', 'info');

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'clearSchedules',
                    secret: gasSecret
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    showToast('âœ… å·²æ¸…é™¤æ‰€æœ‰æ’ç¨‹', 'success');
                } else {
                    showToast('âŒ æ¸…é™¤å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                }
            })
            .catch(function(error) {
                showToast('âŒ æ¸…é™¤å¤±æ•—ï¼š' + error.message, 'error');
            });
        }

        // ========================================
        // å»ºç«‹ LINE æé†’æ’ç¨‹åˆ° Google Sheet
        // ========================================
        function createReminderSchedules(workshops) {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();

            if (!token || !userId || !gasUrl || !gasSecret) {
                console.log('âš ï¸ LINE è¨­å®šä¸å®Œæ•´ï¼Œè·³éå»ºç«‹æ’ç¨‹');
                return;
            }

            var reminderMinutes = getSelectedLineReminders();
            if (reminderMinutes.length === 0) {
                console.log('â„¹ï¸ æœªå‹¾é¸ä»»ä½•æé†’æ™‚é–“ï¼Œè·³éå»ºç«‹æ’ç¨‹');
                return;
            }

            console.log('ğŸ”” æ­£åœ¨å»ºç«‹æé†’æ’ç¨‹...');
            console.log('   æé†’æ™‚é–“:', reminderMinutes);
            console.log('   ç ”ç¿’æ•¸é‡:', workshops.length);

            var schedules = [];
            workshops.forEach(function(workshop) {
                var startTime = new Date(workshop.startDateTime);
                
                // ğŸ†• æå– Meet é€£çµ
                var meetLink = '';
                var locationStr = workshop.location || '';
                var descStr = workshop.description || '';
                
                console.log('ğŸ“ åœ°é»:', locationStr);
                console.log('ğŸ“ æè¿°:', descStr);
                
                // åˆä½µæ‰€æœ‰æ–‡å­—æœå°‹
                var allText = locationStr + ' ' + descStr;
                
                // åŒ¹é…å®Œæ•´çš„ Meet é€£çµ
                var meetMatch = allText.match(/https?:\/\/meet\.google\.com\/[a-z\-]+/i);
                if (meetMatch) {
                    meetLink = meetMatch[0];
                } else {
                    // å˜—è©¦åŒ¹é… meet.google.com/xxx-xxxx-xxx æ ¼å¼
                    meetMatch = allText.match(/meet\.google\.com\/([a-z]{3}-[a-z]{4}-[a-z]{3})/i);
                    if (meetMatch) {
                        meetLink = 'https://meet.google.com/' + meetMatch[1];
                    }
                }
                
                console.log('ğŸ¥ æå–çš„ Meet é€£çµ:', meetLink || 'ç„¡');
                
                reminderMinutes.forEach(function(mins) {
                    var reminderTime = new Date(startTime.getTime() - mins * 60 * 1000);
                    
                    // åªå»ºç«‹æœªä¾†çš„æé†’
                    if (reminderTime > new Date()) {
                        var scheduleData = {
                            workshopTitle: workshop.title,
                            workshopStart: workshop.startDateTime,
                            workshopEnd: workshop.endDateTime,
                            workshopLocation: locationStr,
                            meetLink: meetLink,
                            workshopDescription: descStr,
                            reminderTime: reminderTime.toISOString(),
                            reminderMinutes: mins,
                            reminderLabel: getReminderLabel(mins),
                            status: 'pending'
                        };
                        console.log('ğŸ“¤ æ’ç¨‹è³‡æ–™:', JSON.stringify(scheduleData));
                        schedules.push(scheduleData);
                    }
                });
            });

            if (schedules.length === 0) {
                console.log('â„¹ï¸ æ²’æœ‰éœ€è¦å»ºç«‹çš„æœªä¾†æé†’');
                return;
            }

            console.log('ğŸ“¤ ç™¼é€æ’ç¨‹åˆ° GASï¼Œå…± ' + schedules.length + ' ç­†');

            fetch(gasUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    action: 'createSchedules',
                    secret: gasSecret,
                    token: token,
                    userId: userId,
                    schedules: schedules
                })
            })
            .then(function(response) { return response.json(); })
            .then(function(result) {
                if (result.success) {
                    showToast('âœ… å·²å»ºç«‹ ' + (result.count || schedules.length) + ' å€‹æé†’æ’ç¨‹', 'success');
                    console.log('âœ… æ’ç¨‹å»ºç«‹æˆåŠŸ:', result);
                } else {
                    showToast('âš ï¸ æ’ç¨‹å»ºç«‹å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥'), 'error');
                    console.error('âŒ æ’ç¨‹å»ºç«‹å¤±æ•—:', result);
                }
            })
            .catch(function(error) {
                showToast('âš ï¸ æ’ç¨‹å»ºç«‹å¤±æ•—ï¼š' + error.message, 'error');
                console.error('âŒ æ’ç¨‹å»ºç«‹éŒ¯èª¤:', error);
            });
        }

        function getSelectedLineReminders() {
            var reminders = [];
            document.querySelectorAll('#lineReminderGrid input[type="checkbox"]').forEach(function(cb) {
                if (cb.checked) {
                    reminders.push(parseInt(cb.value));
                }
            });
            return reminders;
        }

        function getReminderLabel(minutes) {
            if (minutes >= 1440) return 'å‰ ' + Math.floor(minutes / 1440) + ' å¤©';
            if (minutes >= 60) return 'å‰ ' + Math.floor(minutes / 60) + ' å°æ™‚';
            return 'å‰ ' + minutes + ' åˆ†é˜';
        }

        // ========================================
        // æœ¬æ©Ÿå„²å­˜
        // ========================================
        function toggleLocalStorage() {
            var toggle = document.getElementById('localStorageToggle');
            
            if (toggle.classList.contains('active')) {
                if (confirm('ç¢ºå®šè¦åœç”¨æœ¬æ©Ÿå„²å­˜å—ï¼Ÿ')) {
                    toggle.classList.remove('active');
                    localStorageEnabled = false;
                    localStorage.removeItem(STORAGE_PREFIX + 'enabled');
                    showToast('âœ… å·²åœç”¨æœ¬æ©Ÿå„²å­˜', 'success');
                }
            } else {
                if (confirm('âš ï¸ å•Ÿç”¨å¾Œè¨­å®šæœƒå­˜åœ¨æœ¬æ©Ÿï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    toggle.classList.add('active');
                    localStorageEnabled = true;
                    localStorage.setItem(STORAGE_PREFIX + 'enabled', 'true');
                    saveSettings();
                    showToast('âœ… å·²å•Ÿç”¨æœ¬æ©Ÿå„²å­˜', 'success');
                }
            }
        }

        function saveSettings() {
            if (!localStorageEnabled) return;
            
            try {
                localStorage.setItem(STORAGE_PREFIX + 'geminiApiKey', document.getElementById('geminiApiKey').value);
                localStorage.setItem(STORAGE_PREFIX + 'googleClientId', document.getElementById('googleClientId').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineToken', document.getElementById('lineChannelAccessToken').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineUserId', document.getElementById('lineUserId').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasUrl', document.getElementById('gasWebAppUrl').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasSecret', document.getElementById('gasSecretKey').value);
            } catch (e) {
                console.error('å„²å­˜å¤±æ•—:', e);
            }
        }

        function loadSettings() {
            try {
                if (localStorage.getItem(STORAGE_PREFIX + 'enabled') === 'true') {
                    localStorageEnabled = true;
                    document.getElementById('localStorageToggle').classList.add('active');
                    
                    var geminiKey = localStorage.getItem(STORAGE_PREFIX + 'geminiApiKey');
                    var googleId = localStorage.getItem(STORAGE_PREFIX + 'googleClientId');
                    var lineToken = localStorage.getItem(STORAGE_PREFIX + 'lineToken');
                    var lineUserId = localStorage.getItem(STORAGE_PREFIX + 'lineUserId');
                    var gasUrl = localStorage.getItem(STORAGE_PREFIX + 'gasUrl');
                    var gasSecret = localStorage.getItem(STORAGE_PREFIX + 'gasSecret');

                    if (geminiKey) document.getElementById('geminiApiKey').value = geminiKey;
                    if (googleId) document.getElementById('googleClientId').value = googleId;
                    if (lineToken) document.getElementById('lineChannelAccessToken').value = lineToken;
                    if (lineUserId) document.getElementById('lineUserId').value = lineUserId;
                    if (gasUrl) document.getElementById('gasWebAppUrl').value = gasUrl;
                    if (gasSecret) document.getElementById('gasSecretKey').value = gasSecret;

                    console.log('âœ… å·²è¼‰å…¥å„²å­˜çš„è¨­å®š');
                    
                    // åˆå§‹åŒ– Google Token Clientï¼ˆå¦‚æœæœ‰ Client IDï¼‰
                    if (googleId) {
                        setTimeout(function() {
                            if (typeof google !== 'undefined' && google.accounts) {
                                initTokenClient(googleId);
                            }
                        }, 1000);
                    }
                }
                
                // æª¢æŸ¥ä¸¦æ¢å¾©å¿«å–çš„ Google Tokenï¼ˆç„¡è«–æ˜¯å¦å•Ÿç”¨ localStorageï¼‰
                setTimeout(function() {
                    if (restoreCachedToken()) {
                        console.log('ğŸ” å·²æ¢å¾© Google æˆæ¬Šç‹€æ…‹');
                    }
                }, 1500);
                
            } catch (e) {
                console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
            }
        }

        // ğŸ—‘ï¸ æ¸…é™¤æ–‡å­—è¼¸å…¥
        function clearScheduleText() {
            var textarea = document.getElementById('scheduleText');
            if (textarea.value.trim()) {
                if (confirm('ç¢ºå®šè¦æ¸…é™¤è¼¸å…¥çš„æ–‡å­—å—ï¼Ÿ')) {
                    textarea.value = '';
                    showToast('âœ… å·²æ¸…é™¤æ–‡å­—', 'success');
                }
            } else {
                showToast('ğŸ“ è¼¸å…¥å€å·²ç¶“æ˜¯ç©ºçš„', 'info');
            }
        }

        function clearAllData() {
            if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) return;

            try {
                Object.keys(localStorage).forEach(function(key) {
                    if (key.startsWith(STORAGE_PREFIX)) {
                        localStorage.removeItem(key);
                    }
                });
            } catch (e) {}

            document.getElementById('geminiApiKey').value = '';
            document.getElementById('googleClientId').value = '';
            document.getElementById('lineChannelAccessToken').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('gasWebAppUrl').value = '';
            document.getElementById('gasSecretKey').value = '';
            document.getElementById('scheduleText').value = '';
            document.getElementById('localStorageToggle').classList.remove('active');
            localStorageEnabled = false;
            parsedEvents = [];
            uploadedFilesContentArray = [];
            uploadedImagesArray = [];
            document.getElementById('eventsPreview').innerHTML = '';
            document.getElementById('eventsPreview').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('fileCount').textContent = '0';

            showToast('âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤', 'success');
        }

        // è‡ªå‹•å„²å­˜è¨­å®š
        document.querySelectorAll('.input-field').forEach(function(input) {
            input.addEventListener('change', function() {
                if (localStorageEnabled) {
                    saveSettings();
                }
            });
        });

        // ========================================
        // ğŸŒŸ é–‹æ©Ÿå‹•ç•«æ§åˆ¶
        // ========================================
        (function() {
            var splash = document.getElementById('splashScreen');
            var minDisplayTime = 3800; // ç¢ºä¿å‹•ç•«å®Œæ•´é¡¯ç¤º
            var startTime = Date.now();
            
            function hideSplash() {
                var elapsed = Date.now() - startTime;
                var remaining = Math.max(0, minDisplayTime - elapsed);
                
                setTimeout(function() {
                    splash.classList.add('hide');
                    setTimeout(function() {
                        splash.style.display = 'none';
                    }, 800);
                }, remaining);
            }
            
            if (document.readyState === 'complete') {
                hideSplash();
            } else {
                window.addEventListener('load', hideSplash);
            }
        })();
    </script>
</body>
</html>
